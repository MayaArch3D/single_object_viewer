var GIScene={VERSION:"1.0.3",LIBRARYPATH:null,WORKINGMATERIALFLAGS:{SELECT:1,WIRE:2,SHADING:4,SIDE:8,MAP:16,OPACITY:32,VERTEXCOLORS:64,DIFFUSE:128,AMBIENT:256},idCounter:0},scripts=document.getElementsByTagName("script");GIScene.LIBRARYPATH=scripts[scripts.length-1].src.replace(/\/GIScene\.js$/,"/"),GIScene.LIBRARYPATH=GIScene.LIBRARYPATH.replace(/\/GIScene_.*\.js$/,"/"),GIScene.RESOURCESPATH="",THREE.CTMLoader=function(e){THREE.Loader.call(this,e)},THREE.CTMLoader.prototype=Object.create(THREE.Loader.prototype),THREE.CTMLoader.prototype.loadParts=function(e,s,c){var l=this,h=new XMLHttpRequest,d=c.basePath||this.extractUrlBase(e);h.onreadystatechange=function(){if(4===h.readyState&&(200===h.status||0===h.status)){var t=JSON.parse(h.responseText),i=[],n=[],r=0;for(var e=0;e<t.materials.length;e++)i[e]=THREE.Loader.prototype.createMaterial(t.materials[e],d);var o=d+t.data,a={useWorker:c.useWorker,useBuffers:c.useBuffers,offsets:t.offsets};l.load(o,function(e){r+=1,n.push(e),r===t.offsets.length&&s(n,i)},a)}},h.open("GET",e,!0),h.setRequestHeader("Content-Type","text/plain"),h.send(null)},THREE.CTMLoader.prototype.load=function(r,a,s){var c=this,l=void 0!==s.offsets?s.offsets:[0],h=void 0===s.useBuffers||s.useBuffers,d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState)if(200===d.status||0===d.status){var e=new Uint8Array(d.response),o=Date.now();if(s.useWorker){var t=new Worker(window.URL.createObjectURL(new Blob([THREE.CTMLoader.workerString],{type:"text/javascript"})));t.onmessage=function(e){for(var t=e.data,i=0;i<t.length;i++){var n=t[i],r=Date.now();h?c.createModelBuffers(n,a):c.createModelClassic(n,a);n=Date.now();console.log("model load time [worker]: "+(n-r)+" ms, total: "+(n-o))}},t.postMessage({data:e,offsets:l})}else for(var i=0;i<l.length;i++){var n=new CTM.Stream(e);n.offset=l[i];n=new CTM.File(n);h?c.createModelBuffers(n,a):c.createModelClassic(n,a)}}else console.error("Couldn't load ["+r+"] ["+d.status+"]");else 3===d.readyState||2===d.readyState&&d.getResponseHeader("Content-Length")},d.open("GET",r,!0),d.responseType="arraybuffer",d.send(null)},THREE.CTMLoader.prototype.createModelBuffers=function(W,e){var t=function(){var e=this;e.materials=[],THREE.BufferGeometry.call(this);Date.now();var t,i,n=W.body.indices,r=W.body.vertices,o=W.body.normals;function a(e,t){return void 0===t[e]&&(t[e]=h,l[h]=e,h+=1),t[e]}void 0!==W.body.uvMaps&&0<W.body.uvMaps.length&&(t=W.body.uvMaps[0].uv),void 0!==W.body.attrMaps&&0<W.body.attrMaps.length&&"Color"===W.body.attrMaps[0].name&&(i=W.body.attrMaps[0].attr);for(var s=new Uint32Array(n.length),c={},l={},h=0,d=0,u=Math.ceil(n.length/3e3),m=new Uint32Array(u),f=0;f<n.length;f+=3){var p,v=n[f],g=n[f+1],E=n[f+2];a(v,c),a(g,c),a(E,c),65535<Math.abs(c[v]-c[g])||65535<Math.abs(c[g]-c[E])||65535<Math.abs(c[E]-c[v])?(u<=d&&(console.warn("reached sprawled faces limit: "+d),u*=2,(p=new Uint32Array(u)).set(m),m=p),m[d]=f,d+=1):(s[f]=c[v],s[f+1]=c[g],s[f+2]=c[E])}for(var y={},S=0;S<d;S++)for(var f=m[S],b=0;b<3;b++){var T=n[f+b];s[f+b]=a(T,y)}var w,R,M,I=new Float32Array(3*h);o&&(w=new Float32Array(3*h)),t&&(R=new Float32Array(2*h)),i&&(M=new Float32Array(4*h));for(var L,A,x,C,D,H,G,O,P=0;P<h;P++)L=l[P],O=G=H=D=C=x=void 0,C=(x=3*L)+1,D=3*L+2,G=(H=3*(A=P))+1,O=3*A+2,I[H]=r[x],I[G]=r[C],I[O]=r[D],o&&(w[H]=o[x],w[G]=o[C],w[O]=o[D]),t&&(R[2*A]=t[2*L],R[2*A+1]=t[2*L+1]),i&&(M[4*A]=i[4*L],M[4*A+1]=i[4*L+1],M[4*A+2]=i[4*L+2],M[4*A+3]=i[4*L+3]);n=s,r=I,o=o&&w,t=t&&R,i=i&&M,e.offsets=[];for(var k=n,j=0,F=r.length,B=0,U=F,f=0;f<k.length;){for(b=0;b<3;++b){var z=k[f++];z<F&&(F=z),B<z&&(B=z)}if(65535<B-F){if(f-=3,0<U)for(var V=j;V<f;++V)k[V]-=U;e.offsets.push({start:j,count:f-j,index:U}),j=f,F=r.length,B=0}U=F}if(0<U)for(V=j;V<f;++V)k[V]-=U;e.offsets.push({start:j,count:f-j,index:U});var N=new Uint16Array(n),_=e.attributes;_.index={itemSize:1,array:N,numItems:N.length},_.position={itemSize:3,array:r,numItems:r.length},void 0!==o&&(_.normal={itemSize:3,array:o,numItems:o.length}),void 0!==t&&(_.uv={itemSize:2,array:t,numItems:t.length}),void 0!==i&&(_.color={itemSize:4,array:i,numItems:i.length})};t.prototype=Object.create(THREE.BufferGeometry.prototype);t=new t;void 0===t.attributes.normal&&t.computeVertexNormals(),e(t)},THREE.CTMLoader.prototype.createModelClassic=function(e,t){console.log(e.body);function i(){var l=this;l.materials=[],THREE.Geometry.call(this);var h=[],d=[],u=[];!function(e){var t,i,n,r,o=e.length;for(r=0;r<o;r+=3)t=e[r],i=e[r+1],n=e[r+2],l.vertices.push(new THREE.Vector3(t,i,n))}(e.body.vertices),void 0!==e.body.normals&&function(e){var t,i,n,r,o=e.length;for(r=0;r<o;r+=3)t=e[r],i=e[r+1],n=e[r+2],h.push(t,i,n)}(e.body.normals),void 0!==e.body.uvMaps&&0<e.body.uvMaps.length&&function(e){var t,i,n,r=e.length;for(n=0;n<r;n+=2)t=e[n],i=e[n+1],d.push(t,i)}(e.body.uvMaps[0].uv),void 0!==e.body.attrMaps&&0<e.body.attrMaps.length&&"Color"===e.body.attrMaps[0].name&&function(e){var t,i,n,r,o=e.length;for(r=0;r<o;r+=4){t=e[r],i=e[r+1],n=e[r+2],e[r+3];var a=new THREE.Color;a.setRGB(t,i,n),u.push(a)}}(e.body.attrMaps[0].attr);var m=0<h.length,f=0<d.length,p=0<u.length;!function(e){var a,s,t,i,n,r,o,c=e.length;for(o=0;o<c;o+=3)t=e[o],i=e[o+1],n=e[o+2],r=m?function(e,t,i,n,r,o,a,s,c){var l=t[3*a],h=t[3*a+1],d=t[3*a+2],u=t[3*s],m=t[3*s+1],f=t[3*s+2],a=t[3*c],s=t[3*c+1],c=t[3*c+2],d=new THREE.Vector3(l,h,d),f=new THREE.Vector3(u,m,f),c=new THREE.Vector3(a,s,c),o=new THREE.Face3(i,n,r,[d,f,c],null,o);return e.faces.push(o),o}(l,h,t,i,n,0,t,i,n):function(e,t,i,n,r){r=new THREE.Face3(t,i,n,null,null,r);return e.faces.push(r),r}(l,t,i,n,0),p&&(r.vertexColors[0]=u[t],r.vertexColors[1]=u[i],r.vertexColors[2]=u[n]),f&&(a=d[2*t],s=d[2*t+1],r=d[2*i],t=d[2*i+1],i=d[2*n],n=d[2*n+1],function(e,t,i,n,r){var o=[];o.push(new THREE.Vector2(a,s)),o.push(new THREE.Vector2(t,i)),o.push(new THREE.Vector2(n,r)),e.push(o)}(l.faceVertexUvs[0],r,t,i,n))}(e.body.indices),this.computeCentroids(),this.computeFaceNormals()}i.prototype=Object.create(THREE.Geometry.prototype),t(new i)},THREE.CTMLoader.workerString="var LZMA = LZMA || {};\nLZMA.OutWindow = function(){\n  this._windowSize = 0;\n};\nLZMA.OutWindow.prototype.create = function(windowSize){\n  if ( (!this._buffer) || (this._windowSize !== windowSize) ){\n    this._buffer = [];\n  }\n  this._windowSize = windowSize;\n  this._pos = 0;\n  this._streamPos = 0;\n};\nLZMA.OutWindow.prototype.flush = function(){\n  var size = this._pos - this._streamPos;\n  if (size !== 0){\n    while(size --){\n      this._stream.writeByte(this._buffer[this._streamPos ++]);\n    }\n    if (this._pos >= this._windowSize){\n      this._pos = 0;\n    }\n    this._streamPos = this._pos;\n  }\n};\nLZMA.OutWindow.prototype.releaseStream = function(){\n  this.flush();\n  this._stream = null;\n};\nLZMA.OutWindow.prototype.setStream = function(stream){\n  this.releaseStream();\n  this._stream = stream;\n};\nLZMA.OutWindow.prototype.init = function(solid){\n  if (!solid){\n    this._streamPos = 0;\n    this._pos = 0;\n  }\n};\nLZMA.OutWindow.prototype.copyBlock = function(distance, len){\n  var pos = this._pos - distance - 1;\n  if (pos < 0){\n    pos += this._windowSize;\n  }\n  while(len --){\n    if (pos >= this._windowSize){\n      pos = 0;\n    }\n    this._buffer[this._pos ++] = this._buffer[pos ++];\n    if (this._pos >= this._windowSize){\n      this.flush();\n    }\n  }\n};\nLZMA.OutWindow.prototype.putByte = function(b){\n  this._buffer[this._pos ++] = b;\n  if (this._pos >= this._windowSize){\n    this.flush();\n  }\n};\nLZMA.OutWindow.prototype.getByte = function(distance){\n  var pos = this._pos - distance - 1;\n  if (pos < 0){\n    pos += this._windowSize;\n  }\n  return this._buffer[pos];\n};\nLZMA.RangeDecoder = function(){\n};\nLZMA.RangeDecoder.prototype.setStream = function(stream){\n  this._stream = stream;\n};\nLZMA.RangeDecoder.prototype.releaseStream = function(){\n  this._stream = null;\n};\nLZMA.RangeDecoder.prototype.init = function(){\n  var i = 5;\n  this._code = 0;\n  this._range = -1;\n  \n  while(i --){\n    this._code = (this._code << 8) | this._stream.readByte();\n  }\n};\nLZMA.RangeDecoder.prototype.decodeDirectBits = function(numTotalBits){\n  var result = 0, i = numTotalBits, t;\n  while(i --){\n    this._range >>>= 1;\n    t = (this._code - this._range) >>> 31;\n    this._code -= this._range & (t - 1);\n    result = (result << 1) | (1 - t);\n    if ( (this._range & 0xff000000) === 0){\n      this._code = (this._code << 8) | this._stream.readByte();\n      this._range <<= 8;\n    }\n  }\n  return result;\n};\nLZMA.RangeDecoder.prototype.decodeBit = function(probs, index){\n  var prob = probs[index],\n      newBound = (this._range >>> 11) * prob;\n  if ( (this._code ^ 0x80000000) < (newBound ^ 0x80000000) ){\n    this._range = newBound;\n    probs[index] += (2048 - prob) >>> 5;\n    if ( (this._range & 0xff000000) === 0){\n      this._code = (this._code << 8) | this._stream.readByte();\n      this._range <<= 8;\n    }\n    return 0;\n  }\n  this._range -= newBound;\n  this._code -= newBound;\n  probs[index] -= prob >>> 5;\n  if ( (this._range & 0xff000000) === 0){\n    this._code = (this._code << 8) | this._stream.readByte();\n    this._range <<= 8;\n  }\n  return 1;\n};\nLZMA.initBitModels = function(probs, len){\n  while(len --){\n    probs[len] = 1024;\n  }\n};\nLZMA.BitTreeDecoder = function(numBitLevels){\n  this._models = [];\n  this._numBitLevels = numBitLevels;\n};\nLZMA.BitTreeDecoder.prototype.init = function(){\n  LZMA.initBitModels(this._models, 1 << this._numBitLevels);\n};\nLZMA.BitTreeDecoder.prototype.decode = function(rangeDecoder){\n  var m = 1, i = this._numBitLevels;\n  while(i --){\n    m = (m << 1) | rangeDecoder.decodeBit(this._models, m);\n  }\n  return m - (1 << this._numBitLevels);\n};\nLZMA.BitTreeDecoder.prototype.reverseDecode = function(rangeDecoder){\n  var m = 1, symbol = 0, i = 0, bit;\n  for (; i < this._numBitLevels; ++ i){\n    bit = rangeDecoder.decodeBit(this._models, m);\n    m = (m << 1) | bit;\n    symbol |= bit << i;\n  }\n  return symbol;\n};\nLZMA.reverseDecode2 = function(models, startIndex, rangeDecoder, numBitLevels){\n  var m = 1, symbol = 0, i = 0, bit;\n  for (; i < numBitLevels; ++ i){\n    bit = rangeDecoder.decodeBit(models, startIndex + m);\n    m = (m << 1) | bit;\n    symbol |= bit << i;\n  }\n  return symbol;\n};\nLZMA.LenDecoder = function(){\n  this._choice = [];\n  this._lowCoder = [];\n  this._midCoder = [];\n  this._highCoder = new LZMA.BitTreeDecoder(8);\n  this._numPosStates = 0;\n};\nLZMA.LenDecoder.prototype.create = function(numPosStates){\n  for (; this._numPosStates < numPosStates; ++ this._numPosStates){\n    this._lowCoder[this._numPosStates] = new LZMA.BitTreeDecoder(3);\n    this._midCoder[this._numPosStates] = new LZMA.BitTreeDecoder(3);\n  }\n};\nLZMA.LenDecoder.prototype.init = function(){\n  var i = this._numPosStates;\n  LZMA.initBitModels(this._choice, 2);\n  while(i --){\n    this._lowCoder[i].init();\n    this._midCoder[i].init();\n  }\n  this._highCoder.init();\n};\nLZMA.LenDecoder.prototype.decode = function(rangeDecoder, posState){\n  if (rangeDecoder.decodeBit(this._choice, 0) === 0){\n    return this._lowCoder[posState].decode(rangeDecoder);\n  }\n  if (rangeDecoder.decodeBit(this._choice, 1) === 0){\n    return 8 + this._midCoder[posState].decode(rangeDecoder);\n  }\n  return 16 + this._highCoder.decode(rangeDecoder);\n};\nLZMA.Decoder2 = function(){\n  this._decoders = [];\n};\nLZMA.Decoder2.prototype.init = function(){\n  LZMA.initBitModels(this._decoders, 0x300);\n};\nLZMA.Decoder2.prototype.decodeNormal = function(rangeDecoder){\n  var symbol = 1;\n  do{\n    symbol = (symbol << 1) | rangeDecoder.decodeBit(this._decoders, symbol);\n  }while(symbol < 0x100);\n  return symbol & 0xff;\n};\nLZMA.Decoder2.prototype.decodeWithMatchByte = function(rangeDecoder, matchByte){\n  var symbol = 1, matchBit, bit;\n  do{\n    matchBit = (matchByte >> 7) & 1;\n    matchByte <<= 1;\n    bit = rangeDecoder.decodeBit(this._decoders, ( (1 + matchBit) << 8) + symbol);\n    symbol = (symbol << 1) | bit;\n    if (matchBit !== bit){\n      while(symbol < 0x100){\n        symbol = (symbol << 1) | rangeDecoder.decodeBit(this._decoders, symbol);\n      }\n      break;\n    }\n  }while(symbol < 0x100);\n  return symbol & 0xff;\n};\nLZMA.LiteralDecoder = function(){\n};\nLZMA.LiteralDecoder.prototype.create = function(numPosBits, numPrevBits){\n  var i;\n  if (this._coders\n    && (this._numPrevBits === numPrevBits)\n    && (this._numPosBits === numPosBits) ){\n    return;\n  }\n  this._numPosBits = numPosBits;\n  this._posMask = (1 << numPosBits) - 1;\n  this._numPrevBits = numPrevBits;\n  this._coders = [];\n  i = 1 << (this._numPrevBits + this._numPosBits);\n  while(i --){\n    this._coders[i] = new LZMA.Decoder2();\n  }\n};\nLZMA.LiteralDecoder.prototype.init = function(){\n  var i = 1 << (this._numPrevBits + this._numPosBits);\n  while(i --){\n    this._coders[i].init();\n  }\n};\nLZMA.LiteralDecoder.prototype.getDecoder = function(pos, prevByte){\n  return this._coders[( (pos & this._posMask) << this._numPrevBits)\n    + ( (prevByte & 0xff) >>> (8 - this._numPrevBits) )];\n};\nLZMA.Decoder = function(){\n  this._outWindow = new LZMA.OutWindow();\n  this._rangeDecoder = new LZMA.RangeDecoder();\n  this._isMatchDecoders = [];\n  this._isRepDecoders = [];\n  this._isRepG0Decoders = [];\n  this._isRepG1Decoders = [];\n  this._isRepG2Decoders = [];\n  this._isRep0LongDecoders = [];\n  this._posSlotDecoder = [];\n  this._posDecoders = [];\n  this._posAlignDecoder = new LZMA.BitTreeDecoder(4);\n  this._lenDecoder = new LZMA.LenDecoder();\n  this._repLenDecoder = new LZMA.LenDecoder();\n  this._literalDecoder = new LZMA.LiteralDecoder();\n  this._dictionarySize = -1;\n  this._dictionarySizeCheck = -1;\n  this._posSlotDecoder[0] = new LZMA.BitTreeDecoder(6);\n  this._posSlotDecoder[1] = new LZMA.BitTreeDecoder(6);\n  this._posSlotDecoder[2] = new LZMA.BitTreeDecoder(6);\n  this._posSlotDecoder[3] = new LZMA.BitTreeDecoder(6);\n};\nLZMA.Decoder.prototype.setDictionarySize = function(dictionarySize){\n  if (dictionarySize < 0){\n    return false;\n  }\n  if (this._dictionarySize !== dictionarySize){\n    this._dictionarySize = dictionarySize;\n    this._dictionarySizeCheck = Math.max(this._dictionarySize, 1);\n    this._outWindow.create( Math.max(this._dictionarySizeCheck, 4096) );\n  }\n  return true;\n};\nLZMA.Decoder.prototype.setLcLpPb = function(lc, lp, pb){\n  var numPosStates = 1 << pb;\n  if (lc > 8 || lp > 4 || pb > 4){\n    return false;\n  }\n  this._literalDecoder.create(lp, lc);\n  this._lenDecoder.create(numPosStates);\n  this._repLenDecoder.create(numPosStates);\n  this._posStateMask = numPosStates - 1;\n  return true;\n};\nLZMA.Decoder.prototype.init = function(){\n  var i = 4;\n  this._outWindow.init(false);\n  LZMA.initBitModels(this._isMatchDecoders, 192);\n  LZMA.initBitModels(this._isRep0LongDecoders, 192);\n  LZMA.initBitModels(this._isRepDecoders, 12);\n  LZMA.initBitModels(this._isRepG0Decoders, 12);\n  LZMA.initBitModels(this._isRepG1Decoders, 12);\n  LZMA.initBitModels(this._isRepG2Decoders, 12);\n  LZMA.initBitModels(this._posDecoders, 114);\n  this._literalDecoder.init();\n  while(i --){\n    this._posSlotDecoder[i].init();\n  }\n  this._lenDecoder.init();\n  this._repLenDecoder.init();\n  this._posAlignDecoder.init();\n  this._rangeDecoder.init();\n};\nLZMA.Decoder.prototype.decode = function(inStream, outStream, outSize){\n  var state = 0, rep0 = 0, rep1 = 0, rep2 = 0, rep3 = 0, nowPos64 = 0, prevByte = 0,\n      posState, decoder2, len, distance, posSlot, numDirectBits;\n  this._rangeDecoder.setStream(inStream);\n  this._outWindow.setStream(outStream);\n  this.init();\n  while(outSize < 0 || nowPos64 < outSize){\n    posState = nowPos64 & this._posStateMask;\n    if (this._rangeDecoder.decodeBit(this._isMatchDecoders, (state << 4) + posState) === 0){\n      decoder2 = this._literalDecoder.getDecoder(nowPos64 ++, prevByte);\n      if (state >= 7){\n        prevByte = decoder2.decodeWithMatchByte(this._rangeDecoder, this._outWindow.getByte(rep0) );\n      }else{\n        prevByte = decoder2.decodeNormal(this._rangeDecoder);\n      }\n      this._outWindow.putByte(prevByte);\n      state = state < 4? 0: state - (state < 10? 3: 6);\n    }else{\n      if (this._rangeDecoder.decodeBit(this._isRepDecoders, state) === 1){\n        len = 0;\n        if (this._rangeDecoder.decodeBit(this._isRepG0Decoders, state) === 0){\n          if (this._rangeDecoder.decodeBit(this._isRep0LongDecoders, (state << 4) + posState) === 0){\n            state = state < 7? 9: 11;\n            len = 1;\n          }\n        }else{\n          if (this._rangeDecoder.decodeBit(this._isRepG1Decoders, state) === 0){\n            distance = rep1;\n          }else{\n            if (this._rangeDecoder.decodeBit(this._isRepG2Decoders, state) === 0){\n              distance = rep2;\n            }else{\n              distance = rep3;\n              rep3 = rep2;\n            }\n            rep2 = rep1;\n          }\n          rep1 = rep0;\n          rep0 = distance;\n        }\n        if (len === 0){\n          len = 2 + this._repLenDecoder.decode(this._rangeDecoder, posState);\n          state = state < 7? 8: 11;\n        }\n      }else{\n        rep3 = rep2;\n        rep2 = rep1;\n        rep1 = rep0;\n        len = 2 + this._lenDecoder.decode(this._rangeDecoder, posState);\n        state = state < 7? 7: 10;\n        posSlot = this._posSlotDecoder[len <= 5? len - 2: 3].decode(this._rangeDecoder);\n        if (posSlot >= 4){\n          numDirectBits = (posSlot >> 1) - 1;\n          rep0 = (2 | (posSlot & 1) ) << numDirectBits;\n          if (posSlot < 14){\n            rep0 += LZMA.reverseDecode2(this._posDecoders,\n                rep0 - posSlot - 1, this._rangeDecoder, numDirectBits);\n          }else{\n            rep0 += this._rangeDecoder.decodeDirectBits(numDirectBits - 4) << 4;\n            rep0 += this._posAlignDecoder.reverseDecode(this._rangeDecoder);\n            if (rep0 < 0){\n              if (rep0 === -1){\n                break;\n              }\n              return false;\n            }\n          }\n        }else{\n          rep0 = posSlot;\n        }\n      }\n      if (rep0 >= nowPos64 || rep0 >= this._dictionarySizeCheck){\n        return false;\n      }\n      this._outWindow.copyBlock(rep0, len);\n      nowPos64 += len;\n      prevByte = this._outWindow.getByte(0);\n    }\n  }\n  this._outWindow.flush();\n  this._outWindow.releaseStream();\n  this._rangeDecoder.releaseStream();\n  return true;\n};\nLZMA.Decoder.prototype.setDecoderProperties = function(properties){\n  var value, lc, lp, pb, dictionarySize;\n  if (properties.size < 5){\n    return false;\n  }\n  value = properties.readByte();\n  lc = value % 9;\n  value = ~~(value / 9);\n  lp = value % 5;\n  pb = ~~(value / 5);\n  if ( !this.setLcLpPb(lc, lp, pb) ){\n    return false;\n  }\n  dictionarySize = properties.readByte();\n  dictionarySize |= properties.readByte() << 8;\n  dictionarySize |= properties.readByte() << 16;\n  dictionarySize += properties.readByte() * 16777216;\n  return this.setDictionarySize(dictionarySize);\n};\nLZMA.decompress = function(properties, inStream, outStream, outSize){\n  var decoder = new LZMA.Decoder();\n  if ( !decoder.setDecoderProperties(properties) ){\n    throw 'Incorrect stream properties';\n  }\n  if ( !decoder.decode(inStream, outStream, outSize) ){\n    throw 'Error in data stream';\n  }\n  return true;\n};\nvar CTM = CTM || {};\nCTM.CompressionMethod = {\n  RAW: 0x00574152,\n  MG1: 0x0031474d,\n  MG2: 0x0032474d\n};\nCTM.Flags = {\n  NORMALS: 0x00000001\n};\nCTM.File = function(stream){\n  this.load(stream);\n};\nCTM.File.prototype.load = function(stream){\n  this.header = new CTM.FileHeader(stream);\n  this.body = new CTM.FileBody(this.header);\n  \n  this.getReader().read(stream, this.body);\n};\nCTM.File.prototype.getReader = function(){\n  var reader;\n  switch(this.header.compressionMethod){\n    case CTM.CompressionMethod.RAW:\n      reader = new CTM.ReaderRAW();\n      break;\n    case CTM.CompressionMethod.MG1:\n      reader = new CTM.ReaderMG1();\n      break;\n    case CTM.CompressionMethod.MG2:\n      reader = new CTM.ReaderMG2();\n      break;\n  }\n  return reader;\n};\nCTM.FileHeader = function(stream){\n  stream.readInt32(); \n  this.fileFormat = stream.readInt32();\n  this.compressionMethod = stream.readInt32();\n  this.vertexCount = stream.readInt32();\n  this.triangleCount = stream.readInt32();\n  this.uvMapCount = stream.readInt32();\n  this.attrMapCount = stream.readInt32();\n  this.flags = stream.readInt32();\n  this.comment = stream.readString();\n};\nCTM.FileHeader.prototype.hasNormals = function(){\n  return this.flags & CTM.Flags.NORMALS;\n};\nCTM.FileBody = function(header){\n  var i = header.triangleCount * 3,\n      v = header.vertexCount * 3,\n      n = header.hasNormals()? header.vertexCount * 3: 0,\n      u = header.vertexCount * 2,\n      a = header.vertexCount * 4,\n      j = 0;\n  var data = new ArrayBuffer(\n    (i + v + n + (u * header.uvMapCount) + (a * header.attrMapCount) ) * 4);\n  this.indices = new Uint32Array(data, 0, i);\n  this.vertices = new Float32Array(data, i * 4, v);\n  if ( header.hasNormals() ){\n    this.normals = new Float32Array(data, (i + v) * 4, n);\n  }\n  \n  if (header.uvMapCount){\n    this.uvMaps = [];\n    for (j = 0; j < header.uvMapCount; ++ j){\n      this.uvMaps[j] = {uv: new Float32Array(data,\n        (i + v + n + (j * u) ) * 4, u) };\n    }\n  }\n  \n  if (header.attrMapCount){\n    this.attrMaps = [];\n    for (j = 0; j < header.attrMapCount; ++ j){\n      this.attrMaps[j] = {attr: new Float32Array(data,\n        (i + v + n + (u * header.uvMapCount) + (j * a) ) * 4, a),start:(i + v + n + (u * header.uvMapCount) + (j * a) ) * 4 ,end:a };\n    }\n  }\n};\nCTM.FileMG2Header = function(stream){\n  stream.readInt32(); \n  this.vertexPrecision = stream.readFloat32();\n  this.normalPrecision = stream.readFloat32();\n  this.lowerBoundx = stream.readFloat32();\n  this.lowerBoundy = stream.readFloat32();\n  this.lowerBoundz = stream.readFloat32();\n  this.higherBoundx = stream.readFloat32();\n  this.higherBoundy = stream.readFloat32();\n  this.higherBoundz = stream.readFloat32();\n  this.divx = stream.readInt32();\n  this.divy = stream.readInt32();\n  this.divz = stream.readInt32();\n  \n  this.sizex = (this.higherBoundx - this.lowerBoundx) / this.divx;\n  this.sizey = (this.higherBoundy - this.lowerBoundy) / this.divy;\n  this.sizez = (this.higherBoundz - this.lowerBoundz) / this.divz;\n};\nCTM.ReaderRAW = function(){\n};\nCTM.ReaderRAW.prototype.read = function(stream, body){\n  this.readIndices(stream, body.indices);\n  this.readVertices(stream, body.vertices);\n  \n  if (body.normals){\n    this.readNormals(stream, body.normals);\n  }\n  if (body.uvMaps){\n    this.readUVMaps(stream, body.uvMaps);\n  }\n  if (body.attrMaps){\n    this.readAttrMaps(stream, body.attrMaps);\n  }\n};\nCTM.ReaderRAW.prototype.readIndices = function(stream, indices){\n  stream.readInt32(); \n  stream.readArrayInt32(indices);\n};\nCTM.ReaderRAW.prototype.readVertices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readArrayFloat32(vertices);\n};\nCTM.ReaderRAW.prototype.readNormals = function(stream, normals){\n  stream.readInt32(); \n  stream.readArrayFloat32(normals);\n};\nCTM.ReaderRAW.prototype.readUVMaps = function(stream, uvMaps){\n  var i = 0;\n  for (; i < uvMaps.length; ++ i){\n    stream.readInt32(); \n    uvMaps[i].name = stream.readString();\n    uvMaps[i].filename = stream.readString();\n    stream.readArrayFloat32(uvMaps[i].uv);\n  }\n};\nCTM.ReaderRAW.prototype.readAttrMaps = function(stream, attrMaps){\n  var i = 0;\n  for (; i < attrMaps.length; ++ i){\n    stream.readInt32(); \n    attrMaps[i].name = stream.readString();\n    stream.readArrayFloat32(attrMaps[i].attr);\n  }\n};\nCTM.ReaderMG1 = function(){\n};\nCTM.ReaderMG1.prototype.read = function(stream, body){\n  this.readIndices(stream, body.indices);\n  this.readVertices(stream, body.vertices);\n  \n  if (body.normals){\n    this.readNormals(stream, body.normals);\n  }\n  if (body.uvMaps){\n    this.readUVMaps(stream, body.uvMaps);\n  }\n  if (body.attrMaps){\n    this.readAttrMaps(stream, body.attrMaps);\n  }\n};\nCTM.ReaderMG1.prototype.readIndices = function(stream, indices){\n  stream.readInt32(); \n  stream.readInt32(); \n  \n  var interleaved = new CTM.InterleavedStream(indices, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  CTM.restoreIndices(indices, indices.length);\n};\nCTM.ReaderMG1.prototype.readVertices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readInt32(); \n  \n  var interleaved = new CTM.InterleavedStream(vertices, 1);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n};\nCTM.ReaderMG1.prototype.readNormals = function(stream, normals){\n  stream.readInt32(); \n  stream.readInt32(); \n  var interleaved = new CTM.InterleavedStream(normals, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n};\nCTM.ReaderMG1.prototype.readUVMaps = function(stream, uvMaps){\n  var i = 0;\n  for (; i < uvMaps.length; ++ i){\n    stream.readInt32(); \n    uvMaps[i].name = stream.readString();\n    uvMaps[i].filename = stream.readString();\n    \n    stream.readInt32(); \n    var interleaved = new CTM.InterleavedStream(uvMaps[i].uv, 2);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  }\n};\nCTM.ReaderMG1.prototype.readAttrMaps = function(stream, attrMaps){\n  var i = 0;\n  for (; i < attrMaps.length; ++ i){\n    stream.readInt32(); \n    attrMaps[i].name = stream.readString();\n    \n    stream.readInt32(); //packed size\n    var interleaved = new CTM.InterleavedStream(attrMaps[i].attr, 4);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  }\n};\nCTM.ReaderMG2 = function(){\n};\nCTM.ReaderMG2.prototype.read = function(stream, body){\n  this.MG2Header = new CTM.FileMG2Header(stream);\n  \n  this.readVertices(stream, body.vertices);\n  this.readIndices(stream, body.indices);\n  \n  if (body.normals){\n    this.readNormals(stream, body);\n  }\n  if (body.uvMaps){\n    this.readUVMaps(stream, body.uvMaps);\n  }\n  if (body.attrMaps){\n    this.readAttrMaps(stream, body.attrMaps);\n  }\n};\nCTM.ReaderMG2.prototype.readVertices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  var interleaved = new CTM.InterleavedStream(vertices, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  \n  var gridIndices = this.readGridIndices(stream, vertices);\n  \n  CTM.restoreVertices(vertices, this.MG2Header, gridIndices, this.MG2Header.vertexPrecision);\n};\nCTM.ReaderMG2.prototype.readGridIndices = function(stream, vertices){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  \n  var gridIndices = new Uint32Array(vertices.length / 3);\n  \n  var interleaved = new CTM.InterleavedStream(gridIndices, 1);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  \n  CTM.restoreGridIndices(gridIndices, gridIndices.length);\n  \n  return gridIndices;\n};\nCTM.ReaderMG2.prototype.readIndices = function(stream, indices){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  var interleaved = new CTM.InterleavedStream(indices, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  CTM.restoreIndices(indices, indices.length);\n};\nCTM.ReaderMG2.prototype.readNormals = function(stream, body){\n  stream.readInt32(); \n  stream.readInt32(); //packed size\n  var interleaved = new CTM.InterleavedStream(body.normals, 3);\n  LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n  var smooth = CTM.calcSmoothNormals(body.indices, body.vertices);\n  CTM.restoreNormals(body.normals, smooth, this.MG2Header.normalPrecision);\n};\nCTM.ReaderMG2.prototype.readUVMaps = function(stream, uvMaps){\n  var i = 0;\n  for (; i < uvMaps.length; ++ i){\n    stream.readInt32(); \n    uvMaps[i].name = stream.readString();\n    uvMaps[i].filename = stream.readString();\n    \n    var precision = stream.readFloat32();\n    \n    stream.readInt32(); //packed size\n    var interleaved = new CTM.InterleavedStream(uvMaps[i].uv, 2);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n    \n    CTM.restoreMap(uvMaps[i].uv, 2, precision);\n  }\n};\nCTM.ReaderMG2.prototype.readAttrMaps = function(stream, attrMaps){\n  var i = 0;\n  for (; i < attrMaps.length; ++ i){\n    stream.readInt32(); \n    attrMaps[i].name = stream.readString();\n    \n    var precision = stream.readFloat32();\n    \n    stream.readInt32(); //packed size\n    var interleaved = new CTM.InterleavedStream(attrMaps[i].attr, 4);\n    LZMA.decompress(stream, stream, interleaved, interleaved.data.length);\n    \n    CTM.restoreMap(attrMaps[i].attr, 4, precision);\n  }\n};\nCTM.restoreIndices = function(indices, len){\n  var i = 3;\n  if (len > 0){\n    indices[2] += indices[0];\n    indices[1] += indices[0];\n  }\n  for (; i < len; i += 3){\n    indices[i] += indices[i - 3];\n    \n    if (indices[i] === indices[i - 3]){\n      indices[i + 1] += indices[i - 2];\n    }else{\n      indices[i + 1] += indices[i];\n    }\n    indices[i + 2] += indices[i];\n  }\n};\nCTM.restoreGridIndices = function(gridIndices, len){\n  var i = 1;\n  for (; i < len; ++ i){\n    gridIndices[i] += gridIndices[i - 1];\n  }\n};\nCTM.restoreVertices = function(vertices, grid, gridIndices, precision){\n  var gridIdx, delta, x, y, z,\n      intVertices = new Uint32Array(vertices.buffer, vertices.byteOffset, vertices.length),\n      ydiv = grid.divx, zdiv = ydiv * grid.divy,\n      prevGridIdx = 0x7fffffff, prevDelta = 0,\n      i = 0, j = 0, len = gridIndices.length;\n  for (; i < len; j += 3){\n    x = gridIdx = gridIndices[i ++];\n    \n    z = ~~(x / zdiv);\n    x -= ~~(z * zdiv);\n    y = ~~(x / ydiv);\n    x -= ~~(y * ydiv);\n    delta = intVertices[j];\n    if (gridIdx === prevGridIdx){\n      delta += prevDelta;\n    }\n    vertices[j]     = grid.lowerBoundx +\n      x * grid.sizex + precision * delta;\n    vertices[j + 1] = grid.lowerBoundy +\n      y * grid.sizey + precision * intVertices[j + 1];\n    vertices[j + 2] = grid.lowerBoundz +\n      z * grid.sizez + precision * intVertices[j + 2];\n    prevGridIdx = gridIdx;\n    prevDelta = delta;\n  }\n};\nCTM.restoreNormals = function(normals, smooth, precision){\n  var ro, phi, theta, sinPhi,\n      nx, ny, nz, by, bz, len,\n      intNormals = new Uint32Array(normals.buffer, normals.byteOffset, normals.length),\n      i = 0, k = normals.length,\n      PI_DIV_2 = 3.141592653589793238462643 * 0.5;\n  for (; i < k; i += 3){\n    ro = intNormals[i] * precision;\n    phi = intNormals[i + 1];\n    if (phi === 0){\n      normals[i]     = smooth[i]     * ro;\n      normals[i + 1] = smooth[i + 1] * ro;\n      normals[i + 2] = smooth[i + 2] * ro;\n    }else{\n      \n      if (phi <= 4){\n        theta = (intNormals[i + 2] - 2) * PI_DIV_2;\n      }else{\n        theta = ( (intNormals[i + 2] * 4 / phi) - 2) * PI_DIV_2;\n      }\n      \n      phi *= precision * PI_DIV_2;\n      sinPhi = ro * Math.sin(phi);\n      nx = sinPhi * Math.cos(theta);\n      ny = sinPhi * Math.sin(theta);\n      nz = ro * Math.cos(phi);\n      bz = smooth[i + 1];\n      by = smooth[i] - smooth[i + 2];\n      len = Math.sqrt(2 * bz * bz + by * by);\n      if (len > 1e-20){\n        by /= len;\n        bz /= len;\n      }\n      normals[i]     = smooth[i]     * nz +\n        (smooth[i + 1] * bz - smooth[i + 2] * by) * ny - bz * nx;\n      normals[i + 1] = smooth[i + 1] * nz -\n        (smooth[i + 2]      + smooth[i]   ) * bz  * ny + by * nx;\n      normals[i + 2] = smooth[i + 2] * nz +\n        (smooth[i]     * by + smooth[i + 1] * bz) * ny + bz * nx;\n    }\n  }\n};\nCTM.restoreMap = function(map, count, precision){\n  var delta, value,\n      intMap = new Uint32Array(map.buffer, map.byteOffset, map.length),\n      i = 0, j, len = map.length;\n  for (; i < count; ++ i){\n    delta = 0;\n    for (j = i; j < len; j += count){\n      value = intMap[j];\n      \n      delta += value & 1? -( (value + 1) >> 1): value >> 1;\n      \n      map[j] = delta * precision;\n    }\n  }\n};\nCTM.calcSmoothNormals = function(indices, vertices){\n  var smooth = new Float32Array(vertices.length),\n      indx, indy, indz, nx, ny, nz,\n      v1x, v1y, v1z, v2x, v2y, v2z, len,\n      i, k;\n  for (i = 0, k = indices.length; i < k;){\n    indx = indices[i ++] * 3;\n    indy = indices[i ++] * 3;\n    indz = indices[i ++] * 3;\n    v1x = vertices[indy]     - vertices[indx];\n    v2x = vertices[indz]     - vertices[indx];\n    v1y = vertices[indy + 1] - vertices[indx + 1];\n    v2y = vertices[indz + 1] - vertices[indx + 1];\n    v1z = vertices[indy + 2] - vertices[indx + 2];\n    v2z = vertices[indz + 2] - vertices[indx + 2];\n    \n    nx = v1y * v2z - v1z * v2y;\n    ny = v1z * v2x - v1x * v2z;\n    nz = v1x * v2y - v1y * v2x;\n    \n    len = Math.sqrt(nx * nx + ny * ny + nz * nz);\n    if (len > 1e-10){\n      nx /= len;\n      ny /= len;\n      nz /= len;\n    }\n    \n    smooth[indx]     += nx;\n    smooth[indx + 1] += ny;\n    smooth[indx + 2] += nz;\n    smooth[indy]     += nx;\n    smooth[indy + 1] += ny;\n    smooth[indy + 2] += nz;\n    smooth[indz]     += nx;\n    smooth[indz + 1] += ny;\n    smooth[indz + 2] += nz;\n  }\n  for (i = 0, k = smooth.length; i < k; i += 3){\n    len = Math.sqrt(smooth[i] * smooth[i] + \n      smooth[i + 1] * smooth[i + 1] +\n      smooth[i + 2] * smooth[i + 2]);\n    if(len > 1e-10){\n      smooth[i]     /= len;\n      smooth[i + 1] /= len;\n      smooth[i + 2] /= len;\n    }\n  }\n  return smooth;\n};\nCTM.isLittleEndian = (function(){\n  var buffer = new ArrayBuffer(2),\n      bytes = new Uint8Array(buffer),\n      ints = new Uint16Array(buffer);\n  bytes[0] = 1;\n  return ints[0] === 1;\n}());\nCTM.InterleavedStream = function(data, count){\n  this.data = new Uint8Array(data.buffer, data.byteOffset, data.byteLength);\n  this.offset = CTM.isLittleEndian? 3: 0;\n  this.count = count * 4;\n  this.len = this.data.length;\n};\nCTM.InterleavedStream.prototype.writeByte = function(value){\n  this.data[this.offset] = value;\n  \n  this.offset += this.count;\n  if (this.offset >= this.len){\n  \n    this.offset -= this.len - 4;\n    if (this.offset >= this.count){\n    \n      this.offset -= this.count + (CTM.isLittleEndian? 1: -1);\n    }\n  }\n};\nCTM.Stream = function(data){\n  this.data = data;\n  this.offset = 0;\n};\nCTM.Stream.prototype.TWO_POW_MINUS23 = Math.pow(2, -23);\nCTM.Stream.prototype.TWO_POW_MINUS126 = Math.pow(2, -126);\nCTM.Stream.prototype.readByte = function(){\n  return this.data[this.offset ++] & 0xff;\n};\nCTM.Stream.prototype.readInt32 = function(){\n  var i = this.readByte();\n  i |= this.readByte() << 8;\n  i |= this.readByte() << 16;\n  return i | (this.readByte() << 24);\n};\nCTM.Stream.prototype.readFloat32 = function(){\n  var m = this.readByte();\n  m += this.readByte() << 8;\n  var b1 = this.readByte();\n  var b2 = this.readByte();\n  m += (b1 & 0x7f) << 16; \n  var e = ( (b2 & 0x7f) << 1) | ( (b1 & 0x80) >>> 7);\n  var s = b2 & 0x80? -1: 1;\n  if (e === 255){\n    return m !== 0? NaN: s * Infinity;\n  }\n  if (e > 0){\n    return s * (1 + (m * this.TWO_POW_MINUS23) ) * Math.pow(2, e - 127);\n  }\n  if (m !== 0){\n    return s * m * this.TWO_POW_MINUS126;\n  }\n  return s * 0;\n};\nCTM.Stream.prototype.readString = function(){\n  var len = this.readInt32();\n  this.offset += len;\n  return String.fromCharCode.apply(null,this.data.subarray(this.offset - len, this.offset));\n};\nCTM.Stream.prototype.readArrayInt32 = function(array){\n  var i = 0, len = array.length;\n  \n  while(i < len){\n    array[i ++] = this.readInt32();\n  }\n  return array;\n};\nCTM.Stream.prototype.readArrayFloat32 = function(array){\n  var i = 0, len = array.length;\n  while(i < len){\n    array[i ++] = this.readFloat32();\n  }\n  return array;\n};\n//original CTMWorker.js\nself.onmessage = function( event ) {\n\tvar files = [];\n\tfor ( var i = 0; i < event.data.offsets.length; i ++ ) {\n\t\tvar stream = new CTM.Stream( event.data.data );\n\t\tstream.offset = event.data.offsets[ i ];\n\t\tfiles[ i ] = new CTM.File( stream );\n\t}\n\tself.postMessage( files );\n\tself.close();\n};",THREE.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){},this.geometryHandlers={},this.hierarchyHandlers={},this.addGeometryHandler("ascii",THREE.JSONLoader),this.loader=new THREE.XHRLoader(this.manager)},THREE.SceneLoader.prototype={constructor:THREE.SceneLoader,load:function(t,i,e,n){var r=this,o=this.loader;o.setCrossOrigin(this.crossOrigin),o.load(t,function(e){setTimeout(function(e,t,i,n){try{e.parse(JSON.parse(t),i,n)}catch(e){console.log("SceneLoader_r63"),console.log(e),console.log("ResponseText",t),i({scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}})}}.bind(this),1,r,e,i,t)},e,n)},setCrossOrigin:function(e){this.crossOrigin=e},addGeometryHandler:function(e,t){this.geometryHandlers[e]={loaderClass:t}},addHierarchyHandler:function(e,t){this.hierarchyHandlers[e]={loaderClass:t}},parse:function(e,t,i){var R,M,n,I,o,r,a,s,L,c,l,A=this,h=THREE.Loader.prototype.extractUrlBase(i),d=[],x=e;for(c in this.geometryHandlers){var u=this.geometryHandlers[c].loaderClass;this.geometryHandlers[c].loaderObject=new u}for(c in this.hierarchyHandlers){u=this.hierarchyHandlers[c].loaderClass;this.hierarchyHandlers[c].loaderObject=new u}function C(e,t){return"relativeToHTML"==t?e:h+"/"+e}function m(){!function e(t,i){var n,r,o,a;for(var s in i){var c=L.objects[s],l=i[s];if(void 0===c){if(l.type&&l.type in A.hierarchyHandlers){if(void 0===l.loading){var h,d={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1},u={};for(h in l)h in d||(u[h]=l[h]);_=L.materials[l.material],l.loading=!0;var m=A.hierarchyHandlers[l.type].loaderObject;m.options?m.load(C(l.url,x.urlBaseType),D(s,t,_,l)):m.load(C(l.url,x.urlBaseType),D(s,t,_,l),u)}}else if(void 0!==l.geometry){if(R=L.geometries[l.geometry]){var f=!1;if(_=L.materials[l.material],f=_ instanceof THREE.ShaderMaterial,n=l.position,r=l.rotation,o=l.scale,m=l.matrix,a=l.quaternion,l.material||(_=new THREE.MeshFaceMaterial(L.face_materials[l.geometry])),_ instanceof THREE.MeshFaceMaterial&&0===_.materials.length&&(_=new THREE.MeshFaceMaterial(L.face_materials[l.geometry])),_ instanceof THREE.MeshFaceMaterial)for(var p=0;p<_.materials.length;p++)f=f||_.materials[p]instanceof THREE.ShaderMaterial;f&&R.computeTangents(),l.skin?c=new THREE.SkinnedMesh(R,_):l.morph?(c=new THREE.MorphAnimMesh(R,_),void 0!==l.duration&&(c.duration=l.duration),void 0!==l.time&&(c.time=l.time),void 0!==l.mirroredLoop&&(c.mirroredLoop=l.mirroredLoop),_.morphNormals&&R.computeMorphNormals()):c=new THREE.Mesh(R,_),c.name=s,m?(c.matrixAutoUpdate=!1,c.matrix.set(m[0],m[1],m[2],m[3],m[4],m[5],m[6],m[7],m[8],m[9],m[10],m[11],m[12],m[13],m[14],m[15])):(c.position.fromArray(n),a?c.quaternion.fromArray(a):c.rotation.fromArray(r),c.scale.fromArray(o)),c.visible=l.visible,c.castShadow=l.castShadow,c.receiveShadow=l.receiveShadow,t.add(c),L.objects[s]=c}}else if("AmbientLight"===l.type||"PointLight"===l.type||"DirectionalLight"===l.type||"SpotLight"===l.type||"HemisphereLight"===l.type||"AreaLight"===l.type){var v=l.color,g=l.intensity,E=l.distance,y=l.position,S=l.rotation;switch(l.type){case"AmbientLight":I=new THREE.AmbientLight(v);break;case"PointLight":(I=new THREE.PointLight(v,g,E)).position.fromArray(y);break;case"DirectionalLight":(I=new THREE.DirectionalLight(v,g)).position.fromArray(l.direction);break;case"SpotLight":(I=new THREE.SpotLight(v,g,E,1)).angle=l.angle,I.position.fromArray(y),I.target.set(y[0],y[1]-E,y[2]),I.target.applyEuler(new THREE.Euler(S[0],S[1],S[2],"XYZ"));break;case"HemisphereLight":(I=new THREE.DirectionalLight(v,g,E)).target.set(y[0],y[1]-E,y[2]),I.target.applyEuler(new THREE.Euler(S[0],S[1],S[2],"XYZ"));break;case"AreaLight":(I=new THREE.AreaLight(v,g)).position.fromArray(y),I.width=l.size,I.height=l.size_y}t.add(I),I.name=s,L.lights[s]=I,L.objects[s]=I}else"PerspectiveCamera"===l.type||"OrthographicCamera"===l.type?(n=l.position,r=l.rotation,a=l.quaternion,"PerspectiveCamera"===l.type?M=new THREE.PerspectiveCamera(l.fov,l.aspect,l.near,l.far):"OrthographicCamera"===l.type&&(M=new THREE.OrthographicCamera(l.left,l.right,l.top,l.bottom,l.near,l.far)),M.name=s,M.position.fromArray(n),void 0!==a?M.quaternion.fromArray(a):void 0!==r&&M.rotation.fromArray(r),t.add(M),L.cameras[s]=M,L.objects[s]=M):(n=l.position,r=l.rotation,o=l.scale,a=l.quaternion,(c=new THREE.Object3D).name=s,c.position.fromArray(n),a?c.quaternion.fromArray(a):c.rotation.fromArray(r),c.scale.fromArray(o),c.visible=void 0!==l.visible&&l.visible,t.add(c),L.objects[s]=c,L.empties[s]=c);if(c){if(void 0!==l.userData)for(var b in l.userData){var T=l.userData[b];c.userData[b]=T}if(void 0!==l.groups)for(var p=0;p<l.groups.length;p++){var w=l.groups[p];void 0===L.groups[w]&&(L.groups[w]=[]),L.groups[w].push(s)}}}void 0!==c&&void 0!==l.children&&e(c,l.children)}}(L.scene,x.objects)}function f(n){return function(e,t){var i;e.name=n,i=e,e=t,t=n,L.geometries[t]=i,L.face_materials[t]=e,m(),--o,A.onLoadComplete(),p()}}function D(t,i,n,r){return function(e){e=e.content||(e.dae?e.scene:e);(function(e,t,i,n,r){var o=r.position,a=r.rotation,s=r.quaternion,c=r.scale;e.position.fromArray(o),s?e.quaternion.fromArray(s):e.rotation.fromArray(a),e.scale.fromArray(c),n&&e.traverse(function(e){e.material=n});var l=void 0===r.visible||r.visible;e.traverse(function(e){e.visible=l}),i.add(e),e.name=t,L.objects[t]=e,m()})(e,t,i,n,r),--o,A.onLoadComplete(),p()}}function p(){var e={totalModels:a,totalTextures:s,loadedModels:a-o,loadedTextures:s-r};A.callbackProgress(e,L),A.onLoadProgress(),0===o&&0===r&&(function(){for(var e=0;e<d.length;e++){var t=d[e],i=L.objects[t.targetName];i?t.object.target=i:(t.object.target=new THREE.Object3D,L.scene.add(t.object.target)),t.object.target.userData.targetInverse=t.object}}(),t(L))}r=o=0,L={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}},x.transform&&(l=x.transform.position,i=x.transform.rotation,e=x.transform.scale,l&&L.scene.position.fromArray(l),i&&L.scene.rotation.fromArray(i),e&&L.scene.scale.fromArray(e),(l||i||e)&&(L.scene.updateMatrix(),L.scene.updateMatrixWorld()));function v(e){return function(){r-=e,p(),A.onLoadComplete()}}var g,E,y,S,b,T,w,H,G,O,P,k,j,F,B,U,z,V,N,_;for(g in x.fogs)"linear"===(E=x.fogs[g]).type?n=new THREE.Fog(0,E.near,E.far):"exp2"===E.type&&(n=new THREE.FogExp2(0,E.density)),E=E.color,n.color.setRGB(E[0],E[1],E[2]),L.fogs[g]=n;for(y in x.geometries)(S=x.geometries[y]).type in this.geometryHandlers&&(o+=1,A.onLoadStart());for(b in x.objects)!function e(t,i){if(i(t),void 0!==t.children)for(var n in t.children)e(t.children[n],i)}(x.objects[b],function(e){e.type&&e.type in A.hierarchyHandlers&&(o+=1,A.onLoadStart())});for(y in a=o,x.geometries)if("cube"===(S=x.geometries[y]).type)(R=new THREE.CubeGeometry(S.width,S.height,S.depth,S.widthSegments,S.heightSegments,S.depthSegments)).name=y,L.geometries[y]=R;else if("plane"===S.type)(R=new THREE.PlaneGeometry(S.width,S.height,S.widthSegments,S.heightSegments)).name=y,L.geometries[y]=R;else if("sphere"===S.type)(R=new THREE.SphereGeometry(S.radius,S.widthSegments,S.heightSegments)).name=y,L.geometries[y]=R;else if("cylinder"===S.type)(R=new THREE.CylinderGeometry(S.topRad,S.botRad,S.height,S.radSegs,S.heightSegs)).name=y,L.geometries[y]=R;else if("torus"===S.type)(R=new THREE.TorusGeometry(S.radius,S.tube,S.segmentsR,S.segmentsT)).name=y,L.geometries[y]=R;else if("icosahedron"===S.type)(R=new THREE.IcosahedronGeometry(S.radius,S.subdivisions)).name=y,L.geometries[y]=R;else if(S.type in this.geometryHandlers){var W,Z={};for(W in S)"type"!==W&&"url"!==W&&(Z[W]=S[W]);this.geometryHandlers[S.type].loaderObject.load(C(S.url,x.urlBaseType),f(y),Z)}else"embedded"===S.type&&(T=x.embeds[S.id],w=h,T.metadata=x.metadata,T&&function(i){return function(e,t){e.name=i,L.geometries[i]=e,L.face_materials[i]=t}}(y)((w=this.geometryHandlers.ascii.loaderObject.parse(T,w)).geometry,w.materials));for(H in x.textures)if((G=x.textures[H]).url instanceof Array){r+=G.url.length;for(var Q=0;Q<G.url.length;Q++)A.onLoadStart()}else r+=1,A.onLoadStart();for(H in s=r,x.textures){if(void 0!==(G=x.textures[H]).mapping&&void 0!==THREE[G.mapping]&&(G.mapping=new THREE[G.mapping]),G.url instanceof Array){for(var X=G.url.length,Y=[],J=0;J<X;J++)Y[J]=C(G.url[J],x.urlBaseType);var q=(K=/\.dds$/i.test(Y[0]))?THREE.ImageUtils.loadCompressedTextureCube(Y,G.mapping,v(X)):THREE.ImageUtils.loadTextureCube(Y,G.mapping,v(X))}else{var K=/\.dds$/i.test(G.url),$=C(G.url,x.urlBaseType),ee=v(1);q=K?THREE.ImageUtils.loadCompressedTexture($,G.mapping,ee):THREE.ImageUtils.loadTexture($,G.mapping,ee),void 0!==THREE[G.minFilter]&&(q.minFilter=THREE[G.minFilter]),void 0!==THREE[G.magFilter]&&(q.magFilter=THREE[G.magFilter]),G.anisotropy&&(q.anisotropy=G.anisotropy),G.repeat&&(q.repeat.set(G.repeat[0],G.repeat[1]),1!==G.repeat[0]&&(q.wrapS=THREE.RepeatWrapping),1!==G.repeat[1]&&(q.wrapT=THREE.RepeatWrapping)),G.offset&&q.offset.set(G.offset[0],G.offset[1]),G.wrap&&(void 0!==(ee={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping})[G.wrap[0]]&&(q.wrapS=ee[G.wrap[0]]),void 0!==ee[G.wrap[1]]&&(q.wrapT=ee[G.wrap[1]]))}L.textures[H]=q}for(O in x.materials){for(k in(P=x.materials[O]).parameters)"envMap"===k||"map"===k||"lightMap"===k||"bumpMap"===k?P.parameters[k]=L.textures[P.parameters[k]]:"shading"===k?P.parameters[k]="flat"===P.parameters[k]?THREE.FlatShading:THREE.SmoothShading:"side"===k?"double"==P.parameters[k]?P.parameters[k]=THREE.DoubleSide:"back"==P.parameters[k]?P.parameters[k]=THREE.BackSide:P.parameters[k]=THREE.FrontSide:"blending"===k?P.parameters[k]=P.parameters[k]in THREE?THREE[P.parameters[k]]:THREE.NormalBlending:"combine"===k?P.parameters[k]=P.parameters[k]in THREE?THREE[P.parameters[k]]:THREE.MultiplyOperation:"vertexColors"===k?"face"==P.parameters[k]?P.parameters[k]=THREE.FaceColors:P.parameters[k]&&(P.parameters[k]=THREE.VertexColors):"wrapRGB"===k&&(j=P.parameters[k],P.parameters[k]=new THREE.Vector3(j[0],j[1],j[2]));void 0!==P.parameters.opacity&&P.parameters.opacity<1&&(P.parameters.transparent=!0),(_=P.parameters.normalMap?(F=THREE.ShaderLib.normalmap,N=THREE.UniformsUtils.clone(F.uniforms),B=P.parameters.color,U=P.parameters.specular,z=P.parameters.ambient,V=P.parameters.shininess,N.tNormal.value=L.textures[P.parameters.normalMap],P.parameters.normalScale&&N.uNormalScale.value.set(P.parameters.normalScale[0],P.parameters.normalScale[1]),P.parameters.map&&(N.tDiffuse.value=P.parameters.map,N.enableDiffuse.value=!0),P.parameters.envMap&&(N.tCube.value=P.parameters.envMap,N.enableReflection.value=!0,N.uReflectivity.value=P.parameters.reflectivity),P.parameters.lightMap&&(N.tAO.value=P.parameters.lightMap,N.enableAO.value=!0),P.parameters.specularMap&&(N.tSpecular.value=L.textures[P.parameters.specularMap],N.enableSpecular.value=!0),P.parameters.displacementMap&&(N.tDisplacement.value=L.textures[P.parameters.displacementMap],N.enableDisplacement.value=!0,N.uDisplacementBias.value=P.parameters.displacementBias,N.uDisplacementScale.value=P.parameters.displacementScale),N.uDiffuseColor.value.setHex(B),N.uSpecularColor.value.setHex(U),N.uAmbientColor.value.setHex(z),N.uShininess.value=V,P.parameters.opacity&&(N.uOpacity.value=P.parameters.opacity),N={fragmentShader:F.fragmentShader,vertexShader:F.vertexShader,uniforms:N,lights:!0,fog:!0},new THREE.ShaderMaterial(N)):new THREE[P.type](P.parameters)).name=O,L.materials[O]=_}for(O in x.materials)if((P=x.materials[O]).parameters.materials){for(var te=[],J=0;J<P.parameters.materials.length;J++){var ie=P.parameters.materials[J];te.push(L.materials[ie])}L.materials[O].materials=te}m(),L.cameras&&x.defaults.camera&&(L.currentCamera=L.cameras[x.defaults.camera]),L.fogs&&x.defaults.fog&&(L.scene.fog=L.fogs[x.defaults.fog]),A.callbackSync(L),p()}},THREE.XHRLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.request=new XMLHttpRequest},THREE.XHRLoader.prototype={constructor:THREE.XHRLoader,load:function(t,i,n,r){var o=this,e=this.request;void 0!==i&&e.addEventListener("load",function(e){i(e.target.responseText),o.manager.itemEnd(t)},!1),n&&e.addEventListener("progress",function(e){n(e)},!1),void 0!==r&&e.addEventListener("error",function(e){r(e)},!1),void 0!==this.crossOrigin&&(e.crossOrigin=this.crossOrigin),e.open("GET",t,!0),e.send(null),o.manager.itemStart(t)},setCrossOrigin:function(e){this.crossOrigin=e}},THREE.BinaryLoader=function(e){THREE.Loader.call(this,e)},THREE.BinaryLoader.prototype=Object.create(THREE.Loader.prototype),THREE.BinaryLoader.prototype.load=function(e,t,i,n){i=i||this.extractUrlBase(e),n=n||this.extractUrlBase(e);var r=this.showProgress?THREE.Loader.prototype.updateProgress:void 0;this.onLoadStart(),this.loadAjaxJSON(this,e,t,i,n,r)},THREE.BinaryLoader.prototype.loadAjaxJSON=function(t,i,n,r,o,a){var s=new XMLHttpRequest;r=r&&"string"==typeof r?r:this.extractUrlBase(i),o=o&&"string"==typeof o?o:this.extractUrlBase(i),s.onreadystatechange=function(){var e;4==s.readyState&&(200==s.status||0==s.status?(e=JSON.parse(s.responseText),t.loadAjaxBuffers(e,n,o,r,a)):console.error("THREE.BinaryLoader: Couldn't load ["+i+"] ["+s.status+"]"))},s.open("GET",i,!0),s.send(null)},THREE.BinaryLoader.prototype.loadAjaxBuffers=function(o,a,e,s,t){var c=new XMLHttpRequest,i=e+"/"+o.buffers;c.addEventListener("load",function(e){if(void 0===(t=c.response)&&(t=new Uint8Array(c.responseBody).buffer),0==t.byteLength)for(var t=new ArrayBuffer(c.responseText.length),i=new Uint8Array(t),n=0,r=c.responseText.length;n<r;n++)i[n]=255&c.responseText.charCodeAt(n);THREE.BinaryLoader.prototype.createBinModel(t,a,s,o.materials)},!1),void 0!==t&&c.addEventListener("progress",function(e){e.lengthComputable&&t(e)},!1),c.addEventListener("error",function(e){console.error("THREE.BinaryLoader: Couldn't load ["+i+"] ["+c.status+"]")},!1),c.open("GET",i,!0),c.responseType="arraybuffer",c.overrideMimeType&&c.overrideMimeType("text/plain; charset=x-user-defined"),c.send(null)},THREE.BinaryLoader.prototype.createBinModel=function(ne,e,t,i){var n=function(e){var s,t,i,n,r,o,a,c,l,h,d,u,m,f,p,v,g,E,y,S,b,T,w,R,M,I,L,A,x,C,D,H,G,O,P,k,j,F,B,U,z,V,N,_=this,W=0,Z=[],Q=[];function X(e){return e%4?4-e%4:0}function Y(e,t){return new Uint8Array(e,t,1)[0]}function J(e,t){return new Uint32Array(e,t,1)[0]}function q(e,t){for(var i,n,r,o,a,s,c,l=new Uint32Array(ne,t,3*e),h=0;h<e;h++)s=l[3*h],c=l[3*h+1],i=l[3*h+2],n=Q[2*s],r=Q[2*s+1],o=Q[2*c],a=Q[2*c+1],s=Q[2*i],c=Q[2*i+1],i=_.faceVertexUvs[0],n=n,r=r,o=o,a=a,s=s,c=c,i.push([new THREE.Vector2(n,r),new THREE.Vector2(o,a),new THREE.Vector2(s,c)])}function K(e,t){for(var i,n,r,o,a,s,c,l,h,d=new Uint32Array(ne,t,4*e),u=0;u<e;u++)c=d[4*u],l=d[4*u+1],h=d[4*u+2],i=d[4*u+3],n=Q[2*c],r=Q[2*c+1],o=Q[2*l],a=Q[2*l+1],s=Q[2*h],c=Q[2*h+1],l=Q[2*i],h=Q[2*i+1],i=_.faceVertexUvs[0],n=n,r=r,o=o,a=a,s=s,c=c,l=l,h=h,i.push([new THREE.Vector2(n,r),new THREE.Vector2(o,a),new THREE.Vector2(l,h)]),i.push([new THREE.Vector2(o,a),new THREE.Vector2(s,c),new THREE.Vector2(l,h)])}function $(e,t,i){for(var n,r,o,a,s=new Uint32Array(ne,t,3*e),c=new Uint16Array(ne,i,e),l=0;l<e;l++)n=s[3*l],r=s[3*l+1],o=s[3*l+2],a=c[l],n=n,r=r,o=o,a=a,_.faces.push(new THREE.Face3(n,r,o,null,null,a))}function ee(e,t,i){for(var n,r,o,a,s,c,l=new Uint32Array(ne,t,4*e),h=new Uint16Array(ne,i,e),d=0;d<e;d++)o=l[4*d],a=l[4*d+1],s=l[4*d+2],c=l[4*d+3],n=h[d],r=o,o=a,a=s,s=c,c=n,(n=_).faces.push(new THREE.Face3(r,o,s,null,null,c)),n.faces.push(new THREE.Face3(o,a,s,null,null,c))}function te(e,t,i,n){for(var r,o,a,s,c,l,h,d,u,m,f,p,v,g,E,y=new Uint32Array(ne,t,3*e),S=new Uint32Array(ne,i,3*e),b=new Uint16Array(ne,n,e),T=0;T<e;T++)f=y[3*T],p=y[3*T+1],v=y[3*T+2],h=S[3*T],E=S[3*T+1],o=S[3*T+2],g=b[T],r=_,a=f,s=p,c=v,l=g,d=E,u=o,E=g=v=p=f=m=void 0,m=(o=Z)[3*(h=h)],f=o[3*h+1],p=o[3*h+2],v=o[3*d],g=o[3*d+1],E=o[3*d+2],h=o[3*u],d=o[3*u+1],u=o[3*u+2],r.faces.push(new THREE.Face3(a,s,c,[new THREE.Vector3(m,f,p),new THREE.Vector3(v,g,E),new THREE.Vector3(h,d,u)],null,l))}function ie(e,t,i,n){for(var r,o,a,s,c,l,h,d,u,m,f,p,v,g,E,y,S,b,T,w=new Uint32Array(ne,t,4*e),R=new Uint32Array(ne,i,4*e),M=new Uint16Array(ne,n,e),I=0;I<e;I++)v=w[4*I],g=w[4*I+1],E=w[4*I+2],y=w[4*I+3],d=R[4*I],b=R[4*I+1],T=R[4*I+2],o=R[4*I+3],S=M[I],r=_,a=v,s=g,c=E,l=y,h=S,u=b,m=T,f=o,T=b=S=y=E=g=v=p=void 0,p=(o=Z)[3*(d=d)],v=o[3*d+1],g=o[3*d+2],E=o[3*u],y=o[3*u+1],S=o[3*u+2],b=o[3*m],T=o[3*m+1],d=o[3*m+2],u=o[3*f],m=o[3*f+1],f=o[3*f+2],r.faces.push(new THREE.Face3(a,s,l,[new THREE.Vector3(p,v,g),new THREE.Vector3(E,y,S),new THREE.Vector3(u,m,f)],null,h)),r.faces.push(new THREE.Face3(s,c,l,[new THREE.Vector3(E,y,S),new THREE.Vector3(b,T,d),new THREE.Vector3(u,m,f)],null,h))}THREE.Geometry.call(this),W+=(s={signature:function(e,t,i){for(var n=new Uint8Array(e,t,i),r="",o=0;o<i;o++)r+=String.fromCharCode(n[t+o]);return r}(h=ne,d=0,12),header_bytes:Y(h,d+12),vertex_coordinate_bytes:Y(h,d+13),normal_coordinate_bytes:Y(h,d+14),uv_coordinate_bytes:Y(h,d+15),vertex_index_bytes:Y(h,d+16),normal_index_bytes:Y(h,d+17),uv_index_bytes:Y(h,d+18),material_index_bytes:Y(h,d+19),nvertices:J(h,d+20),nnormals:J(h,d+20+4),nuvs:J(h,d+20+8),ntri_flat:J(h,d+20+12),ntri_smooth:J(h,d+20+16),ntri_flat_uv:J(h,d+20+20),ntri_smooth_uv:J(h,d+20+24),nquad_flat:J(h,d+20+28),nquad_smooth:J(h,d+20+32),nquad_flat_uv:J(h,d+20+36),nquad_smooth_uv:J(h,d+20+40)}).header_bytes,l=3*s.vertex_index_bytes+s.material_index_bytes,t=4*s.vertex_index_bytes+s.material_index_bytes,i=s.ntri_flat*l,n=s.ntri_smooth*(l+3*s.normal_index_bytes),r=s.ntri_flat_uv*(l+3*s.uv_index_bytes),o=s.ntri_smooth_uv*(l+3*s.normal_index_bytes+3*s.uv_index_bytes),a=s.nquad_flat*t,c=s.nquad_smooth*(t+4*s.normal_index_bytes),l=s.nquad_flat_uv*(t+4*s.uv_index_bytes),s.nquad_smooth_uv,s.normal_index_bytes,s.uv_index_bytes,W+=function(e){var t,i,n,r,o=s.nvertices,a=new Float32Array(ne,e,3*o);for(t=0;t<o;t++)i=a[3*t],n=a[3*t+1],r=a[3*t+2],_.vertices.push(new THREE.Vector3(i,n,r));return 3*o*Float32Array.BYTES_PER_ELEMENT}(W),W+=function(e){var t,i,n,r,o=s.nnormals;if(o){var a=new Int8Array(ne,e,3*o);for(t=0;t<o;t++)i=a[3*t],n=a[3*t+1],r=a[3*t+2],Z.push(i/127,n/127,r/127)}return 3*o*Int8Array.BYTES_PER_ELEMENT}(W),W+=X(3*s.nnormals),l=(c=(a=(o=(r=(n=(i=(W=W+=function(e){var t,i,n,r=s.nuvs;if(r){var o=new Float32Array(ne,e,2*r);for(t=0;t<r;t++)i=o[2*t],n=o[2*t+1],Q.push(i,n)}return 2*r*Float32Array.BYTES_PER_ELEMENT}(W))+i+X(2*s.ntri_flat))+n+X(2*s.ntri_smooth))+r+X(2*s.ntri_flat_uv))+o+X(2*s.ntri_smooth_uv))+a+X(2*s.nquad_flat))+c+X(2*s.nquad_smooth))+l+X(2*s.nquad_flat_uv),u=n,(p=s.ntri_flat_uv)&&(m=u+p*Uint32Array.BYTES_PER_ELEMENT*3,f=m+p*Uint32Array.BYTES_PER_ELEMENT*3,$(p,u,f),q(p,m)),v=r,(S=s.ntri_smooth_uv)&&(g=v+S*Uint32Array.BYTES_PER_ELEMENT*3,E=g+S*Uint32Array.BYTES_PER_ELEMENT*3,y=E+S*Uint32Array.BYTES_PER_ELEMENT*3,te(S,v,g,y),q(S,E)),b=c,(R=s.nquad_flat_uv)&&(T=b+R*Uint32Array.BYTES_PER_ELEMENT*4,w=T+R*Uint32Array.BYTES_PER_ELEMENT*4,ee(R,b,w),K(R,T)),M=l,(x=s.nquad_smooth_uv)&&(I=M+x*Uint32Array.BYTES_PER_ELEMENT*4,L=I+x*Uint32Array.BYTES_PER_ELEMENT*4,A=L+x*Uint32Array.BYTES_PER_ELEMENT*4,ie(x,M,I,A),K(x,L)),C=W,(H=s.ntri_flat)&&(D=C+H*Uint32Array.BYTES_PER_ELEMENT*3,$(H,C,D)),G=i,(k=s.ntri_smooth)&&(O=G+k*Uint32Array.BYTES_PER_ELEMENT*3,P=O+k*Uint32Array.BYTES_PER_ELEMENT*3,te(k,G,O,P)),j=o,(B=s.nquad_flat)&&(F=j+B*Uint32Array.BYTES_PER_ELEMENT*4,ee(B,j,F)),U=a,(N=s.nquad_smooth)&&(z=U+N*Uint32Array.BYTES_PER_ELEMENT*4,V=z+N*Uint32Array.BYTES_PER_ELEMENT*4,ie(N,U,z,V)),this.computeCentroids(),this.computeFaceNormals()};n.prototype=Object.create(THREE.Geometry.prototype);n=new n(t),t=this.initMaterials(i,t);this.needsTangents(t)&&n.computeTangents(),e(n,t)},THREE.CombinedCamera=function(e,t,i,n,r,o,a){THREE.Camera.call(this),this.fov=i,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.inPerspectiveMode=!0,this.inOrthographicMode=!1,this.cameraO=new THREE.OrthographicCamera(e/-2,e/2,t/2,t/-2,o,a),this.cameraP=new THREE.PerspectiveCamera(i,e/t,n,r),this.zoom=1,this.toPerspective();this.changedProjectionEvent={type:"changedProjection"}},THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inOrthographicMode&&(this.inPerspectiveMode=!0,this.inOrthographicMode=!1,this.dispatchEvent(this.changedProjectionEvent))},THREE.CombinedCamera.prototype.toOrthographic=function(){var e=this.fov,t=this.cameraP.aspect,i=(this.cameraP.near,this.cameraP.far,this.getDistanceToTarget()),i=Math.tan(THREE.Math.degToRad(e)/2)*i,t=2*i*t/2;i/=this.zoom,t/=this.zoom,this.cameraO.left=-t,this.cameraO.right=t,this.cameraO.top=i,this.cameraO.bottom=-i,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPerspectiveMode&&(this.inPerspectiveMode=!1,this.inOrthographicMode=!0,this.dispatchEvent(this.changedProjectionEvent))},THREE.CombinedCamera.prototype.setSize=function(e,t){this.cameraP.aspect=e/t,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2},THREE.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())},THREE.CombinedCamera.prototype.setLens=function(e,t){void 0===t&&(t=24);e=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(e),e},THREE.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.getDistanceToTarget=function(){return this.position.clone().sub(this.localToWorld(this.target.position.clone())).length()},THREE.CopyShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.DotScreenShader={uniforms:{tDiffuse:{type:"t",value:null},tSize:{type:"v2",value:new THREE.Vector2(256,256)},center:{type:"v2",value:new THREE.Vector2(.5,.5)},angle:{type:"f",value:1.57},scale:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},THREE.RGBShiftShader={uniforms:{tDiffuse:{type:"t",value:null},amount:{type:"f",value:.005},angle:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","}"].join("\n")},THREE.EdgeShader={uniforms:{tDiffuse:{type:"t",value:null},aspect:{type:"v2",value:new THREE.Vector2(512,512)},intensity:{type:"f",value:1},invert:{type:"f",value:1},threshold:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","uniform float intensity;","uniform float invert;","uniform float threshold;","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","mat3 G[9];","const mat3 g0 = mat3( 0.3535533845424652, 0, -0.3535533845424652, 0.5, 0, -0.5, 0.3535533845424652, 0, -0.3535533845424652 );","const mat3 g1 = mat3( 0.3535533845424652, 0.5, 0.3535533845424652, 0, 0, 0, -0.3535533845424652, -0.5, -0.3535533845424652 );","const mat3 g2 = mat3( 0, 0.3535533845424652, -0.5, -0.3535533845424652, 0, 0.3535533845424652, 0.5, -0.3535533845424652, 0 );","const mat3 g3 = mat3( 0.5, -0.3535533845424652, 0, -0.3535533845424652, 0, 0.3535533845424652, 0, 0.3535533845424652, -0.5 );","const mat3 g4 = mat3( 0, -0.5, 0, 0.5, 0, 0.5, 0, -0.5, 0 );","const mat3 g5 = mat3( -0.5, 0, 0.5, 0, 0, 0, 0.5, 0, -0.5 );","const mat3 g6 = mat3( 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.6666666865348816, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204 );","const mat3 g7 = mat3( -0.3333333432674408, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, 0.6666666865348816, 0.1666666716337204, -0.3333333432674408, 0.1666666716337204, -0.3333333432674408 );","const mat3 g8 = mat3( 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408, 0.3333333432674408 );","void main(void)","{","G[0] = g0,","G[1] = g1,","G[2] = g2,","G[3] = g3,","G[4] = g4,","G[5] = g5,","G[6] = g6,","G[7] = g7,","G[8] = g8;","mat3 I;","float cnv[9];","vec3 sample;","for (float i=0.0; i<3.0; i++) {","for (float j=0.0; j<3.0; j++) {","sample = texture2D(tDiffuse, vUv + texel * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","}","for (int i=0; i<9; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3;","}","float M = (cnv[0] + cnv[1]) + (cnv[2] + cnv[3]);","float S = (cnv[4] + cnv[5]) + (cnv[6] + cnv[7]) + (cnv[8] + M);","float rgb = smoothstep(threshold,1.0,sqrt(M/S) * intensity);","if(invert > 0.5){","gl_FragColor = vec4(vec3(1) - vec3(rgb), 1.0);","} else {","gl_FragColor = vec4(vec3(rgb), 1.0);","}","}"].join("\n")},THREE.EdgeShader2={uniforms:{tDiffuse:{type:"t",value:null},aspect:{type:"v2",value:new THREE.Vector2(512,512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","uniform vec2 aspect;","vec2 texel = vec2(1.0 / aspect.x, 1.0 / aspect.y);","mat3 G[2];","const mat3 g0 = mat3( 1.0, 2.0, 1.0, 0.0, 0.0, 0.0, -1.0, -2.0, -1.0 );","const mat3 g1 = mat3( 1.0, 0.0, -1.0, 2.0, 0.0, -2.0, 1.0, 0.0, -1.0 );","void main(void)","{","mat3 I;","float cnv[2];","vec3 sample;","G[0] = g0;","G[1] = g1;","for (float i=0.0; i<3.0; i++)","for (float j=0.0; j<3.0; j++) {","sample = texture2D( tDiffuse, vUv + texel * vec2(i-1.0,j-1.0) ).rgb;","I[int(i)][int(j)] = length(sample);","}","for (int i=0; i<2; i++) {","float dp3 = dot(G[i][0], I[0]) + dot(G[i][1], I[1]) + dot(G[i][2], I[2]);","cnv[i] = dp3 * dp3; ","}","gl_FragColor = vec4(0.5 * sqrt(cnv[0]*cnv[0]+cnv[1]*cnv[1]));","} "].join("\n")},THREE.SSAOShader={uniforms:{tDiffuse:{type:"t",value:null},tDepth:{type:"t",value:null},size:{type:"v2",value:new THREE.Vector2(512,512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},fogNear:{type:"f",value:5},fogFar:{type:"f",value:100},fogEnabled:{type:"i",value:0},onlyAO:{type:"i",value:0},aoClamp:{type:"f",value:.3},lumInfluence:{type:"f",value:.9}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform float fogNear;","uniform float fogFar;","uniform bool fogEnabled;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","const int samples = 8;","const float radius = 5.0;","const bool useNoise = false;","const float noiseAmount = 0.0003;","const float diffArea = 0.4;","const float gDisplace = 0.4;","const vec3 onlyAOColor = vec3( 1.0, 0.7, 0.5 );","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float doFog() {","float zdepth = unpackDepth( texture2D( tDepth, vUv ) );","float depth = -cameraFar * cameraNear / ( zdepth * cameraFarMinusNear - cameraFar );","return smoothstep( fogNear, fogFar, depth );","}","float readDepth( const in vec2 coord ) {","return cameraCoef / ( cameraFarPlusNear - unpackDepth( texture2D( tDepth, coord ) ) * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 2.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw;","float ph;","float ao;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","if ( fogEnabled ) {","ao = mix( ao, 1.0, doFog() );","}","vec3 color = texture2D( tDiffuse, vUv ).rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = onlyAOColor * vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, 1.0 );","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec3 rgbA = texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz;","rgbA += texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz;","rgbA *= 0.5;","vec3 rgbB = texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz;","rgbB += texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz;","rgbB *= 0.25;","rgbB += rgbA * 0.5;","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")},THREE.UnpackDepthRGBAShader={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","void main() {","float depth = 1.0 - unpackDepth( texture2D( tDiffuse, vUv ) );","gl_FragColor = opacity * vec4( vec3( depth ), 1.0 );","}"].join("\n")},THREE.EffectComposer=function(e,t){var i,n;this.renderer=e,void 0===t&&(i=window.innerWidth||1,n=window.innerHeight||1,e={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1},t=new THREE.WebGLRenderTarget(i,n,e)),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},THREE.EffectComposer.prototype={swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;for(var t,i,n=!1,r=this.passes.length,o=0;o<r;o++)(i=this.passes[o]).enabled&&(i.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),i.needsSwap&&(n&&((t=this.renderer.context).stencilFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),t.stencilFunc(t.EQUAL,1,4294967295)),this.swapBuffers()),i instanceof THREE.MaskPass?n=!0:i instanceof THREE.ClearMaskPass&&(n=!1))},reset:function(e){void 0===e&&((e=this.renderTarget1.clone()).width=window.innerWidth,e.height=window.innerHeight),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){var i=this.renderTarget1.clone();i.width=e,i.height=t,this.reset(i)}},THREE.EffectComposer.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),THREE.EffectComposer.quad=new THREE.Mesh(new THREE.PlaneGeometry(2,2),null),THREE.EffectComposer.scene=new THREE.Scene,THREE.EffectComposer.scene.add(THREE.EffectComposer.quad),THREE.RenderPass=function(e,t,i,n,r){this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=void 0!==r?r:1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.enabled=!0,this.clear=!0,this.needsSwap=!1},THREE.RenderPass.prototype={render:function(e,t,i,n){this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.render(this.scene,this.camera,i,this.clear),this.clearColor&&e.setClearColor(this.oldClearColor,this.oldClearAlpha),this.scene.overrideMaterial=null}},THREE.MaskPass=function(e,t){this.scene=e,this.camera=t,this.enabled=!0,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype={render:function(e,t,i,n){var r,o,a=e.context;a.colorMask(!1,!1,!1,!1),a.depthMask(!1),o=this.inverse?(r=0,1):(r=1,0),a.enable(a.STENCIL_TEST),a.stencilOp(a.REPLACE,a.REPLACE,a.REPLACE),a.stencilFunc(a.ALWAYS,r,4294967295),a.clearStencil(o),e.render(this.scene,this.camera,i,this.clear),e.render(this.scene,this.camera,t,this.clear),a.colorMask(!0,!0,!0,!0),a.depthMask(!0),a.stencilFunc(a.EQUAL,1,4294967295),a.stencilOp(a.KEEP,a.KEEP,a.KEEP)}},THREE.ClearMaskPass=function(){this.enabled=!0},THREE.ClearMaskPass.prototype={render:function(e,t,i,n){e=e.context;e.disable(e.STENCIL_TEST)}},THREE.ShaderPass=function(e,t){this.textureID=void 0!==t?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1},THREE.ShaderPass.prototype={render:function(e,t,i,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i),THREE.EffectComposer.quad.material=this.material,this.renderToScreen?e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera):e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,t,this.clear)}},void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var TWEEN=TWEEN||function(){var i=[];return{REVISION:"12",getAll:function(){return i},removeAll:function(){i=[]},add:function(e){i.push(e)},remove:function(e){-1!==(e=i.indexOf(e))&&i.splice(e,1)},update:function(e){if(0===i.length)return!1;for(var t=0,e=void 0!==e?e:("undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance:Date).now();t<i.length;)i[t].update(e)?t++:i.splice(t,1);return!0}}}();TWEEN.Tween=function(a){var e,s={},c={},l={},h=1e3,d=0,u=!1,i=!1,m=0,f=null,p=TWEEN.Easing.Linear.None,v=TWEEN.Interpolation.Linear,g=[],E=null,y=!1,S=null,b=null;for(e in a)s[e]=parseFloat(a[e],10);this.to=function(e,t){return void 0!==t&&(h=t),c=e,this},this.start=function(e){for(var t in TWEEN.add(this),y=!(i=!0),f=void 0!==e?e:("undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance:Date).now(),f+=m,c){if(c[t]instanceof Array){if(0===c[t].length)continue;c[t]=[a[t]].concat(c[t])}s[t]=a[t],!1==s[t]instanceof Array&&(s[t]*=1),l[t]=s[t]||0}return this},this.stop=function(){return i&&(TWEEN.remove(this),i=!1,this.stopChainedTweens()),this},this.stopChainedTweens=function(){for(var e=0,t=g.length;e<t;e++)g[e].stop()},this.delay=function(e){return m=e,this},this.repeat=function(e){return d=e,this},this.yoyo=function(e){return u=e,this},this.easing=function(e){return p=e,this},this.interpolation=function(e){return v=e,this},this.chain=function(){return g=arguments,this},this.onStart=function(e){return E=e,this},this.onUpdate=function(e){return S=e,this},this.onComplete=function(e){return b=e,this},this.update=function(e){if(e<f)return!0;!1===y&&(null!==E&&E.call(a),y=!0);var t=(e-f)/h,i=p(t=1<t?1:t);for(var n in c){var r=s[n]||0,o=c[n];o instanceof Array?a[n]=v(o,i):("string"==typeof o&&(o=r+parseFloat(o,10)),"number"==typeof o&&(a[n]=r+(o-r)*i))}if(null!==S&&S.call(a,i),1==t){if(!(0<d)){for(null!==b&&b.call(a),n=0,t=g.length;n<t;n++)g[n].start(e);return!1}for(n in isFinite(d)&&d--,l)"string"==typeof c[n]&&(l[n]+=parseFloat(c[n],10)),u&&(t=l[n],l[n]=c[n],c[n]=t),s[n]=l[n];f=e+m}return!0}},TWEEN.Easing={Linear:{None:function(e){return e}},Quadratic:{In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}},Cubic:{In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}},Quartic:{In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}},Quintic:{In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}},Sinusoidal:{In:function(e){return 1-Math.cos(e*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.cos(Math.PI*e))}},Exponential:{In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}},Circular:{In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}},Elastic:{In:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),-(i*Math.pow(2,10*--e)*Math.sin(2*(e-t)*Math.PI/.4)))},Out:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)},InOut:function(e){var t,i=.1;return 0===e?0:1===e?1:(t=!i||i<1?(i=1,.1):.4*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?-.5*i*Math.pow(2,10*--e)*Math.sin(2*(e-t)*Math.PI/.4):.5*i*Math.pow(2,-10*--e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}},Back:{In:function(e){return e*e*(2.70158*e-1.70158)},Out:function(e){return--e*e*(2.70158*e+1.70158)+1},InOut:function(e){return(e*=2)<1?.5*e*e*(3.5949095*e-2.5949095):.5*((e-=2)*e*(3.5949095*e+2.5949095)+2)}},Bounce:{In:function(e){return 1-TWEEN.Easing.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*TWEEN.Easing.Bounce.In(2*e):.5*TWEEN.Easing.Bounce.Out(2*e-1)+.5}}},TWEEN.Interpolation={Linear:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),o=TWEEN.Interpolation.Utils.Linear;return t<0?o(e[0],e[1],n):1<t?o(e[i],e[i-1],i-n):o(e[r],e[i<r+1?i:r+1],n-r)},Bezier:function(e,t){for(var i=0,n=e.length-1,r=Math.pow,o=TWEEN.Interpolation.Utils.Bernstein,a=0;a<=n;a++)i+=r(1-t,n-a)*r(t,a)*e[a]*o(n,a);return i},CatmullRom:function(e,t){var i=e.length-1,n=i*t,r=Math.floor(n),o=TWEEN.Interpolation.Utils.CatmullRom;return e[0]===e[i]?(t<0&&(r=Math.floor(n=i*(1+t))),o(e[(r-1+i)%i],e[r],e[(r+1)%i],e[(r+2)%i],n-r)):t<0?e[0]-(o(e[0],e[0],e[1],e[1],-n)-e[0]):1<t?e[i]-(o(e[i],e[i],e[i-1],e[i-1],n-i)-e[i]):o(e[r?r-1:0],e[r],e[i<r+1?i:r+1],e[i<r+2?i:r+2],n-r)},Utils:{Linear:function(e,t,i){return(t-e)*i+e},Bernstein:function(e,t){var i=TWEEN.Interpolation.Utils.Factorial;return i(e)/i(t)/i(e-t)},Factorial:function(){var n=[1];return function(e){var t,i=1;if(n[e])return n[e];for(t=e;1<t;t--)i*=t;return n[e]=i}}(),CatmullRom:function(e,t,i,n,r){var o=r*r;return(2*t-2*i+(e=.5*(i-e))+(n=.5*(n-t)))*r*o+(-3*t+3*i-2*e-n)*o+e*r+t}}},GIScene.Coordinate2=function(e,t){THREE.Vector2.apply(this,[e,t])},GIScene.Coordinate2.prototype=Object.create(THREE.Vector2.prototype),GIScene.Coordinate2.prototype.toVector2=function(){return new THREE.Vector2(this.x,-this.y)},GIScene.Coordinate2.prototype.fromVector2=function(e){return this.x=e.x,this.y=-e.y,this},GIScene.Coordinate2.prototype.clone=function(){return new GIScene.Coordinate2(this.x,this.y)},GIScene.Coordinate3=function(e,t,i){THREE.Vector3.apply(this,[e,t,i])},GIScene.Coordinate3.prototype=Object.create(THREE.Vector3.prototype),GIScene.Coordinate3.prototype.toVector3=function(){return new THREE.Vector3(this.x,this.z,-this.y)},GIScene.Coordinate3.prototype.fromVector3=function(e){return this.x=e.x,this.y=-e.z,this.z=e.y,this},GIScene.Coordinate3.prototype.clone=function(){return new GIScene.Coordinate3(this.x,this.y,this.z)},GIScene.Extent2=function(e,t){THREE.Box2.apply(this,[e,t])},GIScene.Extent2.prototype=Object.create(THREE.Box2.prototype),GIScene.Extent2.prototype.toPolygonV2=function(){var e=this.min,t=this.max;return[new GIScene.Coordinate2(e.x,e.y),new GIScene.Coordinate2(t.x,e.y),new GIScene.Coordinate2(t.x,t.y),new GIScene.Coordinate2(e.x,t.y)]},GIScene.Extent2.prototype.fromBox3=function(e){return this.min=new GIScene.Coordinate2(e.min.x,-e.max.z),this.max=new GIScene.Coordinate2(e.max.x,-e.min.z),this},GIScene.Extent2.prototype.clone=function(){return new GIScene.Extent2(this.min,this.max)},GIScene.Line2=function(e,t){this.positionVector=e,this.directionVector=t},GIScene.Line2.prototype.getNormalizedNormalRight=function(){return new THREE.Vector2(-this.directionVector.y,this.directionVector.x).normalize()},GIScene.Line2.prototype.getNormalizedNormalLeft=function(){return new THREE.Vector2(this.directionVector.y,-this.directionVector.x).normalize()},GIScene.Line2.prototype.fromPoints=function(e,t){return this.positionVector=e.clone(),this.directionVector=t.clone().sub(e),this},GIScene.Line2.prototype.intersect=function(e){var t=this.directionVector,i=e.directionVector,n=this.positionVector,r=e.positionVector,o=t.x,a=-i.x,s=r.x-n.x,c=t.y,l=-i.y,e=r.y-n.y;0==o&&(i=o,r=a,h=s,o=c,a=l,s=e,c=i,l=r,e=h),s/=o,a/=o;var h=-c;return c+=(o=1)*h,e+=s*h,s+=(e*=h=1/(l+=a*h))*(h=-a),n.add(t.multiplyScalar(s))},GIScene.Line2.prototype.moveLeft=function(e){var t=this.getNormalizedNormalLeft();return this.positionVector=this.positionVector.add(t.multiplyScalar(e)),this},GIScene.Line2.prototype.moveRight=function(e){var t=this.getNormalizedNormalRight();return this.positionVector=this.positionVector.add(t.multiplyScalar(e)),this},GIScene.Utils={WorkingMaterial:{setFlag:function(e,t,i,n){if("default"==i)e.userData.workingMaterialFlags&=~n;else if("materials"in e.material){for(var r=null,o=1;o<e.userData.originalMaterial.materials.length&&(r=i instanceof THREE.Color?e.userData.originalMaterial.materials[0][t].equals(e.userData.originalMaterial.materials[o][t]):e.userData.originalMaterial.materials[0][t]==e.userData.originalMaterial.materials[o][t]);o++);r?i instanceof THREE.Color?i.equals(e.userData.originalMaterial.materials[0][t])?e.userData.workingMaterialFlags&=~n:e.userData.workingMaterialFlags|=n:i!=e.userData.originalMaterial.materials[0][t]?e.userData.workingMaterialFlags|=n:e.userData.workingMaterialFlags&=~n:e.userData.workingMaterialFlags|=n}else i instanceof THREE.Color?i.equals(e.userData.originalMaterial[t])?e.userData.workingMaterialFlags&=~n:e.userData.workingMaterialFlags|=n:i!=e.userData.originalMaterial[t]?e.userData.workingMaterialFlags|=n:e.userData.workingMaterialFlags&=~n},isSetFlag:function(e,t){return"workingMaterialFlags"in e.userData&&!!(e.userData.workingMaterialFlags&t)},getValues:function(e){var t={};return GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.SELECT)&&(t.setSelectColor=e.material.emissive.clone()),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.WIRE)&&(t.setWireframe=e.material.wireframe),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.SHADING)&&(t.setShading=e.material.shading),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.SIDE)&&(t.setFaceCulling=e.material.side),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.MAP)&&(t.setTexturing=!1),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.OPACITY)&&(t.setOpacity=e.material.opacity),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.VERTEXCOLORS)&&(t.setVertexColors=e.material.vertexColors),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.DIFFUSE)&&(t.setDiffuseColor=e.material.color.clone()),GIScene.Utils.WorkingMaterial.isSetFlag(e,GIScene.WORKINGMATERIALFLAGS.AMBIENT)&&(t.setAmbientColor=e.material.ambient.clone()),t},setValues:function(e,t){for(value in t)GIScene.Utils.WorkingMaterial[value](e,t[value])},setWireframe:function(n,r){n.material&&!(n instanceof THREE.Sprite||n instanceof THREE.PointCloud)&&(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"wireframe",r,GIScene.WORKINGMATERIALFLAGS.WIRE),"materials"in n.material?n.material.materials.forEach(function(e,t,i){i[t].wireframe="default"==r?n.userData.originalMaterial.materials[t].wireframe:r}):n.material.wireframe="default"==r?n.userData.originalMaterial.wireframe:r,0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial))},setTexturing:function(r,o){if(r.material&&!(r instanceof THREE.Sprite||r instanceof THREE.PointCloud)){var e,t;switch(r.userData.originalMaterial||(r.userData.originalMaterial=r.material,r.material=r.userData.originalMaterial.clone(),r.userData.workingMaterialFlags=0),o){case"default":e="default";break;case!0:o=e="default";break;case!1:e=null;break;default:console.log("'setTexturing':  No such texturingMode: "+o)}GIScene.Utils.WorkingMaterial.setFlag(r,"map",e,GIScene.WORKINGMATERIALFLAGS.MAP),"materials"in r.material?r.material.materials.forEach(function(e,t,i){var n=("default"==o?!!r.userData.originalMaterial.materials[t].map:o)&&r.userData.originalMaterial.materials[t].map?r.userData.originalMaterial.materials[t].map.clone():null;i[t].map=n,null!=i[t].map&&(i[t].map.needsUpdate=!0),i[t].needsUpdate=!0}):(t=("default"==o?!!r.userData.originalMaterial.map:o)&&r.userData.originalMaterial.map?r.userData.originalMaterial.map.clone():null,r.material.map=t,null!=r.material.map&&(r.material.map.needsUpdate=!0),r.material.needsUpdate=!0),0==r.userData.workingMaterialFlags&&(r.material=r.userData.originalMaterial,r.userData.originalMaterial=null,delete r.userData.originalMaterial)}},setFaceCulling:function(r,o){function a(e,t){e.side=t,e.needsUpdate=!0}var e;r.material&&!(r instanceof THREE.Sprite||r instanceof THREE.PointCloud)&&(r.userData.originalMaterial||(r.userData.originalMaterial=r.material,r.material=r.userData.originalMaterial.clone(),r.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(r,"side",o,GIScene.WORKINGMATERIALFLAGS.SIDE),"materials"in r.material?r.material.materials.forEach(function(e,t,i){var n;n="default"==o?r.userData.originalMaterial.materials[t].side:o,a(i[t],n)}):(e="default"==o?r.userData.originalMaterial.side:o,a(r.material,e)),0==r.userData.workingMaterialFlags&&(r.material=r.userData.originalMaterial,r.userData.originalMaterial=null,delete r.userData.originalMaterial))},setVertexColors:function(n,r){n.material&&!(n instanceof THREE.Sprite||n instanceof THREE.PointCloud)&&(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"vertexColors",r,GIScene.WORKINGMATERIALFLAGS.VERTEXCOLORS),"materials"in n.material?n.material.materials.forEach(function(e,t,i){"default"==r?(i[t].vertexColors=n.userData.originalMaterial.materials[t].vertexColors,i[t].color=n.userData.originalMaterial.materials[t].color,i[t].ambient=n.userData.originalMaterial.materials[t].ambient,i[t].needsUpdate=!0):0<n.geometry.faces[0].vertexColors.length&&((i[t].vertexColors=r)==THREE.NoColors?(i[t].color=new THREE.Color(16777215),i[t].ambient=new THREE.Color(10066329)):(i[t].color=new THREE.Color(16777215),i[t].ambient=new THREE.Color(16777215)),i[t].needsUpdate=!0)}):"default"==r?(n.material.vertexColors=n.userData.originalMaterial.vertexColors,n.material.color=n.userData.originalMaterial.color,n.material.ambient=n.userData.originalMaterial.ambient,n.material.needsUpdate=!0):0<n.geometry.faces[0].vertexColors.length&&((n.material.vertexColors=r)==THREE.NoColors?(n.material.color=new THREE.Color(16777215),n.material.ambient=new THREE.Color(10066329)):(n.material.color=new THREE.Color(16777215),n.material.ambient=new THREE.Color(16777215)),n.material.needsUpdate=!0),0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial))},setShading:function(n,r){if(n.material&&!(n instanceof THREE.Sprite||n instanceof THREE.PointCloud)){if(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"shading",r,GIScene.WORKINGMATERIALFLAGS.SHADING),!("originalVertexNormals"in n.userData)){n.userData.originalVertexNormals=[];for(var e=0,t=n.geometry.faces.length;e<t;e++)0!=n.geometry.faces[e].vertexNormals.length&&(n.userData.originalVertexNormals[n.geometry.faces[e].a]=n.geometry.faces[e].vertexNormals[0].clone(),n.userData.originalVertexNormals[n.geometry.faces[e].b]=n.geometry.faces[e].vertexNormals[1].clone(),n.userData.originalVertexNormals[n.geometry.faces[e].c]=n.geometry.faces[e].vertexNormals[2].clone())}if("default"==r){for(e=0,t=n.geometry.faces.length;e<t;e++)null==n.userData.originalVertexNormals[n.geometry.faces[e].a]?n.geometry.faces[e].vertexNormals=[]:(n.geometry.faces[e].vertexNormals[0]=n.userData.originalVertexNormals[n.geometry.faces[e].a],n.geometry.faces[e].vertexNormals[1]=n.userData.originalVertexNormals[n.geometry.faces[e].b],n.geometry.faces[e].vertexNormals[2]=n.userData.originalVertexNormals[n.geometry.faces[e].c]);n.geometry.__tmpVertices=void 0,delete n.userData.originalVertexNormals,"materials"in n.material?n.material.materials.forEach(function(e,t,i){i[t].shading=n.userData.originalMaterial.materials[t].shading,n.geometry.normalsNeedUpdate=!0,i[t].needsUpdate=!0}):(n.material.shading=n.userData.originalMaterial.shading,n.geometry.normalsNeedUpdate=!0,n.material.needsUpdate=!0)}else 0==n.geometry.faces[0].vertexNormals.length&&n.geometry.computeVertexNormals(),"materials"in n.material?n.material.materials.forEach(function(e,t,i){i[t].shading=r,n.geometry.normalsNeedUpdate=!0,i[t].needsUpdate=!0}):(n.material.shading=r,n.geometry.normalsNeedUpdate=!0,n.material.needsUpdate=!0);0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial)}},setDiffuseColor:function(n,r){n.material&&!(n instanceof THREE.Sprite||n instanceof THREE.PointCloud)&&(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"color",r,GIScene.WORKINGMATERIALFLAGS.DIFFUSE),"materials"in n.material?n.material.materials.forEach(function(e,t,i){i[t].color="default"==r?n.userData.originalMaterial.materials[t].color:r}):n.material.color="default"==r?n.userData.originalMaterial.color:r,0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial))},setAmbientColor:function(n,r){n.material&&!(n instanceof THREE.Sprite||n instanceof THREE.PointCloud)&&(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"ambient",r,GIScene.WORKINGMATERIALFLAGS.AMBIENT),"materials"in n.material?n.material.materials.forEach(function(e,t,i){i[t].ambient="default"==r?n.userData.originalMaterial.materials[t].ambient:r}):n.material.ambient="default"==r?n.userData.originalMaterial.ambient:r,0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial))},setSelectColor:function(n,r){n.material&&!(n instanceof THREE.Sprite||n instanceof THREE.PointCloud)&&(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"emissive",r,GIScene.WORKINGMATERIALFLAGS.SELECT),"materials"in n.material?n.material.materials.forEach(function(e,t,i){"emissive"in i[t]&&(i[t].emissive="default"==r?n.userData.originalMaterial.materials[t].emissive:r)}):"emissive"in n.material&&(n.material.emissive="default"==r?n.userData.originalMaterial.emissive:r),0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial))},setOpacity:function(n,r){n.material&&(n.userData.originalMaterial||(n.userData.originalMaterial=n.material,n.material=n.userData.originalMaterial.clone(),n.userData.workingMaterialFlags=0),GIScene.Utils.WorkingMaterial.setFlag(n,"opacity",r,GIScene.WORKINGMATERIALFLAGS.OPACITY),"materials"in n.material?n.material.materials.forEach(function(e,t,i){"default"==r?(i[t].opacity=n.userData.originalMaterial.materials[t].opacity,i[t].transparent=n.userData.originalMaterial.materials[t].transparent,i[t].depthTest=n.userData.originalMaterial.materials[t].depthTest):(i[t].opacity=r*n.userData.originalMaterial.materials[t].opacity,i[t].transparent=i[t].opacity<1,i[t].depthTest=!(i[t].opacity<1))}):"default"==r?(n.material.opacity=n.userData.originalMaterial.opacity,n.material.transparent=n.userData.originalMaterial.transparent,n.material.depthTest=n.userData.originalMaterial.depthTest):(n.material.opacity=r*n.userData.originalMaterial.opacity,n.material.transparent=n.material.opacity<1,n.material.depthTest=!(n.material.opacity<1)),0==n.userData.workingMaterialFlags&&(n.material=n.userData.originalMaterial,n.userData.originalMaterial=null,delete n.userData.originalMaterial))}},mergeObjects:function(e,t){var i,n={};for(i in e)n[i]=e[i];for(i in t)n[i]=t[i];return n},getRelativeScreenCoordsFromDOMEvent:function(e,t){var i=new THREE.Vector2,e=e.getBoundingClientRect();return i.x=t.clientX-e.left,i.y=t.clientY-e.top,i},getViewportCoordsFromDOMEvent:function(e,t){t=GIScene.Utils.getRelativeScreenCoordsFromDOMEvent(e,t);return GIScene.Utils.transformRelativeScreenCoordsToViewportCoords(t,e.offsetWidth,e.offsetHeight)},transformRelativeScreenCoordsToViewportCoords:function(e,t,i){var n=new THREE.Vector2;return n.x=e.x/t*2-1,n.y=-e.y/i*2+1,n},transformViewportCoordsToRelativeScreenCoords:function(e,t,i){var n=new THREE.Vector2;return n.x=(e.x+1)/2*t,n.y=(e.y-1)/-2*i,n},computeBoundingBoxRecursive:function(e){return console.log("Deprecated: GIScene.Utils.computeBoundingBoxRecursive(). Use THREE.Box3().setFromObject(obj)"),(new THREE.Box3).setFromObject(e)},computeVertexMeanRecursive:function(e){var t=[];e.traverse(function(e){"geometry"in e&&t.push.apply(t,e.geometry.vertices)});for(var i=new THREE.Vector3,n=0;n<t.length;n++)i=i.add(t[0]);return i.divideScalar(t.length)},polarTransformationAddAngle:function(e,t,i,n){var i=THREE.Math.degToRad(i),n=THREE.Math.degToRad(n),r=t.clone().sub(e),o=Math.atan2(r.x,r.z),a=Math.atan2(Math.sqrt(r.x*r.x+r.z*r.z),r.y);o+=i,a+=n;n=r.length();return r.x=n*Math.sin(a)*Math.sin(o),r.y=n*Math.cos(a),r.z=n*Math.sin(a)*Math.cos(o),t.copy(e).add(r),t},translatePositionToBBoxCenter:function(e){var t;e.geometry&&e.geometry.boundingBox&&(t=e.geometry.boundingBox.center().sub(e.position),e.position.add(t),e.geometry.vertices.forEach(function(e){e.sub(t)}),e.geometry.verticesNeedUpdate=!0)},calcRenderDepthMinusBSphereRadius:function(e,t){var i=new THREE.Vector3,n=new THREE.Matrix4;return i.setFromMatrixPosition(e.matrixWorld),n.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),i.applyProjection(n),i.z-e.geometry.boundingSphere.radius},getOrthoParamsFromPerspectiveCam:function(e,t,i){var n=t.fov,i=i||(t.near+t.far)/2,r=t.aspect,r=this.getOrthoSizeFromFovDistanceAspect(n,i,r);return r.near=t.near,r.far=t.far,r},getOrthoSizeFromFovDistanceAspect:function(e,t,i){var n={},t=Math.tan(THREE.Math.degToRad(e)/2)*t,i=2*t*i/2;return n.left=-i,n.right=i,n.top=t,n.bottom=-t,n},getPerspectiveDistanceFromFovHalfHeight:function(e,t){return t/Math.tan(THREE.Math.degToRad(e)/2)},arrayContains:function(e,t){for(var i=0,n=e.length;i<n;i++)if(e[i]===t)return!0},removeDuplicatesFromArray:function(e){var t={};return e.filter(function(e){e=JSON.stringify(e);return 1===t[e]?0:t[e]=1})},vector3ToVector2:function(e){return new THREE.Vector2(e.x,e.z)},vector2ToVector3:function(e,t){return new THREE.Vector3(e.x,t,e.y)},disposeObject:function(e,n,r,o,t){var i=[],a=[];t&&((t=e.getDescendants()).push(e),t.forEach(function(e,t,i){GIScene.Utils.disposeObject(e,n,r,o,!1)}.bind(this))),n&&e.geometry&&(e.geometry.dispose(),delete e.geometry),r&&(e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(i,e)||i.push(e)}):GIScene.Utils.arrayContains(i,e.material)||i.push(e.material)),delete e.material,o&&i.forEach(function(e){for(var t=["map","lightMap","bumpMap","normalMap","specularMap","envMap"],i=0,n=t.length;i<n;i++)e[t[i]]&&null!=e[t[i]]&&!GIScene.Utils.arrayContains(a,e[t[i]])&&(a.push(e[t[i]]),e[t[i]]=null)})),n&&(e.dispose&&e.dispose(),e=null),a.forEach(function(e){e.dispose()}),a=null,i.forEach(function(e){e.dispose()}),i=null},equalsTypeOrClass:function(valueOrObject,typeOrClassName){var check;if("object"==typeof valueOrObject){console.log("object");try{check=valueOrObject instanceof eval(typeOrClassName)}catch(e){check="object"==typeOrClassName.toLowerCase()}}else{console.log("primitive");var check=typeof valueOrObject===typeOrClassName.toLowerCase()}return check},getObjectsBy:function(e,t){var i=[];return e.traverse(function(e){t(e)&&i.push(e)}),i}},GIScene.DirectionMaterial=function(e,t){e=e||new THREE.Vector3(0,0,-1),t=t||15,t={shading:THREE.SmoothShading,uniforms:{opacity:{type:"f",value:1},direction:{type:"v3",value:e},maxDeviationDeg:{type:"f",value:t}},vertexShader:["varying vec3 vNormal;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize(  normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform vec3 direction;","uniform float maxDeviationDeg;","varying vec3 vNormal;","float red;","float maxDeviation;","const float M_PI = 3.14159265358979323846;","uniform mat4 modelMatrix;","void main() {","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * vNormal;","worldNormal = normalize( worldNormal );","maxDeviation = maxDeviationDeg * (M_PI / 180.0);","red = (maxDeviation - acos(dot(worldNormal, direction))) / maxDeviation;","gl_FragColor = vec4( 1.0,1.0-red,1.0-red, opacity );","}"].join("\n")};THREE.ShaderMaterial.call(this,t)},GIScene.DirectionMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.AspectMaterial=function(e,t){var i,n,r=new THREE.Color(0);Object.defineProperty(this,"compassDirection",{get:function(){return i},set:function(e){i=e,this.uniforms.compassDirection.value=e}}),Object.defineProperty(this,"maxDeviationDeg",{get:function(){return n},set:function(e){n=e,this.uniforms.maxDeviationDeg.value=e}}),Object.defineProperty(this,"emissive",{get:function(){return r},set:function(e){r=e,this.uniforms.uemissive.value=e}});var o={shading:THREE.SmoothShading,uniforms:{opacity:{type:"f",value:1},compassDirection:{type:"v3",value:e},maxDeviationDeg:{type:"f",value:t},uemissive:{type:"c",value:this.emissive}},vertexShader:["varying vec3 vNormal;","uniform vec3 uemissive;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize(  normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","uniform vec3 compassDirection;","uniform float maxDeviationDeg;","uniform vec3 uemissive;","varying vec3 vNormal;","float red;","float maxDeviation;","const float M_PI = 3.14159265358979323846;","vec3 hDir;","uniform mat4 modelMatrix;","void main() {","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * vNormal;","worldNormal = normalize( worldNormal );","maxDeviation = maxDeviationDeg * (M_PI / 180.0);","hDir = worldNormal -  ( dot(worldNormal, vec3(0.0,1.0,0.0)) * vec3(0.0,1.0,0.0));","hDir = normalize(hDir);","float upDeviation = acos(dot(normalize(worldNormal), vec3(0.0,1.0,0.0)));","if (upDeviation < 0.017453292519943295 || upDeviation > M_PI - 0.017453292519943295)","{","gl_FragColor = vec4( vec3(0.5) + uemissive, opacity );","}","else {","red = (maxDeviation - acos(dot(hDir, compassDirection))) / maxDeviation;","gl_FragColor = vec4( vec3(1.0,1.0-red,1.0-red) + uemissive, opacity );","}","}"].join("\n")};THREE.ShaderMaterial.call(this,o),this.compassDirection=e||new THREE.Vector3(0,0,-1),this.maxDeviationDeg=t||15,this.emissive=new THREE.Color(0)},GIScene.AspectMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.AspectMaterial.prototype.clone=function(){var e=new GIScene.AspectMaterial;return THREE.ShaderMaterial.prototype.clone.call(this,e),e.compassDirection=this.compassDirection,e.emissive=this.emissive,e},GIScene.DistanceOpacityMaterial=function(e,t){e=e||15,t=t||30,t={transparent:!0,lights:!0,side:2,uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(11184810)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},mNear:{type:"f",value:e},mFar:{type:"f",value:t}}]),vertexShader:["#define LAMBERT","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_lambert_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"float depth_ = gl_FragCoord.z / gl_FragCoord.w;","float distOpacity = smoothstep( mNear, mFar, depth_ );","gl_FragColor = vec4( gl_FragColor.rgb, distOpacity );","if (distOpacity < 0.01) discard;","}"].join("\n")};THREE.ShaderMaterial.call(this,t)},GIScene.DistanceOpacityMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.RasterOverlayMaterial=function(e){var t={texture:null,url:null,crossOrigin:"anonymous",lowerLeft:new GIScene.Coordinate2(-100,-100),upperRight:new GIScene.Coordinate2(100,100),offset2:null,isShared:!0,emissive:new THREE.Color(0)};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.url=this.config.url,this.crossOrigin=this.config.crossOrigin,this.offset2=this.config.offset2||new GIScene.Coordinate2(0,0),this.lowerLeft=this.config.lowerLeft.sub(this.offset2)||new GIScene.Coordinate2(-100,-100),this.upperRight=this.config.upperRight.sub(this.offset2)||new GIScene.Coordinate2(100,100),this.texture=this.config.texture||new THREE.Texture,this.isShared=this.config.isShared;var i=this.config.emissive;Object.defineProperty(this,"emissive",{get:function(){return console.log("get! emissive"),i},set:function(e){i=e,this.uniforms.emissive.value=e}}),this.url&&this.setTextureFromUrl(this.url,this.crossOrigin);e={transparent:!0,lights:!0,side:0,shading:THREE.SmoothShading,uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{diffuse:{type:"c",value:new THREE.Color(3555870)},ambient:{type:"c",value:new THREE.Color(3555870)},emissive:{type:"c",value:this.emissive},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},tOverlay:{type:"t",value:this.texture},lowerLeft:{type:"v2",value:this.lowerLeft},upperRight:{type:"v2",value:this.upperRight}}]),vertexShader:["varying vec3 vWorldPosition;","#define LAMBERT","varying vec3 vLightFront;","varying vec3 vLightingOnly;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,"vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );","if ( spotEffect > spotLightAngleCos[ i ] ) {","spotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_HEMI_LIGHTS > 0","for( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );","vec3 lVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, lVector );","float hemiDiffuseWeight = 0.5 * dotProduct + 0.5;","float hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;","vLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );","#ifdef DOUBLE_SIDED","vLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );","#endif","}","#endif","vLightingOnly = vLightFront;","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif",THREE.ShaderChunk.shadowmap_vertex,"vWorldPosition = worldPosition.xyz;","}"].join("\n"),fragmentShader:["varying vec3 vWorldPosition;","uniform vec2 lowerLeft;","uniform vec2 upperRight;","uniform sampler2D tOverlay;","uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","uniform float opacity;","varying vec3 vLightFront;","varying vec3 vLightingOnly;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk.lightmap_fragment,"#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif",THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"if(vWorldPosition.x >= lowerLeft.x && vWorldPosition.x <= upperRight.x && -vWorldPosition.z >= lowerLeft.y && -vWorldPosition.z <= upperRight.y)","{","vec2 worldPosGeo = vec2(vWorldPosition.x, -vWorldPosition.z);","vec4 tColor = texture2D(tOverlay,  (worldPosGeo-lowerLeft) / (upperRight - lowerLeft));","gl_FragColor =  mix(gl_FragColor,vec4(tColor.rgb * (vLightingOnly + ambientLightColor + emissive), opacity), tColor.a);","}","}"].join("\n")};THREE.ShaderMaterial.call(this,e)},GIScene.RasterOverlayMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.RasterOverlayMaterial.prototype.setUpperRight=function(e){this.upperRight=e.sub(this.offset2),this.uniforms.upperRight.value=this.upperRight},GIScene.RasterOverlayMaterial.prototype.setLowerLeft=function(e){this.lowerLeft=e.sub(this.offset2),this.uniforms.lowerLeft.value=this.lowerLeft},GIScene.RasterOverlayMaterial.prototype.setTexture=function(e){this.texture=this.uniforms.tOverlay.value=e,this.dispatchEvent({type:"settexture",content:{texture:e}})},GIScene.RasterOverlayMaterial.prototype.setTextureFromUrl=function(e,t,i){this.crossOrigin=t||this.crossOrigin,this.url=e;t=new THREE.TextureLoader;t.setCrossOrigin(this.crossOrigin);e=function(e){i&&i(),this.setTexture(e)}.bind(this);t.load(this.url,e)},GIScene.RasterOverlayMaterial.prototype.setOffset2=function(e){var t=this.offset2;this.offset2=e,this.setLowerLeft(this.lowerLeft.add(t)),this.setUpperRight(this.upperRight.add(t))},GIScene.RasterOverlayMaterial.prototype.clone=function(){var e=new GIScene.RasterOverlayMaterial;return e.config=GIScene.Utils.mergeObjects(e.config,this.config),e.url=this.url,e.crossOrigin=this.crossOrigin,e.offset2=this.offset2,e.lowerLeft=this.lowerLeft,e.upperRight=this.upperRight,e.texture=this.texture,e.uniforms.lowerLeft.value=this.uniforms.lowerLeft.value,e.uniforms.upperRight.value=this.uniforms.upperRight.value,e.uniforms.tOverlay.value=this.uniforms.tOverlay.value,e},GIScene.WMSOverlayMaterial=function(e,t){GIScene.RasterOverlayMaterial.apply(this,[e]);this.config=GIScene.Utils.mergeObjects({wmsServiceUrl:"",crossOrigin:"anonymous"},e||{}),this.params=GIScene.Utils.mergeObjects({service:"WMS",request:"GetMap",version:"1.1.1",format:"image/png",srs:"EPSG:32616",layers:null,styles:"",bbox:null,width:"256",height:"256"},t||{}),this.wmsServiceUrl=""==this.config.wmsServiceUrl?"":this.config.wmsServiceUrl.trim().replace(/(\/|\?)*$/,"?"),this.params.bbox&&this.setLLURFromBboxParam(),""==!this.config.wmsServiceUrl&&this.setTextureFromUrl(this.getGetMapUrl(),this.config.crossOrigin)},GIScene.WMSOverlayMaterial.prototype=Object.create(GIScene.RasterOverlayMaterial.prototype),GIScene.WMSOverlayMaterial.prototype.setBboxParamFromLLUR=function(){this.params.bbox=this.lowerLeft.clone().add(this.offset2).toArray().toString()+","+this.upperRight.clone().add(this.offset2).toArray().toString()},GIScene.WMSOverlayMaterial.prototype.setLLURFromBboxParam=function(){var e=this.params.bbox.split(",");this.setLowerLeft(new GIScene.Coordinate2(e[0],e[1])),this.setUpperRight(new GIScene.Coordinate2(e[2],e[3]))},GIScene.WMSOverlayMaterial.prototype.getGetMapUrl=function(){return this.params.bbox||this.setBboxParamFromLLUR(),[this.wmsServiceUrl,"SERVICE="+this.params.service,"REQUEST="+this.params.request,"VERSION="+this.params.version,"FORMAT="+this.params.format,"SRS="+this.params.srs,"LAYERS="+this.params.layers,"STYLES="+this.params.styles,"BBOX="+this.params.bbox,"WIDTH="+this.params.width,"HEIGHT="+this.params.height].join("&")},GIScene.WMSOverlayMaterial.prototype.clone=function(){var e=new GIScene.WMSOverlayMaterial;return e.config=GIScene.Utils.mergeObjects(e.config,this.config),e.params=GIScene.Utils.mergeObjects(e.params,this.params),e.wmsServiceUrl=this.wmsServiceUrl,e.url=this.url,e.crossOrigin=this.crossOrigin,e.offset2=this.offset2,e.lowerLeft=this.lowerLeft,e.upperRight=this.upperRight,e.texture=this.texture,e.uniforms.lowerLeft.value=this.uniforms.lowerLeft.value,e.uniforms.upperRight.value=this.uniforms.upperRight.value,e.uniforms.tOverlay.value=this.uniforms.tOverlay.value,e},GIScene.PointAlignmentMaterial=function(e,t,i){var n=e||new THREE.Vector3(0,0,0),r=t||15,o=i||5,a=new THREE.Color(0);Object.defineProperty(this,"point",{get:function(){return n},set:function(e){n=e,this.uniforms.uPoint.value=e}}),Object.defineProperty(this,"maxDeviationDeg",{get:function(){return r},set:function(e){r=e,this.uniforms.maxDeviationDeg.value=e}}),Object.defineProperty(this,"maxUpDeviationDeg",{get:function(){return o},set:function(e){o=e,this.uniforms.maxUpDeviationDeg.value=e}}),Object.defineProperty(this,"emissive",{get:function(){return a},set:function(e){a=e,this.uniforms.emissive.value=e}});var s={uniforms:{opacity:{type:"f",value:1},uPoint:{type:"v3",value:this.point},maxDeviationDeg:{type:"f",value:this.maxDeviationDeg},maxUpDeviationDeg:{type:"f",value:this.maxUpDeviationDeg},emissive:{type:"c",value:this.emissive}},vertexShader:["varying vec3 vNormal;","varying vec3 vWorldPosition;","uniform vec3 emissive;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vNormal = normalize(  normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","vWorldPosition = worldPosition.xyz;","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform vec3 uPoint;","uniform float maxDeviationDeg;","uniform float maxUpDeviationDeg;","uniform vec3 emissive;","varying vec3 vNormal;","varying vec3 vWorldPosition;","float red;","float maxDeviation;","float maxUpDeviation;","const float M_PI = 3.14159265358979323846;","vec3 hDir;","uniform mat4 modelMatrix;","void main() {","vec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * vNormal;","worldNormal = normalize( worldNormal );","maxDeviation = maxDeviationDeg * (M_PI / 180.0);","maxUpDeviation = maxUpDeviationDeg * (M_PI / 180.0);","float upDeviation = acos(dot(normalize(worldNormal), vec3(0.0,1.0,0.0)));","if (upDeviation < maxUpDeviation || upDeviation > M_PI - maxUpDeviation)","{","gl_FragColor = vec4( vec3(0.5)+emissive, opacity );","}","else","{","vec3 direction = uPoint-vWorldPosition;","vec3 hDirection = direction - ( dot(direction, vec3(0.0,1.0,0.0)) * vec3(0.0,1.0,0.0));","vec3 hNormalDirection = worldNormal -  ( dot(worldNormal, vec3(0.0,1.0,0.0)) * vec3(0.0,1.0,0.0));","float angle = acos(dot(normalize(hNormalDirection), normalize(hDirection)));","red = (maxDeviation - angle) / maxDeviation;","gl_FragColor = vec4( vec3(1.0,1.0-red,1.0-red) + emissive, opacity );","}","}"].join("\n")};THREE.ShaderMaterial.call(this,s),this.point=e||new THREE.Vector3(0,0,0),this.maxDeviationDeg=t||15,this.maxUpDeviationDeg=i||5,this.emissive=new THREE.Color(0)},GIScene.PointAlignmentMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),GIScene.PointAlignmentMaterial.prototype.clone=function(){var e=new GIScene.PointAlignmentMaterial;return THREE.ShaderMaterial.prototype.clone.call(this,e),e.point=this.point.clone(),e.maxDeviationDeg=this.maxDeviationDeg,e.maxUpDeviationDeg=this.maxUpDeviationDeg,e.emissive=this.emissive,e},GIScene.OverrideMaterialHandler=function(e){this.object=e.content.object,this.overrideMaterial=e.content.overrideMaterial,this.layer=e.content.layer},GIScene.OverrideMaterialHandler.WMS=function(e){var t,i;GIScene.OverrideMaterialHandler.apply(this,[e]),this.overrideMaterial instanceof GIScene.WMSOverlayMaterial&&this.object.geometry&&(t=function(){i.uniforms.lowerLeft.value=i.lowerLeft,i.uniforms.upperRight.value=i.upperRight,i.unsharedWmsTextureLoaded=!0}.bind(this),e=(new GIScene.Extent2).fromBox3((new THREE.Box3).setFromObject(this.object)),(i=this.overrideMaterial.clone()).waitForTexture=!0,i.lowerLeft=e.min,i.upperRight=e.max,i.isShared=!1,i.setBboxParamFromLLUR(),(this.object.material=i).setTextureFromUrl(i.getGetMapUrl(),i.config.crossOrigin,t))},GIScene.OverrideMaterialHandler.WMS.prototype=Object.create(GIScene.OverrideMaterialHandler.prototype),GIScene.Control=function(){this.scene=null,this.isActive=!1},GIScene.Control.prototype={constructor:GIScene.Control,setScene:function(e){this.scene=e},activate:function(){this.isActive=!0},deactivate:function(){this.isActive=!1},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Control.Select=function(e,t,i){GIScene.Control.call(this);this.config=GIScene.Utils.mergeObjects({highlightOnly:!1,hover:!1,clickout:!0,multi:!1,toggle:!0,selectColor:16776960},i||{}),this.selectables=e instanceof Array?e:e instanceof THREE.Object3D?[e]:[],this.camera=t,this.domElement=null,this.hitObject=null;var r=new THREE.Projector,n=new THREE.Vector3(0,0,1),o=!1;this.selectedObjects=[],this.highlightedOnlyObjects=[],this.getHitObject=function(e){for(var t,i=r.pickingRay(e,this.camera).intersectObjects(this.selectables),n=0;n<i.length;n++)if(i[n].object.geometry&&i[n].object.visible&&(!i[n].object.material.opacity||0<i[n].object.material.opacity)){t=i[n].object;break}return t},this.highlight=function(e,t){e.userData.isHighlighted?this.config.toggle&&this.unhighlight(e,t):(e.userData.isHighlighted=!0,GIScene.Utils.WorkingMaterial.setSelectColor(e,new THREE.Color(this.config.selectColor)),this.config.highlightOnly&&this.highlightedOnlyObjects.push(e),this.dispatchEvent({type:"highlighted",content:e}),t&&this.dispatchEvent({type:"highlightedbyuser",content:e}))},this.unhighlight=function(e,t){e.userData.isSelected||(GIScene.Utils.WorkingMaterial.setSelectColor(e,"default"),e.userData.isHighlighted=!1);for(var i=0;i<this.highlightedOnlyObjects.length;i++)if(e===this.highlightedOnlyObjects[i]){this.highlightedOnlyObjects.splice(i,1);break}this.dispatchEvent({type:"unhighlighted",content:e}),t&&this.dispatchEvent({type:"unhighlightedbyuser",content:e})},this.select=function(e,t){e.userData.isSelected?this.config.toggle&&this.unselect(e,t):(e.userData.isSelected=!0,this.selectedObjects.push(e),this.dispatchEvent({type:"selected",content:e}),t&&this.dispatchEvent({type:"selectedbyuser",content:e}),this.highlight(e))},this.unselect=function(e,t){e.userData.isSelected=!1,this.unhighlight(e);for(var i=0;i<this.selectedObjects.length;i++)if(e===this.selectedObjects[i]){this.selectedObjects.splice(i,1);break}this.dispatchEvent({type:"unselected",content:e}),t&&this.dispatchEvent({type:"unselectedbyuser",content:e})},this.removeSelectable=function(e){e.userData.isHighlighted&&this.unselect(e);for(var t=[],i=0,n=this.selectables.length;i<n;i++)this.selectables[i]!==e&&t.push(this.selectables[i]);this.selectables=t};var a=function(e){this.removeSelectable(e.content)}.bind(this),s=function(e){e.preventDefault();var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);n.set(t.x,t.y,1);t=this.getHitObject(n);this.config.hover&&(this.config.toggle=!1,this.config.clickout=!0,this.config.multi=!1),t?this.config.multi&&e.ctrlKey?this.config.highlightOnly?t.userData.isHighlighted&&!this.config.toggle||this.highlight(t,!0):t.userData.isSelected&&!this.config.toggle||this.select(t,!0):this.config.highlightOnly?(0<this.highlightedOnlyObjects.length&&this.unhighlightAll(!0),t.userData.isHighlighted&&!this.config.toggle||this.highlight(t,!0)):(!this.config.hover&&0<this.selectedObjects.length?this.unselectAll(!0):this.selectedObjects[0]&&this.selectedObjects[0]!==t&&this.unselect(this.selectedObjects[0],!0),t.userData.isSelected&&!this.config.toggle||this.select(t,!0)):this.config.clickout&&(this.config.highlightOnly?this.unhighlightAll(!0):this.unselectAll(!0))}.bind(this),c=function(e){this.config.hover?this.domElement.removeEventListener("mousemove",s,!1):(e=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e),n.set(e.x,e.y,1))}.bind(this),l=function(e){var t,i;this.config.hover?this.domElement.addEventListener("mousemove",s,!1):(t=n.clone(),i=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e),n.set(i.x,i.y,1),setTimeout(function(){console.log(o),o&&h++,n.equals(t)&&!o&&s(e),1<h&&(o=!1,h=0)}.bind(this),250))}.bind(this),h=0,d=function(e){o=!0}.bind(this);this.activate=function(){this.isActive||(this.domElement=this.scene.canvas,this.domElement.addEventListener("mousedown",c,!1),this.domElement.addEventListener("mouseup",l,!1),this.domElement.addEventListener("dblclick",d,!1),this.config.hover&&this.domElement.addEventListener("mousemove",s,!1),this.scene.addEventListener("beforeDisposeObject",a),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",c,!1),this.domElement.removeEventListener("mouseup",l,!1),this.config.hover&&this.domElement.removeEventListener("mousemove",s,!1),this.scene.removeEventListener("beforeDisposeObject",a),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Select.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Select.prototype.unhighlightAll=function(n){var r=this.highlightedOnlyObjects.slice(0);r.forEach(function(e,t,i){this.unhighlight(r[t],n)}.bind(this)),r=null,this.dispatchEvent({type:"unhighlightall"}),n&&this.dispatchEvent({type:"unhighlightallbyuser"})},GIScene.Control.Select.prototype.unselectAll=function(n){var r=this.selectedObjects.slice(0);r.forEach(function(e,t,i){this.unselect(r[t],n)}.bind(this)),r=null,this.dispatchEvent({type:"unselectall"}),n&&this.dispatchEvent({type:"unselectallbyuser"})},GIScene.Control.Pan=function(e,t){GIScene.Control.call(this),THREE.EventDispatcher.call(this),STATE={NONE:-1,PAN:0};var i=this;this.object=e,this.domElement=void 0!==t?t:document,this.panSpeed=.825,this.target=new THREE.Vector3;new THREE.Vector3;var n=STATE.NONE,r=new THREE.Vector3,o=new THREE.Vector2,a=new THREE.Vector2;this.panCamera=function(){var e,t=a.clone().sub(o);t.lengthSq()&&(t.multiplyScalar(r.length()*i.panSpeed),(e=r.clone().cross(i.object.up).setLength(t.x)).add(i.object.up.clone().setLength(t.y)),i.object.position.add(e),i.target.add(e),o=a)},this.update=function(){r.copy(i.object.position).sub(i.target),i.panCamera(),i.object.position.Vectors(i.target,r),i.object.lookAt(i.target)},mousedown=function(e){n=STATE.PAN,o=a=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002)},mousemove=function(e){n==STATE.PAN&&(a=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002))},mouseup=function(e){n=STATE.NONE},this.activate=function(){this.isActive||(this.domElement.addEventListener("mousedown",mousedown,!1),this.domElement.addEventListener("mousemove",mousemove,!1),this.domElement.addEventListener("mouseup",mouseup,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",mousedown,!1),this.domElement.removeEventListener("mousemove",mousemove,!1),this.domElement.removeEventListener("mouseup",mouseup,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.OrbitZoomPan=function(e,t){GIScene.Control.call(this),this.object=e,this.domElement=void 0!==t?t:document,this.center=null,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.autoRotate=!1,this.autoRotateSpeed=2,this.userPan=!0,this.userPanSpeed=.825;var o=this,i=1800,n=new THREE.Vector2,r=new THREE.Vector2,a=new THREE.Vector2,s=new THREE.Vector2,c=new THREE.Vector2,l=new THREE.Vector2,h=new THREE.Vector3,d=new THREE.Vector2,u=new THREE.Vector2,m=0,f=0,p=1,v=new THREE.Vector3,g={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},E=g.NONE,y={type:"change"};function S(){return 2*Math.PI/60/60*o.autoRotateSpeed}function b(){return Math.pow(.95,o.userZoomSpeed)}function T(e){o.dispatchEvent({type:"beforechange"}),o.userRotate&&(e.preventDefault(),0===e.button?(E=g.ROTATE,n.set(e.clientX,e.clientY)):1===e.button?(E=g.ZOOM,s.set(e.clientX,e.clientY)):2===e.button&&(E=g.PAN,d=u=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002)),document.addEventListener("mousemove",w,!1),document.addEventListener("mouseup",R,!1))}function w(e){e.preventDefault(),E===g.ROTATE?(r.set(e.clientX,e.clientY),a.subVectors(r,n),o.rotateLeft(2*Math.PI*a.x/i*o.userRotateSpeed),o.rotateUp(2*Math.PI*a.y/i*o.userRotateSpeed),n.copy(r)):E===g.ZOOM?(c.set(e.clientX,e.clientY),l.subVectors(c,s),0<l.y?o.zoomIn():o.zoomOut(),s.copy(c)):E===g.PAN&&(u=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002))}function R(e){o.userRotate&&(document.removeEventListener("mousemove",w,!1),document.removeEventListener("mouseup",R,!1),E=g.NONE,o.dispatchEvent({type:"afterchange"}))}function M(e){o.userZoom&&(e.wheelDelta&&0<e.wheelDelta||e.detail&&0<e.detail?o.zoomOut():o.zoomIn())}this.rotateLeft=function(e){void 0===e&&(e=S()),f-=e},this.rotateRight=function(e){void 0===e&&(e=S()),f+=e},this.rotateUp=function(e){void 0===e&&(e=S()),m-=e},this.rotateDown=function(e){void 0===e&&(e=S()),m+=e},this.zoomIn=function(e){void 0===e&&(e=b()),p/=e},this.zoomOut=function(e){void 0===e&&(e=b()),p*=e},this.panCamera=function(){var e,t=u.clone().sub(d);t.lengthSq()&&(t.multiplyScalar(h.length()*o.userPanSpeed),(e=h.clone().cross(o.object.up).setLength(t.x)).sub(h.clone().cross(h.clone().cross(o.object.up)).setLength(t.y)),o.object.position.add(e),o.center.clone(),o.center.add(e),d=u)},this.update=function(){var e,t,i,n,r;E!=g.PAN?(t=(e=this.object.position).clone().sub(this.center),i=Math.atan2(t.x,t.z),n=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y),this.autoRotate&&this.rotateLeft(S()),i+=f,n+=m,n=Math.max(1e-6,Math.min(Math.PI-1e-6,n)),r=t.length(),t.x=r*Math.sin(n)*Math.sin(i),t.y=r*Math.cos(n),t.z=r*Math.sin(n)*Math.cos(i),t.multiplyScalar(p),this.object.inOrthographicMode&&this.object.toOrthographic(),e.copy(this.center).add(t),this.object.lookAt(this.center),m=f=0,p=1):(h.copy(o.object.position).sub(o.center),o.panCamera(),o.object.position.addVectors(o.center,h)),0<v.distanceTo(this.object.position)&&(this.dispatchEvent(y),v.copy(this.object.position))}.bind(this);function I(e){this.scene.center=e.target.center.clone(),this.object.target.position.setZ(-this.object.position.distanceTo(e.target.center))}var L=function(e){this.center=e.content.center}.bind(this);this.activate=function(){var e;this.isActive||(this.center=this.scene.center.clone(),this.object.up.set(0,1,0),(e=new THREE.Vector3(0,0,-1)).applyQuaternion(this.object.quaternion),e.normalize(),this.center.distanceTo(this.object.position)<.01&&this.object.position.sub(e.multiplyScalar(.01)),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",T,!1),this.domElement.addEventListener("mousewheel",M,!1),this.domElement.addEventListener("DOMMouseScroll",M,!1),this.addEventListener("change",I),this.scene.addEventListener("center",L),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",T,!1),this.domElement.removeEventListener("mousewheel",M,!1),this.domElement.removeEventListener("DOMMouseScroll",M,!1),this.addEventListener("change",I),this.scene.removeEventListener("center",L),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.OrbitZoomPan.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.PanOrbitZoomCenter=function(e,t){GIScene.Control.call(this),this.object=e,this.domElement=void 0!==t?t:document,this.center=null,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.autoRotate=!1,this.autoRotateSpeed=2,this.userPan=!0,this.userPanSpeed=.825;var o=this,i=1800,n=new THREE.Vector2,r=new THREE.Vector2,a=new THREE.Vector2,s=new THREE.Vector2,c=new THREE.Vector2,l=new THREE.Vector2,h=new THREE.Vector3,d=new THREE.Vector2,u=new THREE.Vector2,m=new THREE.Vector3,f=new THREE.Projector,p=0,v=0,g=1,E=new THREE.Vector3,y={NONE:-1,ROTATE:0,ZOOM:1,PAN:2},S=y.NONE,b={type:"change"};function T(){return 2*Math.PI/60/60*o.autoRotateSpeed}function w(){return Math.pow(.95,o.userZoomSpeed)}function R(e){o.dispatchEvent({type:"beforechange"}),o.userRotate&&(e.preventDefault(),e.button===y.ROTATE?(S=y.ROTATE,n.set(e.clientX,e.clientY)):e.button===y.ZOOM?(S=y.ZOOM,s.set(e.clientX,e.clientY)):e.button===y.PAN&&(S=y.PAN,d=u=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002)),document.addEventListener("mousemove",M,!1),document.addEventListener("mouseup",I,!1))}function M(e){e.preventDefault(),S===y.ROTATE?(r.set(e.clientX,e.clientY),a.subVectors(r,n),o.rotateLeft(2*Math.PI*a.x/i*o.userRotateSpeed),o.rotateUp(2*Math.PI*a.y/i*o.userRotateSpeed),n.copy(r)):S===y.ZOOM?(c.set(e.clientX,e.clientY),l.subVectors(c,s),0<l.y?o.zoomIn():o.zoomOut(),s.copy(c)):S===y.PAN&&(u=new THREE.Vector2(e.clientX,e.clientY).multiplyScalar(.002))}function I(e){o.userRotate&&(document.removeEventListener("mousemove",M,!1),document.removeEventListener("mouseup",I,!1),S=y.NONE,o.dispatchEvent({type:"afterchange"}))}function L(e){o.userZoom&&(e.wheelDelta&&0<e.wheelDelta||e.detail&&0<e.detail?o.zoomOut():o.zoomIn())}this.rotateLeft=function(e){void 0===e&&(e=T()),v-=e},this.rotateRight=function(e){void 0===e&&(e=T()),v+=e},this.rotateUp=function(e){void 0===e&&(e=T()),p-=e},this.rotateDown=function(e){void 0===e&&(e=T()),p+=e},this.zoomIn=function(e){void 0===e&&(e=w()),g/=e},this.zoomOut=function(e){void 0===e&&(e=w()),g*=e},this.panCamera=function(){var e,t=u.clone().sub(d);t.lengthSq()&&(t.multiplyScalar(h.length()*o.userPanSpeed),(e=h.clone().cross(o.object.up).setLength(t.x)).sub(h.clone().cross(h.clone().cross(o.object.up)).setLength(t.y)),o.object.position.add(e),o.center.clone(),o.center.add(e),d=u)},this.update=function(){var e,t,i,n,r;S!=y.PAN?(t=(e=this.object.position).clone().sub(this.center),i=Math.atan2(t.x,t.z),n=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y),this.autoRotate&&this.rotateLeft(T()),i+=v,n+=p,n=Math.max(1e-6,Math.min(Math.PI-1e-6,n)),r=t.length(),t.x=r*Math.sin(n)*Math.sin(i),t.y=r*Math.cos(n),t.z=r*Math.sin(n)*Math.cos(i),t.multiplyScalar(g),this.object.inOrthographicMode&&this.object.toOrthographic(),e.copy(this.center).add(t),this.object.lookAt(this.center),p=v=0,g=1):(h.copy(o.object.position).sub(o.center),o.panCamera(),o.object.position.addVectors(o.center,h)),0<E.distanceTo(this.object.position)&&(this.dispatchEvent(b),E.copy(this.object.position))}.bind(this);function A(e){this.scene.center=e.target.center.clone(),this.object.target.position.setZ(-this.object.position.distanceTo(e.target.center))}var x=function(e){e.preventDefault();var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);m.set(t.x,t.y,1);for(var i,n,e=f.pickingRay(m,this.object),t=this.scene.root.getDescendants().filter(function(e,t,i){return e.geometry}),r=e.intersectObjects(t),o=0;o<r.length;o++)if(r[o].object.geometry&&r[o].object.visible){i=r[o];break}i&&(n=function(e){this.scene.removeEventListener("center",n),this.scene.addEventListener("beforeRender",this.update)}.bind(this),this.scene.addEventListener("center",n),this.scene.removeEventListener("beforeRender",this.update),this.scene.setCenter(i.point,this.object.position.clone().sub(this.center),500))}.bind(this),C=function(e){this.center=e.content.center}.bind(this);this.activate=function(){var e;this.isActive||(this.center=this.scene.center.clone(),this.object.up.set(0,1,0),(e=new THREE.Vector3(0,0,-1)).applyQuaternion(this.object.quaternion),e.normalize(),this.center.distanceTo(this.object.position)<.01&&this.object.position.sub(e.multiplyScalar(.01)),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",R,!1),this.domElement.addEventListener("mousewheel",L,!1),this.domElement.addEventListener("DOMMouseScroll",L,!1),this.domElement.addEventListener("dblclick",x,!1),this.addEventListener("change",A),this.scene.addEventListener("center",C),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",R,!1),this.domElement.removeEventListener("mousewheel",L,!1),this.domElement.removeEventListener("DOMMouseScroll",L,!1),this.domElement.removeEventListener("dblclick",x,!1),this.removeEventListener("change",A),this.scene.removeEventListener("center",C),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.PanOrbitZoomCenter.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Trackball=function(e,t){GIScene.Control.call(this);var n=this,r={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.noRoll=!0,this.staticMoving=!0,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var i=new THREE.Vector3,o=r.NONE,a=r.NONE,s=new THREE.Vector3,c=new THREE.Vector3,l=new THREE.Vector3,h=new THREE.Vector2,d=new THREE.Vector2,u=0,m=0,f=new THREE.Vector2,p=new THREE.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var v={type:"change"},g={type:"start"},E={type:"end"};function y(e){!1!==n.enabled&&(window.removeEventListener("keydown",y),(a=o)!==r.NONE||(e.keyCode!==n.keys[r.ROTATE]||n.noRotate?e.keyCode!==n.keys[r.ZOOM]||n.noZoom?e.keyCode!==n.keys[r.PAN]||n.noPan||(o=r.PAN):o=r.ZOOM:o=r.ROTATE))}function S(e){!1!==n.enabled&&(o=a,window.addEventListener("keydown",y,!1))}function b(e){!1!==n.enabled&&(e.preventDefault(),e.stopPropagation(),o===r.NONE&&(o=e.button),o!==r.ROTATE||n.noRotate?o!==r.ZOOM||n.noZoom?o!==r.PAN||n.noPan||(f=n.getMouseOnScreen(e.clientX,e.clientY),p.copy(f)):(h=n.getMouseOnScreen(e.clientX,e.clientY),d.copy(h)):(c=n.getMouseProjectionOnBall(e.clientX,e.clientY),l.copy(c)),document.addEventListener("mousemove",T,!1),document.addEventListener("mouseup",w,!1),n.dispatchEvent(g))}function T(e){!1!==n.enabled&&(e.preventDefault(),e.stopPropagation(),o!==r.ROTATE||n.noRotate?o!==r.ZOOM||n.noZoom?o!==r.PAN||n.noPan||(p=n.getMouseOnScreen(e.clientX,e.clientY)):d=n.getMouseOnScreen(e.clientX,e.clientY):l=n.getMouseProjectionOnBall(e.clientX,e.clientY))}function w(e){!1!==n.enabled&&(e.preventDefault(),e.stopPropagation(),o=r.NONE,document.removeEventListener("mousemove",T),document.removeEventListener("mouseup",w),n.dispatchEvent(E))}function R(e){var t;!1!==n.enabled&&(e.preventDefault(),e.stopPropagation(),t=0,e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),h.y+=.01*t,n.dispatchEvent(g),n.dispatchEvent(E))}function M(e){if(!1!==n.enabled){switch(e.touches.length){case 1:o=r.TOUCH_ROTATE,c=l=n.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY);break;case 2:o=r.TOUCH_ZOOM;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;m=u=Math.sqrt(t*t+i*i);break;case 3:o=r.TOUCH_PAN,f=p=n.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY);break;default:o=r.NONE}n.dispatchEvent(g)}}function I(e){if(!1!==n.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:l=n.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY);break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;m=Math.sqrt(t*t+i*i);break;case 3:p=n.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY);break;default:o=r.NONE}}function L(e){if(!1!==n.enabled){switch(e.touches.length){case 1:c=l=n.getMouseProjectionOnBall(e.touches[0].pageX,e.touches[0].pageY);break;case 2:u=m=0;break;case 3:f=p=n.getMouseOnScreen(e.touches[0].pageX,e.touches[0].pageY)}o=r.NONE,n.dispatchEvent(E)}}this.handleResize=function(){this.domElement===document?(this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight):this.screen=this.domElement.getBoundingClientRect()},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)},this.getMouseOnScreen=function(e,t){return new THREE.Vector2((e-n.screen.left)/n.screen.width,(t-n.screen.top)/n.screen.height)},this.getMouseProjectionOnBall=function(e,t){e=new THREE.Vector3((e-.5*n.screen.width-n.screen.left)/(.5*n.screen.width),(.5*n.screen.height+n.screen.top-t)/(.5*n.screen.height),0),t=e.length();n.noRoll?t<Math.SQRT1_2?e.z=Math.sqrt(1-t*t):e.z=.5/t:1<t?e.normalize():e.z=Math.sqrt(1-t*t),s.copy(n.object.position).sub(n.target);t=n.object.up.clone().setLength(e.y);return t.add(n.object.up.clone().cross(s).setLength(e.x)),t.add(s.setLength(e.z)),t},this.rotateCamera=function(){var e,t,i=Math.acos(c.dot(l)/c.length()/l.length());i&&(e=(new THREE.Vector3).crossVectors(c,l).normalize(),t=new THREE.Quaternion,i*=n.rotateSpeed,t.setFromAxisAngle(e,-i),s.applyQuaternion(t),n.object.up.applyQuaternion(t),l.applyQuaternion(t),n.staticMoving?c.copy(l):(t.setFromAxisAngle(e,i*(n.dynamicDampingFactor-1)),c.applyQuaternion(t)))},this.zoomCamera=function(){var e;o===r.TOUCH_ZOOM?(e=u/m,u=m,s.multiplyScalar(e)):1!==(e=1+(d.y-h.y)*n.zoomSpeed)&&0<e&&(s.multiplyScalar(e),n.staticMoving?h.copy(d):h.y+=(d.y-h.y)*this.dynamicDampingFactor)},this.panCamera=function(){var e,t=p.clone().sub(f);t.lengthSq()&&(t.multiplyScalar(s.length()*n.panSpeed),(e=s.clone().cross(n.object.up).setLength(t.x)).add(n.object.up.clone().setLength(t.y)),n.object.position.add(e),n.target.add(e),n.staticMoving?f=p:f.add(t.subVectors(p,f).multiplyScalar(n.dynamicDampingFactor)))},this.checkDistances=function(){n.noZoom&&n.noPan||(s.lengthSq()>n.maxDistance*n.maxDistance&&n.object.position.addVectors(n.target,s.setLength(n.maxDistance)),s.lengthSq()<n.minDistance*n.minDistance&&n.object.position.addVectors(n.target,s.setLength(n.minDistance)))},this.update=function(){s.subVectors(n.object.position,n.target),n.noRotate||n.rotateCamera(),n.noZoom||n.zoomCamera(),n.noPan||n.panCamera(),n.object.position.addVectors(n.target,s),n.checkDistances(),n.object.lookAt(n.target),0<i.distanceToSquared(n.object.position)&&(n.dispatchEvent(v),i.copy(n.object.position))},this.reset=function(){o=r.NONE,a=r.NONE,n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.up.copy(n.up0),s.subVectors(n.object.position,n.target),n.object.lookAt(n.target),n.dispatchEvent(v),i.copy(n.object.position)};function A(e){this.scene.center=e.target.target.clone(),this.object.target.position.setZ(-this.object.position.distanceTo(e.target.target))}var x=function(e){this.target=e.content.center}.bind(this);this.activate=function(){this.isActive||(this.target=this.scene.center.clone(),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",b,!1),this.domElement.addEventListener("mousewheel",R,!1),this.domElement.addEventListener("DOMMouseScroll",R,!1),this.domElement.addEventListener("touchstart",M,!1),this.domElement.addEventListener("touchend",L,!1),this.domElement.addEventListener("touchmove",I,!1),window.addEventListener("keydown",y,!1),window.addEventListener("keyup",S,!1),this.handleResize(),window.addEventListener("resize",this.handleResize,!1),this.addEventListener("change",A),this.scene.addEventListener("center",x),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",b,!1),this.domElement.removeEventListener("mousewheel",R,!1),this.domElement.removeEventListener("DOMMouseScroll",R,!1),this.domElement.removeEventListener("touchstart",M,!1),this.domElement.removeEventListener("touchend",L,!1),this.domElement.removeEventListener("touchmove",I,!1),window.removeEventListener("keydown",y,!1),window.removeEventListener("keyup",S,!1),this.removeEventListener("change",A),this.scene.removeEventListener("center",x),window.removeEventListener("resize",this.handleResize,!1),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Trackball.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Fly=function(e,t){GIScene.Control.call(this),this.object=e,this.domElement=void 0!==t?t:document,t&&this.domElement.setAttribute("tabindex",-1),this.center=null,this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this.tmpQuaternion=new THREE.Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0);var i=function(e){if(!e.altKey){switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}}.bind(this),n=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()}.bind(this),r=function(e){if(this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus++;else{switch(e.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1}this.updateMovementVector()}}.bind(this),o=function(e){var t,i,n;(!this.dragToLook||0<this.mouseStatus)&&(i=(t=this.getContainerDimensions()).size[0]/2,n=t.size[1]/2,this.moveState.yawLeft=-(e.pageX-t.offset[0]-i)/i,this.moveState.pitchDown=(e.pageY-t.offset[1]-n)/n,this.updateRotationVector())}.bind(this),a=function(e){if(e.preventDefault(),e.stopPropagation(),this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(e.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0}this.updateMovementVector()}this.updateRotationVector()}.bind(this);this.update=function(){console.log("FLY.update()"),delta=this.scene.delta,console.log("delta",delta);var e=delta*this.movementSpeed,t=delta*this.rollSpeed;this.object.translateX(this.moveVector.x*e),this.object.translateY(this.moveVector.y*e),this.object.translateZ(this.moveVector.z*e),this.dispatchEvent({type:"change"}),this.tmpQuaternion.set(this.rotationVector.x*t,this.rotationVector.y*t,this.rotationVector.z*t,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),this.object.rotation.setFromQuaternion(this.object.quaternion,this.object.rotation.order)}.bind(this),this.updateMovementVector=function(){console.log("FLY.updateMovementVector()");var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){console.log("FLY.updateRotationVector()"),this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}};var s=function(e){this.center=e.content.center}.bind(this),c=function(e){this.scene.center=e.target.center.clone()}.bind(this);this.activate=function(){this.isActive||(this.center=this.scene.center.clone(),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",o,!1),this.domElement.addEventListener("mousedown",r,!1),this.domElement.addEventListener("mouseup",a,!1),this.domElement.addEventListener("keydown",i,!1),this.domElement.addEventListener("keyup",n,!1),this.addEventListener("change",c),this.scene.addEventListener("center",s),this.updateMovementVector(),this.updateRotationVector(),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousemove",o,!1),this.domElement.removeEventListener("mousedown",r,!1),this.domElement.removeEventListener("mouseup",a,!1),this.domElement.removeEventListener("keydown",i,!1),this.domElement.removeEventListener("keyup",n,!1),this.removeEventListener("change",c),this.scene.removeEventListener("center",s),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Fly.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Walk=function(e,t){GIScene.Control.call(this),this.object=e,this.target=new THREE.Vector3(0,0,0),this.center=null,this.bodyPivot=null,this.domElement=void 0!==t?t:document,this.movementSpeed=5,this.lookSpeed=.025,this.maxMovementSpeed=100,this.minMovementSpeed=.01,this.jumpOffset=1,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!1,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0;var a=new THREE.Vector3,s=new THREE.Projector;this.mouseStart=new THREE.Vector2,this.mouseEnd=new THREE.Vector2,this.mouseDelta=new THREE.Vector2,this.lat=0,this.oldLat=0,this.lon=0,this.phi=0,this.theta=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.freeze=!1,this.mouseDragOn=!1,this.viewHalfX=0,this.viewHalfY=0,this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.onMouseDown=function(e){if(document.addEventListener("mousemove",this.onMouseMove,!1),this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseEnd.set(e.clientX,e.clientY),this.mouseStart.set(e.clientX,e.clientY),this.oldLat+=this.lat,this.lat=0,this.mouseDelta.set(0,0),this.mouseDragOn=!0}.bind(this),this.onMouseUp=function(e){if(document.removeEventListener("mousemove",this.onMouseMove,!1),e.preventDefault(),e.stopPropagation(),this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1,this.oldLat+=this.lat,this.lat=0}.bind(this),this.onMouseMove=function(e){this.mouseEnd.set(e.clientX,e.clientY),this.mouseDelta.subVectors(this.mouseEnd,this.mouseStart)}.bind(this),this.onKeyDown=function(e){switch(e.keyCode){case 73:case 38:this.moveForward=!0;break;case 87:this.lookUp=!0;break;case 74:case 37:this.rotateLeft=!0;break;case 65:this.moveLeft=!0;break;case 75:case 40:this.moveBackward=!0;break;case 83:this.lookDown=!0;break;case 76:case 39:this.rotateRight=!0;break;case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze;break;case 107:case 171:case 61:case 187:this.movementSpeed=Math.min(this.movementSpeed*=1.5,this.maxMovementSpeed);break;case 109:case 163:case 173:case 191:case 189:this.movementSpeed=Math.max(this.movementSpeed/=1.5,this.minMovementSpeed)}}.bind(this),this.onKeyUp=function(e){switch(e.keyCode){case 73:case 38:this.moveForward=!1;break;case 87:this.lookUp=!1;break;case 74:case 37:this.rotateLeft=!1;break;case 65:this.moveLeft=!1;break;case 75:case 40:this.moveBackward=!1;break;case 83:this.lookDown=!1;break;case 76:case 39:this.rotateRight=!1;break;case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}}.bind(this),this.update=function(){var e,t;delta=this.scene.delta,this.freeze||(this.heightSpeed?(e=THREE.Math.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin,this.autoSpeedFactor=delta*(e*this.heightCoef)):this.autoSpeedFactor=0,e=delta*this.movementSpeed,(this.moveForward||this.autoForward&&!this.moveBackward)&&this.bodyPivot.translateZ(-(e+this.autoSpeedFactor)),this.moveBackward&&this.bodyPivot.translateZ(e),this.moveLeft&&this.bodyPivot.translateX(-e),this.moveRight&&this.bodyPivot.translateX(e),this.moveUp&&this.bodyPivot.translateY(e),this.moveDown&&this.bodyPivot.translateY(-e),delta,this.lookSpeed,this.activeLook,this.constrainVertical&&(Math.PI,this.verticalMax,this.verticalMin),this.mouseDragOn&&5<Math.abs(this.mouseDelta.x)&&(t=this.mouseDelta.x/Math.abs(this.mouseDelta.x),this.lon+=t*Math.min((Math.abs(this.mouseDelta.x)-5)/20,delta*this.lookSpeed*800)),this.rotateLeft&&(this.lon-=delta*this.lookSpeed*800),this.rotateRight&&(this.lon+=delta*this.lookSpeed*800),this.lookVertical&&this.mouseDragOn&&(this.lat=this.mouseDelta.y/5),this.lookVertical&&this.lookUp&&(this.oldLat-=delta*this.lookSpeed*800),this.lookVertical&&this.lookDown&&(this.oldLat+=delta*this.lookSpeed*800),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=THREE.Math.degToRad(90),this.theta=THREE.Math.degToRad(this.lon),this.constrainVertical&&(this.phi=THREE.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax)),e=this.target,t=this.bodyPivot.position,e.x=t.x+100*Math.sin(this.phi)*Math.cos(this.theta),e.y=t.y+100*Math.cos(this.phi),e.z=t.z+100*Math.sin(this.phi)*Math.sin(this.theta),this.bodyPivot.lookAt(e),this.object.position.copy(t),(t=new THREE.Quaternion).setFromAxisAngle(new THREE.Vector3(1,0,0),THREE.Math.degToRad(-10-this.oldLat-this.lat)),this.object.quaternion.multiplyQuaternions(this.bodyPivot.quaternion,t),this.dispatchEvent({type:"change"}))}.bind(this);var r=function(e){e.preventDefault();var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);a.set(t.x,t.y,1);for(var i,n,e=s.pickingRay(a,this.object),t=this.scene.root.getDescendants().filter(function(e,t,i){return e.geometry}),r=e.intersectObjects(t),o=0;o<r.length;o++)if(r[o].object.geometry&&r[o].object.visible){i=r[o];break}i&&(n=function(e){this.scene.removeEventListener("center",n),this.scene.addEventListener("beforeRender",this.update)}.bind(this),this.scene.addEventListener("center",n),this.scene.removeEventListener("beforeRender",this.update),e=i.point.clone().add(new THREE.Vector3(0,1,0)),t=this.object.position.clone().sub(e).normalize(),this.scene.setCenter(e,t.clone().multiplyScalar(this.jumpOffset),500),this.dispatchEvent({type:"change"}))}.bind(this),o=function(e){this.center=e.content.center,this.bodyPivot.matrix.copy(this.object.matrixWorld),this.bodyPivot.updateMatrixWorld(),this.bodyPivot.position.copy(this.object.position),this.bodyPivot.quaternion.setFromRotationMatrix(this.object.matrixWorld);var t=new THREE.Vector3(0,0,-1),i=t.clone(),n=new THREE.Vector3(0,1,0);t.applyQuaternion(this.bodyPivot.quaternion);e=t.clone().projectOnPlane(n),n=e.clone().cross(n).angleTo(i)>Math.PI/2,i=e.angleTo(i),i=n?i:2*Math.PI-i,i=THREE.Math.radToDeg(i);this.lon=i+90,this.lat=THREE.Math.radToDeg(t.angleTo(this.scene.camera.up))-90-10-this.oldLat}.bind(this),c=function(e){this.center=this.object.localToWorld(this.object.target.position.clone()),this.scene.center=this.center,this.scene.dispatchEvent("cameraChange")}.bind(this);this.activate=function(){var e,t,i,n;this.isActive||(this.scene.camera.target.position.setZ(-this.jumpOffset),this.center=this.scene.camera.localToWorld(this.scene.camera.target.position.clone()),this.scene.setCenter(this.center,this.scene.camera.position.clone().sub(this.center),0),this.bodyPivot=new THREE.Object3D,this.bodyPivot.applyMatrix(this.object.matrixWorld),this.bodyPivot.matrixWorldNeedsUpdate=!0,n=(e=new THREE.Vector3(0,0,-1)).clone(),i=new THREE.Vector3(0,1,0),e.applyQuaternion(this.bodyPivot.quaternion),i=(t=e.clone().projectOnPlane(i)).clone().cross(i).angleTo(n)>Math.PI/2,n=t.angleTo(n),n=i?n:2*Math.PI-n,n=THREE.Math.radToDeg(n),this.lon=n+90,this.lat=THREE.Math.radToDeg(e.angleTo(this.scene.camera.up))-90-10-this.oldLat,this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",this.onMouseDown,!1),document.addEventListener("mouseup",this.onMouseUp,!1),this.domElement.addEventListener("keydown",this.onKeyDown,!1),this.domElement.addEventListener("keyup",this.onKeyUp,!1),this.domElement.addEventListener("dblclick",r,!1),this.addEventListener("change",c),this.scene.addEventListener("center",o),this.scene.addEventListener("beforeRender",this.update),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousedown",this.onMouseDown,!1),document.removeEventListener("mouseup",this.onMouseUp,!1),this.domElement.removeEventListener("keydown",this.onKeyDown,!1),this.domElement.removeEventListener("keyup",this.onKeyUp,!1),this.domElement.removeEventListener("dblclick",r,!1),this.removeEventListener("change",c),this.scene.removeEventListener("center",o),this.scene.removeEventListener("beforeRender",this.update),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Walk.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.CameraLight=function(e,t,i){GIScene.Control.call(this);this.config=GIScene.Utils.mergeObjects({maxHorizontalAngle:65,maxVerticalAngle:65},i||{}),this.camera=e,this.light=t||new THREE.DirectionalLight(16777215,.5),this.pivotLight=new THREE.Object3D,this.domElement=null;var n=new THREE.Vector2(0,0);this.maxHorizontalAngle=this.config.maxHorizontalAngle,this.maxVerticalAngle=this.config.maxVerticalAngle;var r=-1,o=1,a=r,s=!1,c=new THREE.Texture(null),l=new Image;l.onload=function(){c.image=l,c.needsUpdate=!0},l.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QTg5OEJENDc1ODUyMTFFMEExNjhDMjM3RjM1NjdBMkYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QTg5OEJENDg1ODUyMTFFMEExNjhDMjM3RjM1NjdBMkYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBODk4QkQ0NTU4NTIxMUUwQTE2OEMyMzdGMzU2N0EyRiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBODk4QkQ0NjU4NTIxMUUwQTE2OEMyMzdGMzU2N0EyRiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PpQl4IgAABkpSURBVHja7F0JbFzH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";var h,d,u,t=new THREE.SpriteMaterial({map:c,opacity:.7});this.sprite=new THREE.Sprite(t),this.sprite.scale.set(50,50,1),this.panSprite=function(e){var t=this.sprite.position;t.set(t.x+e.x,t.y-e.y,t.z),this.updateLightPosition()},this.updateLightPosition=function(){var e=this.sprite.position.clone();e.x/=this.scene.canvas.width/2,e.y/=this.scene.canvas.height/2,n=e.clone().set(e.x*this.maxHorizontalAngle,e.y*-this.maxVerticalAngle),this.pivotLight.rotation.set(THREE.Math.degToRad(n.y),THREE.Math.degToRad(n.x),0)},this.getIlluminationAngles=function(){return{theta:n.x,phi:n.y}};var m=function(e){s&&(this.dispatchEvent({type:"panstart"}),a=o,e=GIScene.Utils.getRelativeScreenCoordsFromDOMEvent(this.domElement,e),h=e,this.domElement.addEventListener("mouseup",p,!1))}.bind(this),f=function(e){var t=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);t.x*=this.scene.canvas.width/2,t.y*=this.scene.canvas.height/2;t=t.distanceTo(this.sprite.position);s=t<=Math.max(this.sprite.scale.x,this.sprite.scale.y)/2?(0==s&&(this.sprite.material.opacity=1),!0):(1==s&&(this.sprite.material.opacity=.7),!1),a==o&&(d=GIScene.Utils.getRelativeScreenCoordsFromDOMEvent(this.domElement,e),u=d.clone().sub(h),this.panSprite(u),h=d,this.dispatchEvent({type:"pan"}))}.bind(this),p=function(e){a==o&&this.dispatchEvent({type:"panend"}),a=r,this.domElement.removeEventListener("mouseup",p,!1)}.bind(this);(function(e){}).bind(this);this.activate=function(){var e;this.isActive||(e=(new THREE.Vector3).setFromMatrixPosition(this.camera.target.matrixWorld),this.pivotLight.rotation.set(0,0,0),this.camera.target.add(this.pivotLight),this.light.position.set(0,0,this.camera.position.distanceTo(e)),this.pivotLight.add(this.light),this.light.target.position.set(0,0,0),this.camera.target.add(this.light.target),this.domElement=this.scene.canvas,this.sprite.position.set(0,0,0),this.scene.spriteRoot.add(this.sprite),this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",f,!1),this.domElement.addEventListener("mousedown",m,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.sprite),THREE.SceneUtils.detach(this.light.target,this.camera.target,this.scene.root),THREE.SceneUtils.detach(this.light,this.light.parent,this.scene.root),this.camera.target.remove(this.pivotLight),this.domElement.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.removeEventListener("mousemove",f,!1),this.domElement.removeEventListener("mousedown",m,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.CameraLight.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Pick=function(e,t){GIScene.Control.call(this),this.camera=e;e={color:new THREE.Color(65280)};this.config=GIScene.Utils.mergeObjects(e,t||{}),this.domElement=null,this.pickables=[];var r=new THREE.Vector3(0,0,1),o=new THREE.Projector,t=THREE.ImageUtils.loadTexture(GIScene.LIBRARYPATH+GIScene.RESOURCESPATH.replace(/([^\/])$/,"$1/")+"resources/images/particle_cross.png"),i=new GIScene.Layer("Picked Coordinate",{layerGroup:"User-generated"}),n=new THREE.Geometry;n.vertices[0]=new THREE.Vector3(0,0,0);var t=new THREE.PointCloudMaterial({color:this.config.color,sizeAttenuation:!1,size:32,map:t,alphaTest:.5}),a=new THREE.PointCloud(n,t);a.visible=!1,i.root.add(a);var s=function(e){e=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);r.set(e.x,e.y,1)}.bind(this),c=function(e){e=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);if(r.equals((new THREE.Vector3).set(e.x,e.y,1))){r.set(e.x,e.y,1);for(var t,i=o.pickingRay(r,this.camera).intersectObjects(this.pickables),n=0;n<i.length;n++)if(i[n].object.geometry&&i[n].object.visible){t=i[n];break}t&&this.drawPickResult(t),this.dispatchEvent({type:"click",content:t})}}.bind(this);this.drawPickResult=function(e){a.visible=!0;e=e.point;n.vertices[0]=e,n.verticesNeedUpdate=!0},this.activate=function(){this.isActive||(this.domElement=this.scene.canvas,i.config.offset=this.scene.config.offset,this.scene.addLayer(i),this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mouseup",c,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",s,!1),this.domElement.removeEventListener("mouseup",c,!1),this.scene.removeLayer(i),a.visible=!1,GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Pick.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Measure=function(e,t){GIScene.Control.call(this),this.camera=e;e={color:new THREE.Color(16711680)};this.config=GIScene.Utils.mergeObjects(e,t||{}),this.domElement=null,this.measureables=[];var i,r=new THREE.Vector3(0,0,1),o=new THREE.Projector,a=null,s=null,c=null,n=function(e){e=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);r.set(e.x,e.y,1)}.bind(this),l=function(e){e=GIScene.Utils.getViewportCoordsFromDOMEvent(this.domElement,e);if(r.equals((new THREE.Vector3).set(e.x,e.y,1))){r.set(e.x,e.y,1);for(var t,i=o.pickingRay(r,this.camera).intersectObjects(this.measureables),n=0;n<i.length;n++)if(i[n].object.geometry&&i[n].object.visible){t=i[n];break}t&&this.drawPickResult(t)}}.bind(this);this.drawPickResult=function(e){var t,i,n,r,o;a.root.children.length<2&&(n=e.point,pickedPointGeom=new THREE.Geometry,pickedPointGeom.vertices.push(n)),1==a.root.children.length&&(o=new THREE.PointCloud(pickedPointGeom.clone(),s),a.root.add(o),r=new THREE.Geometry,t=a.root.children[0].geometry.vertices[0],i=a.root.children[1].geometry.vertices[0],r.vertices.push(t),r.vertices.push(i),e=new THREE.Line(r,c),a.root.add(e),n=new THREE.Vector3(0,0,-1),r=i.clone().setY(0),e=t.clone().setY(0),e=0<=(r=r.sub(e)).x,r=n.angleTo(r),e||(r=2*Math.PI-r),r=THREE.Math.radToDeg(r),r={distance:t.distanceTo(i),angleToNorth:r},this.dispatchEvent({type:"measure",content:r})),0==a.root.children.length&&(o=new THREE.PointCloud(pickedPointGeom.clone(),s),a.root.add(o))},this.activate=function(){this.isActive||(this.domElement=this.scene.canvas,resulstLayerConfig={offset:this.scene.config.offset,layerGroup:"User-generated"},a=new GIScene.Layer("Measurements",resulstLayerConfig),this.scene.addLayer(a),i=THREE.ImageUtils.loadTexture(GIScene.LIBRARYPATH+GIScene.RESOURCESPATH.replace(/([^\/])$/,"$1/")+"resources/images/particle_cross.png"),s=new THREE.PointCloudMaterial({color:this.config.color,sizeAttenuation:!1,size:32,map:i,alphaTest:.5}),c=new THREE.LineBasicMaterial({color:this.config.color,linewidth:1}),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mouseup",l,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.domElement.removeEventListener("mousedown",n,!1),this.domElement.removeEventListener("mouseup",l,!1),this.scene.disposeLayer(a),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Measure.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.LoadIndicator=function(){GIScene.Control.call(this),this.domElement=null,this.indicatorElement=null;var e=0,t=function(){0==e&&this.domElement.appendChild(this.indicatorElement),e++}.bind(this),i=function(){0==--e&&this.domElement.removeChild(this.indicatorElement)}.bind(this);this.activate=function(){var e;this.isActive||(this.domElement=this.scene.containerDiv,this.indicatorElement=((e=document.createElement("div")).setAttribute("id","GIScene_LoadIndicator_wrapper"),e.setAttribute("style","bottom: 20px;font-family: Sans-serif;left: 50%;opacity: 1;position: absolute;text-shadow: 0 0 2px #000000;color:#FFFFFF;font-weight:bold;letter-spacing:2px;"),e.textContent="Loading...",e),GIScene.ModelLoader.prototype.addEventListener("beforeLoad",t),GIScene.ModelLoader.prototype.addEventListener("load",i),GIScene.ModelLoader.prototype.addEventListener("abort",i),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(GIScene.ModelLoader.prototype.removeEventListener("beforeLoad",t),GIScene.ModelLoader.prototype.removeEventListener("load",i),GIScene.ModelLoader.prototype.removeEventListener("abort",i),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.LoadIndicator.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.Compass=function(e,t){GIScene.Control.call(this);this.config=GIScene.Utils.mergeObjects({},t||{}),this.camera=e;var n=0,i=new THREE.Texture(null),r=new Image;r.onload=function(){i.image=r,i.needsUpdate=!0},r.src="data:image/png;base64,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";e=new THREE.SpriteMaterial({map:i,opacity:1});this.sprite=new THREE.Sprite(e),this.sprite.scale.set(100,100,1),this.update=function(){var e=this.camera.localToWorld(this.camera.target.position.clone()),t=this.camera.position,i=e.sub(t),e=new THREE.Vector3(0,1,0),t=new THREE.Vector3(0,0,-1),i=i.projectOnPlane(e),e=i.clone().cross(e).angleTo(t)>Math.PI/2,t=i.angleTo(t),t=e?t:2*Math.PI-t;n=THREE.Math.radToDeg(t),this.sprite.material.rotation=t}.bind(this),this.getCompassDegrees=function(){return n};var o=function(){this.sprite.position.set(-this.scene.canvas.width/2+60,this.scene.canvas.height/2-60,0)}.bind(this);this.activate=function(){this.isActive||(this.scene.spriteRoot.add(this.sprite),this.sprite.position.set(-this.scene.canvas.width/2+60,this.scene.canvas.height/2-60,0),this.update(),this.scene.addEventListener("cameraChange",this.update),window.addEventListener("resize",o,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.sprite),this.scene.removeEventListener("cameraChange",this.update),window.removeEventListener("resize",o,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.Compass.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.AxisHelper=function(e,t){GIScene.Control.call(this);this.config=GIScene.Utils.mergeObjects({size:50},t||{}),this.camera=e,this.axisHelper=new THREE.AxisHelper(this.config.size);var i=function(){this.axisHelper.rotation.setFromRotationMatrix(this.camera.matrixWorldInverse.extractRotation(this.camera.matrixWorldInverse))}.bind(this),n=function(){this.axisHelper.position.set(-this.scene.canvas.width/2+60,-this.scene.canvas.height/2+60,0)}.bind(this);this.activate=function(){this.isActive||(this.scene.spriteRoot.add(this.axisHelper),this.axisHelper.position.set(-this.scene.canvas.width/2+60,-this.scene.canvas.height/2+60,0),i(),this.scene.addEventListener("cameraChange",i),window.addEventListener("resize",n,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.axisHelper),this.scene.removeEventListener("cameraChange",i),window.removeEventListener("resize",n,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.AxisHelper.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.TextPanel=function(e){GIScene.Control.call(this);this.config=GIScene.Utils.mergeObjects({width:256,height:100,text:["Hello World","Zeile 2"],textAlign:"start",pxFromLeft:0,pxFromTop:400,fontSize:10,lineSpace:6,fontFamily:"sans-serif",fontStyle:"normal",color:"ivory",halo:"black"},e||{}),this.height=this.config.height;var t=this.config.text instanceof Array?this.config.text:[this.config.text],i=t.length,n="left"==this.config.textAlign||"start"==this.config.textAlign?0:"center"==this.config.textAlign?this.config.width/2:this.config.width;this.canvas2d=document.createElement("canvas"),this.canvas2d.width=this.config.width,this.canvas2d.height=this.height,this.context2d=this.canvas2d.getContext("2d"),this.context2d.textBaseline="middle",this.context2d.font=this.config.fontStyle+" "+this.config.fontSize+"pt "+this.config.fontFamily,this.context2d.textAlign=this.config.textAlign,this.context2d.fillStyle=this.config.color,this.context2d.shadowColor=this.config.halo,this.context2d.shadowBlur=3,this.texture=new THREE.Texture(this.canvas2d);e=new THREE.SpriteMaterial({map:this.texture,opacity:1});this.sprite=new THREE.Sprite(e),this.sprite.scale.set(this.config.width,this.height,1),this.update=function(){this.context2d.clearRect(0,0,this.config.width,this.height);for(var e=0;e<i;e++)this.context2d.fillText(t[e],n,this.height/2-(i-1)*(this.config.fontSize+this.config.lineSpace)/2+e*(this.config.fontSize+this.config.lineSpace));this.texture.needsUpdate=!0}.bind(this),this.setText=function(e){t=e instanceof Array?e:[e],i=t.length,this.update()}.bind(this),this.activate=function(){this.isActive||(this.scene.spriteRoot.add(this.sprite),this.sprite.position.set(-this.scene.canvas.width/2+this.config.width/2+this.config.pxFromLeft,this.config.pxFromTop,0),this.texture.needsUpdate=!0,this.update(),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.spriteRoot.remove(this.sprite),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.TextPanel.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.ObjectPosition=function(e){GIScene.Control.call(this),this.object=e,this.height=54,this.textPanel=new GIScene.Control.TextPanel({height:this.height,width:200,textAlign:"left",pxFromLeft:10,fontSize:10}),this.updateCoords=function(){var t=[];this.object.position.clone().add(this.scene.config.offset.toVector3()).toArray().forEach(function(e){t.push(e.toFixed(3))}),this.textPanel.setText(["Height: "+t[1],"X Y: "+t[0]+" "+-t[2]])}.bind(this);var t=function(){this.textPanel.sprite.position.set(-this.scene.canvas.width/2+this.textPanel.config.width/2+this.textPanel.config.pxFromLeft,-this.scene.canvas.height/2+this.height/2,0)}.bind(this);this.activate=function(){this.isActive||(this.textPanel.setScene(this.scene),this.textPanel.activate(),this.textPanel.sprite.position.set(-this.scene.canvas.width/2+this.textPanel.config.width/2+this.textPanel.config.pxFromLeft,-this.scene.canvas.height/2+this.height/2,0),this.scene.addEventListener("cameraChange",this.updateCoords),window.addEventListener("resize",t,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.textPanel.deactivate(),this.scene.removeEventListener("cameraChange",this.updateCoords),window.removeEventListener("resize",t,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.ObjectPosition.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.SSAO=function(){var e,t,i,n,r,o,a,s,c;GIScene.Control.call(this);function l(e){console.log("chPrj2",c),h()}var h=function(){c=this.scene.camera instanceof THREE.CombinedCamera?this.scene.camera.inPerspectiveMode?this.scene.camera.cameraP:this.scene.camera.cameraO:this.scene.camera,s=c.clone(),this.scene.camera.add(s),s.near=.1,s.far=1e3,s.updateProjectionMatrix()}.bind(this),d=function(){t.uniforms.tDepth.value=n,t.uniforms.size.value.x=this.scene.canvas.width,t.uniforms.size.value.y=this.scene.canvas.height,t.uniforms.cameraNear.value=s.near,t.uniforms.cameraFar.value=s.far}.bind(this),u=function(){this.scene.root.overrideMaterial=a,this.scene.renderer.clearTarget(n,!0,!0,!1),this.scene.renderer.render(this.scene.root,s,n),this.scene.root.overrideMaterial=null}.bind(this),m=function(){h(),n=new THREE.WebGLRenderTarget(this.scene.canvas.width,this.scene.canvas.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),d(),i.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height)}.bind(this);this.activate_=function(){this.isActive||(e=new THREE.RenderPass(this.scene.root,this.scene.camera),t=new THREE.ShaderPass(THREE.SSAOShader),n=new THREE.WebGLRenderTarget(this.scene.canvas.width,this.scene.canvas.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),r=THREE.ShaderLib.depthRGBA,o=THREE.UniformsUtils.clone(r.uniforms),(a=new THREE.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:o})).blending=THREE.NoBlending,this.scene.addEventListener("beforeRender",u),t.uniforms.tDepth.value=n,t.uniforms.size.value.x=this.scene.canvas.width,t.uniforms.size.value.y=this.scene.canvas.height,t.uniforms.cameraNear.value=this.scene.camera.near,t.uniforms.cameraFar.value=this.scene.camera.far,t.uniforms.onlyAO.value=1,t.renderToScreen=!0,this.scene.effectComposer.addPass(e),this.scene.effectComposer.addPass(t)),GIScene.Control.prototype.activate.call(this)},this.activate=function(){this.isActive||(n=new THREE.WebGLRenderTarget(this.scene.canvas.width,this.scene.canvas.height,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),r=THREE.ShaderLib.depthRGBA,o=THREE.UniformsUtils.clone(r.uniforms),(a=new THREE.ShaderMaterial({fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:o})).blending=THREE.NoBlending,h(),e=new THREE.RenderPass(this.scene.root,this.scene.camera),t=new THREE.ShaderPass(THREE.SSAOShader),i=new THREE.ShaderPass(THREE.FXAAShader),d(),t.renderToScreen=!0,i.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height),i.renderToScreen=!1,this.scene.addEventListener("beforeRender2",u),this.scene.effectComposer.passes=[e,i,t],window.addEventListener("resize",m,!1),this.scene.camera.addEventListener("changedProjection",l),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.effectComposer.passes=[],this.scene.camera.remove(s),this.scene.removeEventListener("beforeRender2",u),window.removeEventListener("resize",m,!1),this.scene.camera.removeEventListener("changedProjection",l),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.SSAO.prototype=Object.create(GIScene.Control.prototype),GIScene.Control.EdgeDetectionFreiChen=function(){GIScene.Control.call(this);var e,t=null,i=1,n=1,r=.5,o=function(){t.uniforms.aspect.value.set(this.scene.canvas.width,this.scene.canvas.height),fxaaEffect.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height)}.bind(this);this.setIntensity=function(e){i=e,t&&(t.uniforms.intensity.value=i)},this.getIntensity=function(){return i},this.setThreshold=function(e){r=e,t&&(t.uniforms.threshold.value=r)},this.getThreshold=function(){return r},this.invert=function(){n=1==n?0:1,t&&(t.uniforms.invert.value=n)},this.activate=function(){this.isActive||(depthShader=THREE.ShaderLib.depthRGBA,depthUniforms=THREE.UniformsUtils.clone(depthShader.uniforms),depthMaterial=new THREE.ShaderMaterial({fragmentShader:depthShader.fragmentShader,vertexShader:depthShader.vertexShader,uniforms:depthUniforms}),depthMaterial.blending=THREE.NoBlending,e=new THREE.RenderPass(this.scene.root,this.scene.camera),unpackDepthRGBAEffect=new THREE.ShaderPass(THREE.UnpackDepthRGBAShader),unpackDepthRGBAEffect.renderToScreen=!1,(t=new THREE.ShaderPass(THREE.EdgeShader)).uniforms.aspect.value.set(this.scene.canvas.width,this.scene.canvas.height),t.uniforms.intensity.value=i,t.uniforms.invert.value=n,t.uniforms.threshold.value=r,t.renderToScreen=!1,fxaaEffect=new THREE.ShaderPass(THREE.FXAAShader),fxaaEffect.uniforms.resolution.value.set(1/this.scene.canvas.width,1/this.scene.canvas.height),fxaaEffect.renderToScreen=!0,this.scene.effectComposer.addPass(e),this.scene.effectComposer.addPass(t),this.scene.effectComposer.addPass(fxaaEffect),window.addEventListener("resize",o,!1),GIScene.Control.prototype.activate.call(this))},this.deactivate=function(){this.isActive&&(this.scene.effectComposer.passes=[],window.removeEventListener("resize",o,!1),GIScene.Control.prototype.deactivate.call(this))}},GIScene.Control.EdgeDetectionFreiChen.prototype=Object.create(GIScene.Control.prototype),GIScene.Process=function(e){this.config=GIScene.Utils.mergeObjects({identifier:null,title:null,abstract:null,metadata:null,processVersion:null,description:{inputs:[],outputs:[]}},e||{}),this.identifier=this.config.identifier,this.title=this.config.title,this.abstract=this.config.abstract,this.metadata=this.config.metadata,this.processVersion=this.config.processVersion,this.description=this.config.description,this.data={inputs:{},outputs:{}}},GIScene.Process.prototype={constructor:GIScene.Process,setInput:function(e,t){this.data.inputs[e]=t},setInputs:function(e){for(param in e)this.setInput(param,e[param])},getOutput:function(e){return this.data.outputs[e]},getOutputs:function(){return this.data.outputs},getParamDescriptionById:function(n){var e=this.description.inputs,t=this.description.outputs,t=e.concat(t).filter(function(e,t,i){return e.identifier==n});return t=0==t.length?void 0:t[0]},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Process.LineOfSight=function(){GIScene.Process.apply(this,[{identifier:"GIScene:lineOfSight",title:"Line of Sight",abstract:"Given two loactions and possible obstacle objects this process will compute the visibility between the two loactions and provides a graphical 3D line.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:lineOfSight:observerPoint",title:"Observer Point",abstract:"Point of Observer, where the line of sight starts.",dataType:"THREE.Vector3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:observerOffset",title:"Observer Offset",abstract:"Additional height offset to observer point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:targetPoint",title:"Tartget Point",abstract:"Point of Target, where the line of sight ends.",dataType:"THREE.Vector3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:targetOffset",title:"Target Offset",abstract:"Additional height offset to target point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:obstacles",title:"Obstacles",abstract:"Possible obstacles to be reflected in the calculation.",dataType:"Array(THREE.Mesh)",minOccurs:1,maxOccurs:1}],outputs:[{identifier:"GIScene:lineOfSight:lineOfSight",title:"Line Of Sight",abstract:"The calculated Line of Sight between observer and target.",dataType:"THREE.Object3D"},{identifier:"GIScene:lineOfSight:isVisible",title:"Target is visible",abstract:"The result of the visibility calculation.",dataType:"boolean"}]}}]),this.config.description.inputs.forEach(function(e,t,i){null!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this)),this.raycaster=new THREE.Raycaster;var s=new THREE.LineBasicMaterial({color:new THREE.Color(65280)}),c=new THREE.LineBasicMaterial({color:new THREE.Color(16711680)});this.execute=function(){var e=this.data.inputs["GIScene:lineOfSight:observerPoint"],t=this.data.inputs["GIScene:lineOfSight:observerOffset"],i=this.data.inputs["GIScene:lineOfSight:targetPoint"],n=this.data.inputs["GIScene:lineOfSight:targetOffset"],r=this.data.inputs["GIScene:lineOfSight:obstacles"],e=e.clone().add(new THREE.Vector3(0,t,0)),t=i.clone().add(new THREE.Vector3(0,n,0)),i=t.clone().sub(e).normalize();this.raycaster.set(e,i),this.raycaster.far=e.distanceTo(t),console.log("far",this.raycaster.far);n=this.raycaster.intersectObjects(r,!0);console.log("intersections",n);var o,a,i=!0,r=new THREE.Object3D;return 0<n.length?(i=!1,(o=new THREE.Geometry).vertices=[e,n[0].point],a=new THREE.Line(o,s),(o=new THREE.Geometry).vertices=[n[0].point,t],o=new THREE.Line(o,c),r.add(a),r.add(o)):((o=new THREE.Geometry).vertices=[e,t],a=new THREE.Line(o,s),r.add(a)),this.data.outputs["GIScene:lineOfSight:lineOfSight"]=r,this.data.outputs["GIScene:lineOfSight:isVisible"]=i,console.log(this._listeners),this.dispatchEvent({type:"execute",content:this.data}),this.data}},GIScene.Process.LineOfSight.prototype=Object.create(GIScene.Process.prototype),GIScene.Process.LineOfSight_simpleClient=function(){GIScene.Process.apply(this,[{identifier:"GIScene:lineOfSight",title:"Line of Sight",abstract:"Given two locations and possible obstacle objects this process will compute the visibility between the two locations and provides a graphical 3D line.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:lineOfSight:observerPoint",title:"Observer Point",abstract:"Point of Observer, where the line of sight starts.",dataType:"GIScene.Coordinate3",maxOccurs:1},{identifier:"GIScene:lineOfSight:observerOffset",title:"Observer Offset",abstract:"Additional height offset to observer point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:targetPoint",title:"Tartget Point",abstract:"Point of Target, where the line of sight ends.",dataType:"GIScene.Coordinate3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:targetOffset",title:"Target Offset",abstract:"Additional height offset to target point.",dataType:"Number",minOccurs:0,maxOccurs:1,defaultValue:0},{identifier:"GIScene:lineOfSight:obstacleLayers",title:"Obstacle Layers",abstract:"Layers whose objects are possible obstacles to be reflected in the calculation.",dataType:"Array(GIScene.Layer)",minOccurs:1,maxOccurs:"unbounded"}],outputs:[{identifier:"GIScene:lineOfSight:lineOfSight",title:"Line Of Sight",abstract:"The calculated Line of Sight between observer and target.",dataType:"THREE.Object3D"},{identifier:"GIScene:lineOfSight:isVisible",title:"Target is visible",abstract:"The result of the visibility calculation.",dataType:"boolean"}]}}]),this.config.description.inputs.forEach(function(e,t,i){null!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this)),this.raycaster=new THREE.Raycaster;var z=new THREE.LineBasicMaterial({color:new THREE.Color(65280)}),V=new THREE.LineBasicMaterial({color:new THREE.Color(16711680)});this.execute=function(s){var e=this.data.inputs["GIScene:lineOfSight:observerPoint"];console.log("observerc3"),console.log(e);var d,c,t=this.data.inputs["GIScene:lineOfSight:observerOffset"],i=this.data.inputs["GIScene:lineOfSight:targetPoint"],n=this.data.inputs["GIScene:lineOfSight:targetOffset"],l=this.data.inputs["GIScene:lineOfSight:obstacleLayers"],s=s||function(){},r=l[0].scene,o=e.clone().sub(r.config.offset).toVector3(),a=i.clone().sub(r.config.offset).toVector3(),h=o.clone().add(new THREE.Vector3(0,t,0)),u=a.clone().add(new THREE.Vector3(0,n,0)),n=u.clone().sub(h).normalize(),m=null,f=0,p=!1;this.raycaster.set(h,n),this.raycaster.far=h.distanceTo(u),console.log("far",this.raycaster.far);function v(e,t){return!!t&&(m?(i=t,(m=(e=e).distance<i.distance?e:i)===t?(E(),!0):void 0):(m=t,E(),!0));var i}function g(e){for(var t=!1,i=0,n=e.length;i<n;i++){if(void 0===e[i]){t=-1;break}if(!0===e[i]){t=!0;break}}return t}var E=function(){if(b[0].LineOfSightAnalysisController)for(var e=0,t=b.length;e<t;e++){var n=b[e],r=m?n.grid.getIndexFromPoint2d(GIScene.Utils.vector3ToVector2(m.point),n.LineOfSightAnalysisController.smallestTileSize):void 0;n.LineOfSightAnalysisController.analysisTiles.forEach(function(e,t,i){r&&e.equals(r)&&(n.LineOfSightAnalysisController.nearestIntersectionTileIndex=t)}.bind(this))}},y=function(e){var n,t,i,r,o;if(e&&(n=e.LineOfSightAnalysisController),n&&(i=n.computeTileIndicesHandler,t=n.loading),e&&t){var a=0;for(tile in t.store)t.store[tile].object.abort(),a++,t.remove((new GIScene.Grid.Index).fromString(tile));console.log(e.name+": optimized uncached tiles by abort running requests: "+a)}i&&(e.computeTileIndicesHandler=i),f==l.length?(p=!0,console.log("Number of checked Layers",f,"Ready."),b.forEach(function(e,t,i){e.startUpdate(),e.LineOfSightAnalysisController=null,n=null,delete e.LineOfSightAnalysisController}),console.log("THE END"),i=new THREE.Object3D,m?(c=!1,(r=new THREE.Geometry).vertices=[h,m.point],o=new THREE.Line(r,z),(r=new THREE.Geometry).vertices=[m.point,u],r=new THREE.Line(r,V),i.add(o),i.add(r)):(c=!0,(r=new THREE.Geometry).vertices=[h,u],o=new THREE.Line(r,z),i.add(o)),this.data.outputs["GIScene:lineOfSight:lineOfSight"]=i,this.data.outputs["GIScene:lineOfSight:isVisible"]=c,this.dispatchEvent({type:"execute",content:this.data}),s(this.data)):console.log("Number of checked Layers",f)}.bind(this),S=function(i,n){var r=n.LineOfSightAnalysisController,o=r.loading,a=r.controlArray,s=r.uncachedTilesIndex,c=r.uncachedTiles[i],e=n.config.service.getGetSceneUrl(c,n.grid),t=function(e){var t=!0;console.log(n.name+": LineOfSight:load uncached tiles:onSuccess",i),r.layerChecked?console.log(n.name+": Analysis already DONE!"):(o.remove(c),console.log("nearestIntersectionTileIndex",r.nearestIntersectionTileIndex),i>r.nearestIntersectionTileIndex&&(console.log("already behind nearest intersection. SKIP processing loaded tile."),t=!1,a[s[i]]=!1),t&&("Z"==n.verticalAxis.toUpperCase()&&e.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),n.setOverrideMaterial(e,n.config.overrideMaterial),n.root.add(e),e.updateMatrixWorld(),e.traverse(function(e){e.geometry&&e.geometry.computeBoundingBox()}),0<(d=this.raycaster.intersectObject(n.root,!0)).length?(v(m,d[0])&&(r.nearestIntersectionTileIndex=s[i]),console.log("nearestIntersectionTileIndex",r.nearestIntersectionTileIndex),a[s[i]]=!0):a[s[i]]=!1,n.root.remove(e)),n.cache.add(c,e),e=g(a),console.log("doreturnResults?",-1!==e),console.log("intersectionsLength: ",d.length),console.log("Loading Requests:",o.length),-1!==e&&(f++,r.layerChecked=!0,console.log(n.name+" : firstIntersection found! Layer checked by UNCACHED!"),y(n)))}.bind(this),l=function(e){console.log(e),console.log(n.name+": LineOfSight:load uncached tiles:onError",i),o.remove(c),alert("XHRError")}.bind(this),h=new GIScene.ModelLoader;h.load(e,n.format,t,void 0,l),o.add(c,h)}.bind(this),b=[],T=[];l.forEach(function(e,t,i){(e instanceof GIScene.Layer.Grid?b:T).push(e)}),console.log("obstacle layers",l.length),console.log("static layers",T.length),console.log("grid layers",b.length);for(var w=0,R=T.length;w<R;w++)0<(d=this.raycaster.intersectObject(T[w].root,!0)).length&&v(m,d[0]),f++,console.log(T[w].name+" : Layer checked STATIC!"),y();for(w=0,R=b.length;w<R;w++){var M=(G=b[w]).grid;G.LineOfSightAnalysisController={},(x=G.LineOfSightAnalysisController).layerChecked=!1,x.loading=new GIScene.Grid.TileStore,x.smallestTileSize=M.tileSizes[M.tileSizes.length-1];var I=(new GIScene.Coordinate2).fromVector2(GIScene.Utils.vector3ToVector2(o.clone().add(M._sceneOffset))),L=(new GIScene.Coordinate2).fromVector2(GIScene.Utils.vector3ToVector2(a.clone().add(M._sceneOffset))),A=m?(new GIScene.Coordinate2).fromVector2(GIScene.Utils.vector3ToVector2(m.point.clone().add(M._sceneOffset))):L,L=M.getTilesFromLineIntersection(I,L,x.smallestTileSize);x.analysisTiles=M.getTilesFromLineIntersection(I,A,x.smallestTileSize),console.log(G.name+": "+A.toArray()),console.log(G.name+": optimized number of tiles: "+x.analysisTiles.length+"/"+L.length+" "+100*x.analysisTiles.length/L.length+"%"),x.controlArray=new Array(x.analysisTiles.length),x.computeTileIndicesHandler=G.computeTileIndicesHandler,G.stopUpdate(),G.computeTileIndicesHandler=function(){return[]},G.update(),x.cachedTiles=[],x.cachedTilesIndex=[],x.uncachedTiles=[],x.uncachedTilesIndex=[],x.nearestIntersectionTileIndex=void 0,x.analysisTiles.forEach(function(e,t,i){var n=G.cache.getTile(e);n?(x.cachedTiles.push(n),x.cachedTilesIndex.push(t)):(x.uncachedTiles.push(e),x.uncachedTilesIndex.push(t))}.bind(this)),console.log(G.name+": cached / uncached tiles",x.cachedTiles.length,x.uncachedTiles.length)}for(w=0,R=b.length;w<R;w++){var x=(G=b[w]).LineOfSightAnalysisController;console.log("Start Analyzing "+G.name),console.log(G.name+": Analyzing "+x.cachedTiles.length+" CACHED tiles");for(var C=0,D=x.cachedTiles.length;C<D;C++){var H=x.cachedTiles[C];G.root.add(H),0<(d=this.raycaster.intersectObject(G.root,!0)).length?(v(m,d[0])&&(x.nearestIntersectionTileIndex=x.cachedTilesIndex[C]),console.log("nearestIntersectionTileIndex",x.nearestIntersectionTileIndex),x.controlArray[x.cachedTilesIndex[C]]=!0):x.controlArray[x.cachedTilesIndex[C]]=!1,G.root.remove(H);H=g(x.controlArray);if(console.log(G.name+" :firstIntersectionTile",H,x.controlArray.length),-1!==H){f++,console.log(G.name+" : firstIntersection found! Layer checked by CACHED!"),y(G),x.layerChecked=!0;break}}}if(!p)for(w=0,R=b.length;w<R;w++){var G=b[w];if((x=G.LineOfSightAnalysisController).layerChecked)return;if(m){for(var O=null,P=x.uncachedTilesIndex.length-1;0<=P;P--)x.uncachedTilesIndex[P]>=x.nearestIntersectionTileIndex&&(O=P);if(null!=O){console.log("controlArray:before",x.controlArray);var k=x.uncachedTiles.length;x.uncachedTiles.splice(O,Number.MAX_VALUE);for(var j=O,F=k;j<F;j++)x.controlArray[x.uncachedTilesIndex[j]]=!1;x.uncachedTilesIndex.splice(O,Number.MAX_VALUE),console.log(G.name+": optimized number of uncached tiles: "+k+"--\x3e"+x.uncachedTiles.length)}}console.log(G.name+": Analyzing "+x.uncachedTiles.length+" UNCACHED tiles");for(var B=0,U=x.uncachedTiles.length;B<U;B++)S(B,G)}}},GIScene.Process.LineOfSight_simpleClient.prototype=Object.create(GIScene.Process.prototype),GIScene.Process.Intervisibility=function(f){GIScene.Process.apply(this,[{identifier:"GIScene:intervisibility",title:"Intervisibility",abstract:"Given two loactions, observer and target offsets and possible obstacle objects this process will compute the intervisibility between each observer and target of the two loactions and provides graphical 3D lines.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:intervisibility:points",title:"Intervisibility Points",abstract:"Two points between the intervisibility will be calculated. Each point should provide attributes about observer and target offset.",dataType:"Array of GIScene.Coordinate3",minOccurs:1,maxOccurs:1},{identifier:"GIScene:intervisibility:observerOffsets",title:"Observer Offsets",abstract:"Additional height offsets to the observer points.",dataType:"Array of Number",minOccurs:0,maxOccurs:1,defaultValue:[]},{identifier:"GIScene:intervisibility:targetOffsets",title:"Target Offsets",abstract:"Additional height offsets to the target points.",dataType:"Array of Number",minOccurs:0,maxOccurs:1,defaultValue:[]},{identifier:"GIScene:intervisibility:obstacleLayers",title:"Obstacle Layers",abstract:"Layers with possible obstacles to be reflected in the calculation.",dataType:"Array(GIScene.Layer)",minOccurs:1,maxOccurs:1}],outputs:[{identifier:"GIScene:intervisibility:intervisibilityLines",title:"Intervisibility Lines",abstract:"The calculated Lines of Sight between observers and targets.",dataType:"THREE.Object3D"},{identifier:"GIScene:intervisibility:intervisibility",title:"Intervisibility",abstract:'The result of the intervisibility calculation.<ul><li>"00": Both observer can NOT see their targets.</li><li>"01": The target of the second point is visible to the observer of the first one.</li><li>"10": The target of the first point is visible to the observer of the second one.</li><li>"11": Both observer can see their targets. They are intervisible.</li></ul>',dataType:"String"},{identifier:"GIScene:intervisibility:intervisibilityLine",title:"Intervisibility Line",abstract:"One feature (LineString) representing the relation between the two tested points, indicated by it's intervisibility attribute",dataType:"GeoJSON"}]}}]),this.config.description.inputs.forEach(function(e,t,i){null!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this));var p=new THREE.LineBasicMaterial({color:new THREE.Color(65280)}),v=new THREE.LineBasicMaterial({color:new THREE.Color(16711680)});this.execute=function(o){var a=this.data.inputs["GIScene:intervisibility:points"],s=this.data.inputs["GIScene:intervisibility:observerOffsets"],c=this.data.inputs["GIScene:intervisibility:targetOffsets"],e=this.data.inputs["GIScene:intervisibility:obstacleLayers"];o=o||function(){};function l(e,t,i){var n=i?p:v,r=new THREE.Geometry;return r.vertices=[e,t],n=new THREE.Line(r,n),i={isVisible:i},n.userData.gisceneAttributes=i,n.name="Line of Sight",n}var h,d=0<s.length||0<c.length,u=[a[0].toVector3(),a[1].toVector3()],i=function(){var e=new THREE.Object3D;e.userData.gisceneAttributes={},e.name="Intervisibility";var t,i=m.getOutput("GIScene:lineOfSight:isVisible"),n=u[0].clone().add(new THREE.Vector3(0,s[0]||0,0)),r=u[1].clone().add(new THREE.Vector3(0,c[1]||0,0)),n=l(n,r,i);e.add(n),d&&(t=h.getOutput("GIScene:lineOfSight:isVisible"),r=u[1].clone().add(new THREE.Vector3(0,s[1]||0,0)),n=u[0].clone().add(new THREE.Vector3(0,c[0]||0,0)),n=l(r,n,t),e.add(n));i=d?Number(t)+""+Number(i):Number(i)+""+Number(i);e.userData.gisceneAttributes.intervisibility=i,this.data.outputs["GIScene:intervisibility:intervisibilityLines"]=e,this.data.outputs["GIScene:intervisibility:intervisibility"]=i;i={type:"Feature",geometry:{type:"LineString",coordinates:[a[0].toArray(),a[1].toArray()]},properties:{intervisibility:i}};f.config.projection&&(i.crs={type:"name",properties:{name:f.config.projection}}),this.data.outputs["GIScene:intervisibility:intervisibilityLine"]=JSON.stringify(i),this.dispatchEvent({type:"execute",content:this.data}),o(this.data)}.bind(this),m=new GIScene.Process.LineOfSight_simpleClient;m.setInput("GIScene:lineOfSight:observerPoint",a[0]),s[0]&&m.setInput("GIScene:lineOfSight:observerOffset",s[0]),m.setInput("GIScene:lineOfSight:targetPoint",a[1]),c[1]&&m.setInput("GIScene:lineOfSight:targetOffset",c[1]),m.setInput("GIScene:lineOfSight:obstacleLayers",e),d&&((h=new GIScene.Process.LineOfSight_simpleClient).setInput("GIScene:lineOfSight:observerPoint",a[1]),s[1]&&h.setInput("GIScene:lineOfSight:observerOffset",s[1]),h.setInput("GIScene:lineOfSight:targetPoint",a[0]),c[0]&&h.setInput("GIScene:lineOfSight:targetOffset",c[0]),h.setInput("GIScene:lineOfSight:obstacleLayers",e));e=function(e){var t;d?(t=function(e){i()}.bind(this),h.execute(t)):i()}.bind(this);m.execute(e)}},GIScene.Process.Intervisibility.prototype=Object.create(GIScene.Process.prototype),GIScene.Process.LineOfSightNetwork_allToAll=function(){GIScene.Process.apply(this,[{identifier:"GIScene:lineOfSight:network:allToall",title:"Line of Sight Network (all to all)",abstract:"Given an input set of point locations with each of them providing an attribute for an observer offset and a target offset, this process will compute the intervisibility between the two locations by computing two lines of sights between each pair of points. Always from the observer offset of one point to the target offset of the other.",metadata:null,processVersion:"1.0",description:{inputs:[{identifier:"GIScene:lineOfSight:network:intervisibilityPoints",title:"Intervisibility Points (layer)",abstract:"Layer with points, which will be checked for intervisibility.",dataType:"GIScene.Layer",minOccurs:1,maxOccurs:1},{identifier:"GIScene:lineOfSight:network:observerOffsetAttribute",title:"Observer Offset Attribute",abstract:"Attribute with additional height offsets to observer points.",dataType:"String",minOccurs:0,maxOccurs:1,defaultValue:""},{identifier:"GIScene:lineOfSight:network:targetOffsetAttribute",title:"Tartget Offset Attribute",abstract:"Attribute with additional height offsets to target points.",dataType:"String",minOccurs:0,maxOccurs:1,defaultValue:""},{identifier:"GIScene:lineOfSight:obstacleLayers",title:"Obstacle Layers",abstract:"Layers whose objects are possible obstacles to be reflected in the calculation.",dataType:"Array(GIScene.Layer)",minOccurs:1,maxOccurs:"unbounded"}],outputs:[{identifier:"GIScene:lineOfSight:network:intervisibilityNetwork",title:"Intervisibility Network",abstract:"A set of calculated Line of Sights between observer and target points.",dataType:"THREE.Object3D"},{identifier:"GIScene:lineOfSight:network:numberOfVisibleTargets",title:"Number of visible targets",abstract:"The number of visible targets or unobstructed individual line of sights.",dataType:"Number"},{identifier:"GIScene:lineOfSight:network:numberOfObstructedTargets",title:"Number of obstructed targets",abstract:"The number of not visible targets or obstructed individual line of sights.",dataType:"Number"},{identifier:"GIScene:lineOfSight:network:numberOfIntervisiblePairs",title:"Number of intervisible pairs",abstract:"The number of intervisible pairs of input points.",dataType:"Number"},{identifier:"GIScene:lineOfSight:network:intervisibilityLines",title:"Intervisibility Lines",abstract:"FeatureCollection (LineStrings) representing the relations between the tested pairs of points, indicated by their intervisibility attributes.",dataType:"GeoJSON"}]}}]),this.config.description.inputs.forEach(function(e,t,i){null!=e.defaultValue&&this.setInput(e.identifier,e.defaultValue)}.bind(this)),this.execute=function(t){t=t||function(){};var i=this.data.inputs["GIScene:lineOfSight:network:intervisibilityPoints"],n=this.data.inputs["GIScene:lineOfSight:network:observerOffsetAttribute"],r=this.data.inputs["GIScene:lineOfSight:network:targetOffsetAttribute"],e=this.data.inputs["GIScene:lineOfSight:obstacleLayers"],o=0,a=[],s=[],c=[];i.root.traverse(function(e){var t;e.geometry&&(t=e.geometry.vertices[0],t=e.localToWorld(t.clone()),i.scene?(t=(new GIScene.Coordinate3).fromVector3(t).add(i.scene.config.offset),a.push(t),s.push(e.userData.gisceneAttributes[n]||0),c.push(e.userData.gisceneAttributes[r]||0)):console.error("LineOfSightNetwork_allToAll: Layer: "+i.name+" must be added to scene before analysing."))}.bind(this));var l=(a.length-1)*(a.length/2),h=new Array(l),d=new THREE.Object3D;d.name="Intervisibility Network",d.userData.gisceneAttributes={};for(var u=0,m=0,f=0,p=[],v=function(){d.userData.gisceneAttributes.numVisTargets=u,d.userData.gisceneAttributes.numUnvisTargets=m,d.userData.gisceneAttributes.numIntervisiblePairs=f,this.data.outputs["GIScene:lineOfSight:network:intervisibilityNetwork"]=d,this.data.outputs["GIScene:lineOfSight:network:numberOfVisibleTargets"]=u,this.data.outputs["GIScene:lineOfSight:network:numberOfObstructedTargets"]=m,this.data.outputs["GIScene:lineOfSight:network:numberOfIntervisiblePairs"]=f;var e={type:"FeatureCollection",features:p};i.scene.config.projection&&(e.crs={type:"name",properties:{name:i.scene.config.projection}}),this.data.outputs["GIScene:lineOfSight:network:intervisibilityLines"]=JSON.stringify(e),this.dispatchEvent({type:"execute",content:this.data}),t(this.data)}.bind(this),g=function(e){o++,console.log("onExecuteIntervis",o,"of",l),console.log(e);var t=e.outputs["GIScene:intervisibility:intervisibilityLines"];d.add(t);t=e.outputs["GIScene:intervisibility:intervisibility"];u+=parseInt(t)%9,m+=2-parseInt(t)%9,f+=parseInt(t)%9==2?1:0;e=JSON.parse(e.outputs["GIScene:intervisibility:intervisibilityLine"]);delete e.crs,p.push(e),this.dispatchEvent({type:"progress",content:{total:l,finished:o}}),o==l?v():h[o].execute(g)}.bind(this),E=0,y=0,S=a.length;y<S-1;y++)for(var b=y+1;b<S;b++){var T=new GIScene.Process.Intervisibility(i.scene),w={"GIScene:intervisibility:points":[a[y],a[b]],"GIScene:intervisibility:observerOffsets":[s[y],s[b]],"GIScene:intervisibility:targetOffsets":[c[y],c[b]],"GIScene:intervisibility:obstacleLayers":e};T.setInputs(w),h[E++]=T}h[0].execute(g)}},GIScene.Process.LineOfSightNetwork_allToAll.prototype=Object.create(GIScene.Process.prototype),GIScene.Format={JSON:0,JSONBinary:1,OBJ:2,Collada:3,CTM:4,Scene:5,GeoJSON:6},GIScene.LocalFileLoader=function(e,n,r,o,a){this.fileReader=new FileReader;var t=function(e){var t=e.target.files[0],i=t.name;switch(this.fileReader.onload=function(e){r&&r(this.fileReader.result,i)}.bind(this),this.fileReader.onprogress=function(e){o&&o(e,i)},this.fileReader.onerror=function(e){a&&a(this.fileReader.error,i)}.bind(this),n.toUpperCase()){case"TEXT":this.fileReader.readAsText(t);break;case"DATAURL":this.fileReader.readAsDataURL(t);break;case"BINARYSTRING":this.fileReader.readAsBinaryString(t);break;case"ARRAYBUFFER":this.fileReader.readAsArrayBuffer(t)}}.bind(this);e.addEventListener("change",t,!1)},GIScene.GeoJSONLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.loader=new THREE.XHRLoader(this.manager),this.symbol=THREE.ImageUtils.loadTexture(GIScene.LIBRARYPATH+GIScene.RESOURCESPATH.replace(/([^\/])$/,"$1/")+"resources/images/particle_cross.png")},GIScene.GeoJSONLoader.prototype={constructor:GIScene.GeoJSONLoader,load:function(e,i,t,n,r){var o=this.loader;o.setCrossOrigin(this.crossOrigin),o.load(e,function(t){try{this.parse(JSON.parse(t),i,r)}catch(e){console.log("GeoJsonLoader"),console.log(e),console.log("ResponseText",t),n&&n(e,t)}}.bind(this))},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t,i){var n=new THREE.Scene,r=e.type;t=t||function(){};function o(e,t){return t=t||0,new THREE.Vector3(e[0],t,-e[1])}function a(e,t){return t=parseFloat(e.properties[t])||null,(t=s(e.geometry,t)).userData.gisceneAttributes=e.properties,t}var s=function(e,t){var i,n,r=e.type;return"Point"===r?(i=new THREE.Geometry,!t&&2<e.coordinates.length?(n=e.coordinates,new THREE.Vector3(n[0],n[2],-n[1])):o(e.coordinates,t),i.vertices.push(o(e.coordinates,t)),n=new THREE.PointCloudMaterial({color:new THREE.Color(16711680),sizeAttenuation:!1,size:32,map:this.symbol,alphaTest:.5}),n=new THREE.PointCloud(i,n)):console.error(r,"Not supported by GeoJSONLoader"),n}.bind(this);switch(r){case"Feature":n.add(a(e,i));break;case"FeatureCollection":for(var c=e.features,l=0,h=c.length;l<h;l++)n.add(a(c[l],i));break;default:console.log(r,"GeoJson type not supported by GeoJSONLoader")}return t(n),n},getType:function(e){return e.type},getExampleValues:function(e){switch(this.getType(e)){case"Feature":var t=[];for(property in i=e.properties)t.push(i[property]);return t;case"FeatureCollection":var i,t=[];for(property in i=e.features[0].properties)t.push(i[property]);return t;default:return this.isGeometry(e)||alert("GeoJSON seems to be invalid"),[]}},getAttributeNames:function(e){switch(this.getType(e)){case"Feature":return Object.keys(e.properties);case"FeatureCollection":return Object.keys(e.features[0].properties);default:return this.isGeometry(e)||alert("GeoJSON seems to be invalid"),[]}},isGeometry:function(e){return"Point"==e.type||"MultiPoint"},hasZCoordinates:function(e){function t(e){return"object"==typeof e[0]?findFirstCoordinate(e[0]):2<e.length}function i(e){return"GeometryCollection"==e.type?t(e.geometries[0].coordinates):t(e.coordinates)}function n(e){return i(e.geometry)}var r=this.getType(e);switch(r){case"Feature":return n(e);case"FeatureCollection":return n(e.features[0]);default:return i(e)}}},GIScene.ModelLoader=function(){this.url=null;var s=this.format=null;this.loader=null;var c=function(e,t){var i,n;this.format==GIScene.Format.Scene?n=e.scene:(i=0==e.faces.length?"PointCloud":"Mesh",t=t&&0!=t.length?2<=t.length?new THREE.MeshFaceMaterial(t):t[0].map||"default"!=t[0].name.toLowerCase()?"PointCloud"==i?(t[0].size=.2,t[0].vertexColors=THREE.VertexColors,new THREE.PointCloudMaterial(t[0])):t[0]:"Mesh"==i?new THREE.MeshLambertMaterial({color:13808780,ambient:9139029,emissive:0,shading:THREE.FlatShading}):new THREE.PointCloudMaterial({color:new THREE.Color(0),size:.2}):"Mesh"==i?0<e.faces[0].vertexColors.length?new THREE.MeshLambertMaterial({shading:THREE.FlatShading,vertexColors:THREE.VertexColors}):16777215!=e.faces[0].color.getHex()?new THREE.MeshLambertMaterial({shading:THREE.FlatShading,vertexColors:THREE.FaceColors}):new THREE.MeshLambertMaterial({color:13808780,ambient:9139029,emissive:0,shading:THREE.FlatShading}):void 0,e.dynamic=!0,t=new THREE[i](e,t),(n=new THREE.Scene).add(t)),this.dispatchEvent({type:"load",content:n}),s&&s(n)}.bind(this);this.load=function(t,e,i,n,r){var o=5;switch(s=i,this.dispatchEvent({type:"beforeLoad",content:null}),this.url=t,this.format=e){case GIScene.Format.JSON:this.loader=new THREE.JSONLoader,this.loader.load(t,c);break;case GIScene.Format.JSONBinary:this.loader=new THREE.BinaryLoader,this.loader.load(t,c);break;case GIScene.Format.CTM:this.loader=new THREE.CTMLoader,this.loader.load(t,c,{useWorker:!0,useBuffers:!1});break;case GIScene.Format.Scene:this.loader=new THREE.SceneLoader;var a=function(e){0<--o?(console.log("Retrying...: "+t),setTimeout(function(){this.loader.load(t,c,n,a)}.bind(this),1e3)):(console.error("Tried 5 times without success: "+t),r(e))}.bind(this);this.loader.load(t,c,n,a);break;default:console.log("Unknown Format. - GIScene/ModelLoader.js")}},this.abort=function(){this.loader.loader&&this.loader.loader.request?(this.loader.loader.request.abort(),this.dispatchEvent({type:"abort",content:null})):console.log("abort for this loader not yet implemented.")}},GIScene.ModelLoader.prototype={constructor:GIScene.ModelLoader,addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Service=function(){},GIScene.Service.W3DS_0_4_0=function(e,t){this.config=GIScene.Utils.mergeObjects({url:null,withCredentials:!1,tileSizes:null},e),this.params=GIScene.Utils.mergeObjects({service:"W3DS",version:"0.4.0",format:"model/threejs",crs:null,layer:null,offset:null},t),this.url=this.config.url.trim().replace(/(\/|\?)*$/,"?"),this.getGetSceneUrl=function(e,t){e.tileSize;var i=t.getBoundingBoxFromIndex(e),e=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(i.left,i.bottom)).add(t.sceneOffset).toArray().join(","),t=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(i.right,i.top)).add(t.sceneOffset).toArray().join(","),t=["SERVICE="+this.params.service,"REQUEST=GetScene","VERSION="+this.params.version,"CRS="+this.params.crs,"BOUNDINGBOX="+e+","+t,"FORMAT="+this.params.format,"LAYERS="+this.params.layer,this.params.offset?"OFFSET="+this.params.offset:""].join("&");return this.url+t},this.getGetTileUrl=function(e){var t=this.config.tileSizes.indexOf(e.tileSize),i=e.x,e=e.y,e=["SERVICE="+this.params.service,"REQUEST=GetTile","VERSION="+this.params.version,"FORMAT="+this.params.format,"CRS="+this.params.crs,"LAYER="+this.params.layer,"TILELEVEL="+t,"TILECOL="+i,"TILEROW="+e].join("&");return this.url+e},this.getTile=function(e,t,i){e=this.getGetTileUrl(e);t=t||function(){},i=i||function(){};var n=new XMLHttpRequest;n.addEventListener("load",t,!1),n.addEventListener("error",i,!1),n.addEventListener("error",function(e){console.log("Error on GIScene.Service.W3DS_0_4_0"),console.log(e)},!1),n.open(method,e,!0),n.withCredentials=this.config.withCredentials;try{n.send(null)}catch(e){console.log(e)}}},GIScene.Service.W3DS_0_4_0.prototype=Object.create(GIScene.Service.prototype),GIScene.Service.W3DS_0_4_1=function(e,t){this.config=GIScene.Utils.mergeObjects({url:null,withCredentials:!1,tileSizes:null},e),this.params=GIScene.Utils.mergeObjects({service:"W3DS",version:"0.4.1",format:"model/threejs",crs:null,layer:null,offset:null,lods:null},t),this.url=this.config.url.trim().replace(/(\/|\?)*$/,"?"),this.getGetSceneUrl=function(e,t){e.tileSize;var i=t.getBoundingBoxFromIndex(e),e=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(i.left,i.bottom)).add(t.sceneOffset).toArray().join(","),t=(new GIScene.Coordinate2).fromVector2(new THREE.Vector2(i.right,i.top)).add(t.sceneOffset).toArray().join(","),t=["SERVICE="+this.params.service,"REQUEST=GetScene","VERSION="+this.params.version,"CRS="+this.params.crs,"BOUNDINGBOX="+e+","+t,"FORMAT="+this.params.format,"LAYERS="+this.params.layer,this.params.lods?"LOD="+this.params.lods:"",this.params.offset?"OFFSET="+this.params.offset:""].join("&");return this.url+t},this.getGetTileUrl=function(e){var t=this.config.tileSizes.indexOf(e.tileSize),i=e.x,e=e.y,e=["SERVICE="+this.params.service,"REQUEST=GetTile","VERSION="+this.params.version,"FORMAT="+this.params.format,"CRS="+this.params.crs,"LAYER="+this.params.layer,"TILELEVEL="+t,"TILECOL="+i,"TILEROW="+e].join("&");return this.url+e},this.getTile=function(e,t,i){e=this.getGetTileUrl(e);t=t||function(){},i=i||function(){};var n=new XMLHttpRequest;n.addEventListener("load",t,!1),n.addEventListener("error",i,!1),n.addEventListener("error",function(e){console.log("Error on GIScene.Service.W3DS_0_4_0"),console.log(e)},!1),n.open(method,e,!0),n.withCredentials=this.config.withCredentials;try{n.send(null)}catch(e){console.log(e)}}},GIScene.Service.W3DS_0_4_0.prototype=Object.create(GIScene.Service.prototype),GIScene.Style=function(e){for(property in this.config=GIScene.Utils.mergeObjects({name:null,title:"unnamed",material:null,rootObjects:null,rootObjectKeyAttribute:null,rootObjectKeyValues:[],recursive:!0},e||{}),this.config)this[property]=this.config[property];this.id=GIScene.idCounter++,this.name=this.config.name||this.id},GIScene.Layer=function(e,t){var i={id:null,visibility:!0,opacity:1,overrideMaterial:null,projection:null,offset:new GIScene.Coordinate3(0,0,0),listeners:[],styles:[],attributeReader:null,properties:{fields:[]},attributeTable:[]};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.id=this.config.id||GIScene.idCounter++,this.name=null;var n=this.offset=null;this.root=null,this.scene=null,this.loader=null,this.visibility=null,this.selectControl=null,this.attributeReader=null,this.selectionQueryStack=null;t=new GIScene.Style({title:"default style",material:this.config.overrideMaterial});this.styles=[t],Array.prototype.push.apply(this.styles,this.config.styles),this.init=function(){this.name=e,this.root=new THREE.Scene,this.root.name="layer"+(this.name?"_"+this.name:""),this.offset=this.config.offset,this.loader=new GIScene.ModelLoader,this.attributeReader=this.config.attributeReader,this.visibility=this.config.visibility},this.add=function(e,t){t.add(e)},this.remove=function(e){e.parent.remove(e)},this.setScene=function(e){this.scene=e,this.dispatchEvent({type:"setScene",content:e})},this.setOpacity=function(t){this.root.traverse(function(e){GIScene.Utils.WorkingMaterial.setOpacity(e,t)})},this.addStyle=function(e){this.styles.push(e),this.dispatchEvent({type:"addStyle",content:{layer:this,style:e}})},this.removeStyle=function(e){for(var t=0,i=this.styles.length;t<i;t++)this.styles[t]===e&&(this.styles.splice(t,1),this.dispatchEvent({type:"removeStyle",content:{layer:this,style:e}}))},this.disposeStyle=function(e){this.removeStyle(e);var t=[],r=[];e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(t,e)||t.push(e)}):GIScene.Utils.arrayContains(t,e.material)||t.push(e.material)),t.forEach(function(e){for(var t=["map","lightMap","bumpMap","normalMap","specularMap","envMap","texture"],i=0,n=t.length;i<n;i++)e[t[i]]&&null!=e[t[i]]&&!GIScene.Utils.arrayContains(r,e[t[i]])&&r.push(e[t[i]])}),r.forEach(function(e){e.dispose()}),r=null,t.forEach(function(e){e.dispose()}),t=null,delete e.material,e=null},this.init();t=function(e){var t,i=e.content;this.offset=this.config.offset,n=i?this.offset.toVector3().sub(i.config.offset.toVector3()):new THREE.Vector3,this.root.position=n,this.root.updateMatrix(),this.root.updateMatrixWorld(),console.log("translateLayer: "+n.toArray()),i&&(this.selectControl=new GIScene.Control.Select([],i.camera,{multi:!0,selectColor:16744448}),this.selectControl.selectables=this.root.getDescendants(),i.addControl(this.selectControl),t=function(e){e.content===this&&(i.removeControl(this.selectControl),this.selectControl.selectables=[],this.selectControl=null,i.removeEventListener("beforeremovelayer",t))}.bind(this),i.addEventListener("beforeremovelayer",t))}.bind(this);this.addEventListener("setScene",t)},GIScene.Layer.prototype={constructor:GIScene.Layer,getObjectsBy:function(e){return GIScene.Utils.getObjectsBy(this.root,e)},selectByAttributes:function(e,t,i){t=t||this.root;this.selectionQueryStack=e instanceof Array?e:[e];for(var n=0,r=this.selectionQueryStack.length;n<r;n++){function o(e,t,i){return e.userData.gisceneAttributes[t]==i}var a=this.selectionQueryStack[n],s=a.attributeName,c=a.operator,l=a.value,a=a.selectMode||"new",h=[];switch(c){case"EQUALS_TO":h=GIScene.Utils.getObjectsBy(t,function(e){return o(e,s,l)});break;case"IN":for(n=0,r=l.length;n<r;n++){var d=GIScene.Utils.getObjectsBy(t,function(e){return o(e,s,l[n])});Array.prototype.push.apply(h,d)}break;case"CONTAINS":h=GIScene.Utils.getObjectsBy(t,function(e){return t=e,e=s,new RegExp(String(l),"gi").test(String(t.userData.gisceneAttributes[e]));var t})}switch(a){case"new":t.traverse(function(e){e.userData.isSelected&&this.selectControl.unselect(e,i)}.bind(this));for(n=0,r=h.length;n<r;n++)this.selectControl.select(h[n],i);break;case"add":var u=this.selectControl.config.toggle;this.selectControl.config.toggle=!1;for(n=0,r=h.length;n<r;n++)this.selectControl.select(h[n],i);this.selectControl.config.toggle=u}}},setOverrideMaterial:function(e,i,n){n=n||!0;(i instanceof THREE.Material||!i)&&(this.config.overrideMaterial=i,e.traverse(function(e){var t;e.material&&(this.dispatchEvent({type:"beforeSetOverrideMaterial",content:{object:e,overrideMaterial:i,layer:this}}),i?(e.userData.overriddenMaterial?!1===e.material.isShared&&GIScene.Utils.disposeObject(e,!1,!0,!0):e.userData.overriddenMaterial=e.material,n&&(t=GIScene.Utils.WorkingMaterial.getValues(e)),delete e.userData.originalMaterial,e.userData.workingMaterialFlags=0,e.material=this.config.overrideMaterial,n&&GIScene.Utils.WorkingMaterial.setValues(e,t)):e.userData.overriddenMaterial&&e.userData.overriddenMaterial instanceof THREE.Material&&(e.material=e.userData.overriddenMaterial,delete e.userData.overriddenMaterial),this.dispatchEvent({type:"afterSetOverrideMaterial",content:{object:e,overrideMaterial:i,layer:this}})),!this.config.overrideMaterial||this.config.overrideMaterial.shading!=THREE.SmoothShading||!e.geometry||e.geometry.normals&&0!=e.geometry.normals.length||e.geometry.computeVertexNormals()}.bind(this)))},setVisibility:function(t){this.root.traverse(function(e){e.visible=t}),this.visibility=t,this.dispatchEvent({type:"changedvisibility",content:{layer:this,visibility:this.visibility}})},showAttributeTable:function(){},getAttributeNames:function(){var t=[];return this.root.traverse(function(e){if(e.userData.gisceneAttributes&&0<Object.keys(e.userData.gisceneAttributes).length)return t=Object.keys(e.userData.gisceneAttributes)}),t},getExampleValues:function(){var t=[];return this.root.traverse(function(e){if(e.userData.gisceneAttributes&&0<Object.keys(e.userData.gisceneAttributes).length){for(attr in t=[],e.userData.gisceneAttributes)t.push(e.userData.gisceneAttributes[attr]);return t}}.bind(this)),t},setActiveStyle:function(e){e&&("string"!=typeof e||"default"!=e.toLowerCase())||(e=this.styles[0]);e.recursive;var t=e.material,i=e.rootObjects?"byObjects":e.rootObjectKeyAttribute?"byAttributes":"selectAll";if("selectAll"==i&&this.setOverrideMaterial(this.root,t),"byObjects"==i)for(var n=e.rootObjects,r=0,o=n.length;r<o;r++)this.setOverrideMaterial(n[r],t);"byAttributes"==i&&console.log("Layer.setActiveStyle(): style objects by attributes not yet implemented"),this.dispatchEvent({type:"setActiveStyle",content:{layer:this,style:e}})},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Layer.Helper=function(e,t){GIScene.Layer.apply(this,[e,t]),this.isTangible=!1},GIScene.Layer.Helper.prototype=Object.create(GIScene.Layer.prototype),GIScene.Layer.Fixed=function(i,e){GIScene.Layer.apply(this,[i]),this.config=GIScene.Utils.mergeObjects(this.config,e),this.url=null,this.format=null,this.boundingBox=null,this.verticalAxis=null,this.listeners=null;var n=function(e){e=e.content;"Z"==this.verticalAxis.toUpperCase()&&e.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),this.setOverrideMaterial(e,this.config.overrideMaterial),this.root.add(e),this.boundingBox=(new THREE.Box3).setFromObject(this.root),this.selectControl&&(this.selectControl.selectables=this.root.getDescendants()),this.dispatchEvent({type:"load",content:this})}.bind(this);this.init=function(){if(this.name=i,this.config.url&&"format"in this.config){this.url=this.config.url,this.format=this.config.format,this.verticalAxis=this.config.verticalAxis||"Y",this.boundingBox=new THREE.Box3,this.listeners=this.config.listeners;for(var e=0,t=this.listeners.length;e<t;e++)for(type in this.listeners[e])this.addEventListener(type,this.listeners[e][type]);this.loader.addEventListener("load",n),this.loader.load(this.url,this.format)}else console.error("url or format missing in layer config!")},this.init()},GIScene.Layer.Fixed.prototype=Object.create(GIScene.Layer.prototype),GIScene.Grid=function(e){var t={origin:new GIScene.Coordinate2(0,0),tileSizes:[16],sceneOffset:new GIScene.Coordinate3};this.config=GIScene.Utils.mergeObjects(t,e||{}),this.origin=this.config.origin,this.tileSizes=this.config.tileSizes,this.sceneOffset=this.config.sceneOffset,this._sceneOffset=this.sceneOffset.toVector3(),this._origin=this.origin.toVector2().clone().sub(GIScene.Utils.vector3ToVector2(this._sceneOffset))},GIScene.Grid.Index=function(e,t,i){this.x=e,this.y=t,this.tileSize=i},GIScene.Grid.Index.prototype={equals:function(e){return this.x==e.x&&this.y==e.y&&this.tileSize==e.tileSize},toString:function(){return this.x+"_"+this.y+"_"+this.tileSize},fromString:function(e){e=e.split("_");return this.x=e[0],this.y=e[1],this.tileSize=e[2],this},getChildNW:function(){var e=2*this.x,t=2*this.y+1;return new GIScene.Grid.Index(e,t,.5*this.tileSize)},getChildSW:function(){var e=2*this.x,t=2*this.y;return new GIScene.Grid.Index(e,t,.5*this.tileSize)},getChildNE:function(){var e=2*this.x+1,t=2*this.y+1;return new GIScene.Grid.Index(e,t,.5*this.tileSize)},getChildSE:function(){var e=2*this.x+1,t=2*this.y;return new GIScene.Grid.Index(e,t,.5*this.tileSize)}},GIScene.Grid.GridLine=function(e,t){e.tileSize!=t.tileSize&&alert("GIScene.Grid.GridLine(): start and end tiles have different tileSizes. They must have equal ones!"),this.start=e,this.end=t},GIScene.Grid.IndexStore=function(){this.store=[],this.add=function(e){(e=e instanceof Array?e:[e]).forEach(function(e,t,i){i[t]=i[t].toString()}),this.store=this.store.concat(e)},this.remove=function(n){(n=n instanceof Array?n:[n]).forEach(function(e,t,i){i[t]=i[t].toString()});var e=this.store.length;return this.store=this.store.filter(function(e,t,i){return-1==n.indexOf(e)}),e!=this.store.length}},GIScene.Grid.TileStore=function(e){this.config=GIScene.Utils.mergeObjects({maxLength:1},e||{}),this.maxLength=this.config.maxLength,this.store={},this.indexStore=new GIScene.Grid.IndexStore;var i=this.length=0;this.add=function(e,t){this.maxLength&&this.length>this.maxLength&&this.removeOldestEntry(),e instanceof GIScene.Grid.Index?(this.store[e.toString()]={object:t,age:i++},this.indexStore.add(e),this.length++):console.log("GIScene.Grid.TileStore: First argument is not of type GIScene.Grid.Index")},this.remove=function(e){return!!this.store[e.toString()]&&(delete this.store[e.toString()].object,delete this.store[e.toString()].age,delete this.store[e.toString()],this.indexStore.remove(e),this.length--,!0)},this.getTile=function(e){e=e.toString();return e in this.store&&this.store[e].object},this.removeOldestEntry=function(){var e,t={age:Number.MAX_VALUE};for(tile in this.store)this.store[tile].age<t.age&&(t=this.store[tile],e=tile);console.log("oldestKey: "+e);var i=this.store[e].object;i.material&&!1===i.material.isShared?GIScene.Utils.disposeObject(i,!0,!0,!0,!0):GIScene.Utils.disposeObject(i,!0,!1,!1,!0),delete this.store[e].object,delete this.store[e].age,delete this.store[e],this.length--}},GIScene.Grid.prototype={constructor:GIScene.Grid,getIndexFromPoint2d:function(e,t){return new GIScene.Grid.Index(Math.floor(e.x/t)-Math.floor(this._origin.x/t),-(Math.ceil(e.y/t)-Math.floor(this._origin.y/t)),t)},getGridCoordFromPoint2d:function(e,t){return new THREE.Vector2(e.x/t-this._origin.x/t-.5,-(e.y/t-this._origin.y/t)-.5)},getCentroidFromIndex:function(e){var t=e.x*e.tileSize+this._origin.x+e.tileSize/2,e=-e.y*e.tileSize+this._origin.y-e.tileSize/2;return new THREE.Vector2(t,e)},getBoundingBoxFromIndex:function(e){var t=this.getCentroidFromIndex(e),e=e.tileSize/2;return{left:t.x-e,right:t.x+e,top:t.y-e,bottom:t.y+e}},getCornerCoordsFromIndex:function(e){e=this.getBoundingBoxFromIndex(e);return[{x:e.left,y:e.bottom},{x:e.right,y:e.bottom},{x:e.right,y:e.top},{x:e.left,y:e.top}]},isDescendantOf:function(e,t){if(!e||!t)return!1;var i=2*(this.tileSizes.indexOf(e.tileSize)-this.tileSizes.indexOf(t.tileSize)),n=Math.floor(e.x/i),i=Math.floor(e.y/i);return n==t.x&&i==t.y},traverseIf_old:function(e,t,i){t(e)&&(e.tileSize<=this.tileSizes[0]?i(e):(this.traverseIf(e.getChildNW(),t,i),this.traverseIf(e.getChildNE(),t,i),this.traverseIf(e.getChildSW(),t,i),this.traverseIf(e.getChildSE(),t,i)))},traverseIf:function(e,t,i,n){t(e)&&(i(e)?n(e):(this.traverseIf(e.getChildNW(),t,i,n),this.traverseIf(e.getChildNE(),t,i,n),this.traverseIf(e.getChildSW(),t,i,n),this.traverseIf(e.getChildSE(),t,i,n)))},getTilesFromGridLine:function(e){for(var t=e.start.tileSize,i=[],n=e.start.x,r=e.start.y,o=e.end.x,e=e.end.y,a=Math.abs(o-n),s=Math.abs(e-r),c=n<o?1:-1,l=r<e?1:-1,h=0,d=0;d<a+s;d++){i.push(new GIScene.Grid.Index(n,r,t));var u=h+s,m=h-a;h=Math.abs(u)<Math.abs(m)?(n+=c,u):(r+=l,m)}for(h=0,d=0;d<a+s;d++){i.push(new GIScene.Grid.Index(n,r,t));u=h+s,m=h-a;h=Math.abs(u)<Math.abs(m)?(n+=-c,u):(r+=-l,m)}return a+s==0&&i.push(new GIScene.Grid.Index(n,r,t)),i},getTilesFromLineIntersection:function(e,t,i){var n,r,o=[],a=e.toVector2().clone().sub(GIScene.Utils.vector3ToVector2(this._sceneOffset)),s=t.toVector2().clone().sub(GIScene.Utils.vector3ToVector2(this._sceneOffset)),c=this.getGridCoordFromPoint2d(a,i),e=this.getGridCoordFromPoint2d(s,i),l=c.x,h=c.y,t=e.x,a=e.y,s=t-l,c=a-h,e=c/s,c=0==c,s=0==s,d=l<t?1:-1,u=h<a?1:-1,m=e*d,f=1/e*u,p=Math.abs(Math.round(t)-Math.round(l)),v=Math.abs(Math.round(a)-Math.round(h)),g=Math.round(l),E=Math.round(h),y=l-1/e*(h-E),S=h-(l-g)*e,b=Math.round(t),T=Math.round(a);if(Math.abs(e)<=1&&!c){for(var w=0;w<p;w++){n=g+w*d,r=S+w*m;var R=Math.round(n),M=0!=w?Math.round(r):E;o.push(new GIScene.Grid.Index(R,M,i));var I,L=Math.round(S+(w+1)*m)-M;w==p-1&&(L=T-M),0!=L&&(I=S+m*(w+.5),x=Math.round(I)==M,C=Math.floor(Math.abs(I)%1*1e4)/1e4==.5,(x||C)&&o.push(new GIScene.Grid.Index(R+d,M,i)),x&&!C||o.push(new GIScene.Grid.Index(R,M+u,i)),1<Math.abs(L)&&o.push(new GIScene.Grid.Index(R+d,M+u,i)))}o.push(new GIScene.Grid.Index(Math.round(t),Math.round(a),i))}if(1<Math.abs(e)&&!s){for(w=0;w<v;w++){r=E+w*u,n=y+w*f;M=Math.round(r),R=0!=w?Math.round(n):g;o.push(new GIScene.Grid.Index(R,M,i));var A,x,C,L=Math.round(y+(w+1)*f)-R;w==v-1&&(L=b-R),0!=L&&(A=y+f*(w+.5),x=Math.round(A)==R,C=Math.floor(Math.abs(A)%1*1e4)/1e4==.5,x&&!C||o.push(new GIScene.Grid.Index(R+d,M,i)),(x||C)&&o.push(new GIScene.Grid.Index(R,M+u,i)),1<Math.abs(L)&&o.push(new GIScene.Grid.Index(R+d,M+u,i)))}o.push(new GIScene.Grid.Index(b,T,i))}if(s)for(w=0;w<=v;w++)o.push(new GIScene.Grid.Index(g,E+w,i)),Math.floor(Math.abs(l)%1*1e4)/1e4==.5&&o.push(new GIScene.Grid.Index(g-1,E+w,i));if(c)for(w=0;w<=p;w++)o.push(new GIScene.Grid.Index(g+w,E,i)),Math.floor(Math.abs(h)%1*1e4)/1e4==.5&&o.push(new GIScene.Grid.Index(g+w,E-1,i));return o},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent},GIScene.Layer.Grid=function(e,t){GIScene.Layer.apply(this,[e,t]);t={origin:new GIScene.Coordinate2(0,0),tileSizes:[1024],terrainHeight:71,maxNumTiles:25,maxDistance:1e4,computeTileIndicesHandler:"default",service:null,maxExtent:null,lodDistanceFactor:1,overrideMaterialHandler:null,virtualSelectionAccessor:null};this.config=GIScene.Utils.mergeObjects(t,this.config),this.url=null,this.format=null,this.boundingBox=null,this.verticalAxis=null,this.origin=this.config.origin,this.tileSizes=this.config.tileSizes.sort(function(e,t){return t-e}),this.grid=null,this.terrainHeight=this.config.terrainHeight;var v=null;this.maxNumTiles=this.config.maxNumTiles,this.maxDistance=this.config.maxDistance,this.maxExtent=this.config.maxExtent;var g=null;this.lodDistanceFactor=this.config.lodDistanceFactor,this.distanceReferencePoint=null,this.computeTileIndicesHandler=null,this.overrideMaterialHandler=null,this.virtualSelection=[],this.virtualSelectionAccessor=this.config.virtualSelectionAccessor;var i,n=!1;this.load=[],this.remove=[],this.loading=new GIScene.Grid.TileStore,this.loaded=new GIScene.Grid.TileStore,this.cache=new GIScene.Grid.TileStore({maxLength:200}),this.init=function(){this.name=e,this.url=this.config.url,this.format=this.config.format,this.verticalAxis=this.config.verticalAxis||"Y",this.boundingBox=new THREE.Box3,this.setTerrainHeight(this.terrainHeight),this.setMaxExtent(this.maxExtent),this.setComputeTileIndicesHandler(this.config.computeTileIndicesHandler)};var r=function(){n&&(n=!1,this.update(),n=!0)}.bind(this);this.startUpdate=function(){n=!0,i=window.setInterval(r,500),console.log("Layer.Grid():startUpdate()")},this.stopUpdate=function(){window.clearInterval(i),n=!1},this.setComputeTileIndicesHandler=function(e){this.computeTileIndicesHandler="default"==e?this.getNewTilesFromQuadtree:e};var o=new THREE.MeshBasicMaterial({color:5635925,opacity:.5,wireframe:!1});this.getErrorTile=function(e){var t=new THREE.Mesh(new THREE.CubeGeometry(e.tileSize,4,e.tileSize),o);t.name="errorTile_"+e.toString();e=this.grid.getCentroidFromIndex(e);return t.position.set(e.x,this.terrainHeight-this.offset.z,e.y),t},this.loadTile=function(i,e,t){var n,r,o,a,s;i&&((s=this.cache.getTile(i))?(n=null,s.traverse(function(e){n||e.material&&(n=e.material)}),a=!1,n&&n.waitForTexture&&(a=n.unsharedWmsTextureLoaded),!a&&n&&n.waitForTexture||(this.root.add(s),this.cache.remove(i),this.loaded.add(i,s),this.selectControl&&(this.selectControl.selectables=this.root.getDescendants()),this.dispatchEvent({type:"tileadd",content:{tile:s}}),this.oldTiles.push(i))):(r=function(e){var t=!1;e instanceof THREE.Object3D||(e=this.getErrorTile(i),t=!0),"Z"!=this.verticalAxis.toUpperCase()||t||e.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),this.loading.remove(i),this.cache.add(i,e),t||this.setOverrideMaterial(e,this.config.overrideMaterial),this.dispatchEvent({type:"tileload",content:{tile:e}})}.bind(this),o=function(e){var t=this.getErrorTile(i);this.loading.remove(i),this.cache.add(i,t)}.bind(this),!1===this.loading.getTile(i)&&(a=this.config.service.getGetSceneUrl(i,this.grid),(s=new GIScene.ModelLoader).load(a,this.format,r,null,o),this.loading.add(i,s))))},this.loadTiles=function(e,t,i){if(e)for(var n=0,r=e.length;n<r;n++)this.loadTile(e[n],t,i)},this.removeTile=function(e,t){if(e){var i=this.loading.getTile(e);if(i)return i.abort(),void this.loading.remove(e);i=this.loaded.getTile(e);i instanceof THREE.Object3D&&(this.root.remove(i),this.loaded.remove(e),this.cache.add(e,i),this.dispatchEvent({type:"tileremove",content:{tile:i}}))}},this.removeTiles=function(e,t){if(e)for(var i=0,n=e.length;i<n;i++)this.removeTile(e[i],t)},this.getNewTilesFromQuadtree=function(){function n(e,t){for(var i=!1,n=-1,r=e.length,o=r-1;++n<r;o=n)(e[n].y<=t.y&&t.y<e[o].y||e[o].y<=t.y&&t.y<e[n].y)&&t.x<(e[o].x-e[n].x)*(t.y-e[n].y)/(e[o].y-e[n].y)+e[n].x&&(i=!i);return i}var e=function(e){var t={n_t_l:new THREE.Vector3(-1,1,-1),n_t_r:new THREE.Vector3(1,1,-1),n_b_r:new THREE.Vector3(1,-1,-1),n_b_l:new THREE.Vector3(-1,-1,-1),f_t_r:new THREE.Vector3(1,1,1),f_t_l:new THREE.Vector3(-1,1,1),f_b_l:new THREE.Vector3(-1,-1,1),f_b_r:new THREE.Vector3(1,-1,1)},i={n_t:{geometry:new THREE.Line3(t.n_t_r,t.n_t_l)},n_r:{geometry:new THREE.Line3(t.n_b_r,t.n_t_r)},n_b:{geometry:new THREE.Line3(t.n_b_l,t.n_b_r)},n_l:{geometry:new THREE.Line3(t.n_t_l,t.n_b_l)},f_t:{geometry:new THREE.Line3(t.f_t_l,t.f_t_r)},f_r:{geometry:new THREE.Line3(t.f_t_r,t.f_b_r)},f_b:{geometry:new THREE.Line3(t.f_b_r,t.f_b_l)},f_l:{geometry:new THREE.Line3(t.f_b_l,t.f_t_l)},t_l:{geometry:new THREE.Line3(t.n_t_l,t.f_t_l)},b_l:{geometry:new THREE.Line3(t.n_b_l,t.f_b_l)},b_r:{geometry:new THREE.Line3(t.n_b_r,t.f_b_r)},t_r:{geometry:new THREE.Line3(t.n_t_r,t.f_t_r)}},n={near:[i.n_l,i.n_t,i.n_r,i.n_b],far:[i.f_r,i.f_b,i.f_l,i.f_t],left:[i.n_l,i.t_l,i.f_l,i.b_l],top:[i.n_t,i.t_r,i.f_t,i.t_l],right:[i.n_r,i.b_r,i.f_r,i.t_r],bottom:[i.n_b,i.b_l,i.f_b,i.b_r]};i.n_t.left=n.near,i.n_t.right=n.top,i.n_r.left=n.near,i.n_r.right=n.right,i.n_b.left=n.near,i.n_b.right=n.bottom,i.n_l.left=n.near,i.n_l.right=n.left,i.f_t.left=n.far,i.f_t.right=n.top,i.f_r.left=n.far,i.f_r.right=n.right,i.f_b.left=n.far,i.f_b.right=n.bottom,i.f_l.left=n.far,i.f_l.right=n.left,i.t_l.left=n.left,i.t_l.right=n.top,i.b_l.left=n.bottom,i.b_l.right=n.left,i.b_r.left=n.right,i.b_r.right=n.bottom,i.t_r.left=n.top,i.t_r.right=n.right;var r=new THREE.Projector;for(point in t)r.unprojectVector(t[point],this.scene.camera);var o,a,s=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),new THREE.Vector3(0,e,0)),c=[],l=function(e,t){for(var i,n=0;n<4;n++)e[n]===t||(i=s.intersectLine(e[n].geometry))&&(c.push(i),c[0].equals(c[c.length-1])||(i=e[n].left===e?e[n].right:e[n].left,l(i,e[n])))};!function(){for(cell in n)for(var e=0;e<4;e++){var t=s.intersectLine(n[cell][e].geometry);if(t)return c.push(t),o=n[cell],a=n[cell][e]}}(),o&&l(o,a);for(var h=0,d=c.length;h<d;h++)c[h]=GIScene.Utils.vector3ToVector2(c[h]);return c}.bind(this),t=function(e,t){var i=function(e,t){function i(e){return(o[0]-a[0])*(e[1]-a[1])>(o[1]-a[1])*(e[0]-a[0])}function n(){var e=[a[0]-o[0],a[1]-o[1]],t=[d[0]-l[0],d[1]-l[1]],i=a[0]*o[1]-a[1]*o[0],n=d[0]*l[1]-d[1]*l[0],r=1/(e[0]*t[1]-e[1]*t[0]);return[(i*t[0]-n*e[0])*r,(i*t[1]-n*e[1])*r]}for(var o,r=e,a=t[t.length-1],s=0,c=t.length;s<c;s++){o=t[s];for(var l,h=r,r=[],d=h[h.length-1],u=0,m=h.length;u<m;u++)i(l=h[u])?(i(d)||r.push(n()),r.push(l)):i(d)&&r.push(n()),d=l;a=o}return r}.bind(this),n=g?g.toPolygonV2():null;n&&(n.forEach(function(e,t,i){i[t]=e.toVector2().toArray()}),n.reverse());var r,t=function(e,t){for(var i,n,r=Math.PI*(1/24-.5),o=[],a=0;a<24;++a)n=r+2*a*Math.PI/24,i=e.x+t*Math.cos(n),n=e.y+t*Math.sin(n),o.push([i,n]);return o}(this.distanceReferencePoint,t);e.pop(),e.forEach(function(e,t,i){i[t]=e.toArray()}),r=e,0<function(){for(var e=0,t=0;t<r.length;t++)p=(t+1)%r.length,e+=r[t][0]*r[p][1],e-=r[p][0]*r[t][1];return e/2}()||e.reverse();e=i(t,e);return n&&(clippedWithExtent=i(n,e),e=clippedWithExtent),0<e.length&&(e.push(e[0]),e.forEach(function(e,t,i){i[t]=(new THREE.Vector2).fromArray(e)})),e}.bind(this),i=function(e,t){for(var i=[],n=[],r=0,o=e.length-1;r<o;r++){var a=new GIScene.Grid.GridLine(this.grid.getIndexFromPoint2d(e[r],t),this.grid.getIndexFromPoint2d(e[r+1],t));n.push(a)}for(r=0,o=n.length;r<o;r++)i=i.concat(this.grid.getTilesFromGridLine(n[r]));return GIScene.Utils.removeDuplicatesFromArray(i)}.bind(this),r=(function(e){ySortedOutlineTiles={};for(var t=0,i=e.length;t<i;t++)e[t].y.toString()in ySortedOutlineTiles?ySortedOutlineTiles[e[t].y.toString()].push(e[t].x):ySortedOutlineTiles[e[t].y.toString()]=[e[t].x];var n=[];for(scanline in ySortedOutlineTiles){var r=ySortedOutlineTiles[scanline].sort(function(e,t){return e-t});if(1<r.length){for(var o=parseInt(scanline),a=0,s=0,t=1,i=r.length;t<i;t++)r[t]-r[t-1]!=1&&(a=r[t]-r[t-1]-1,s=t-1);for(t=0,i=a;t<i;t++)n.push(new GIScene.Grid.Index(r[s]+t+1,o,this.grid.tileSize))}}return n}.bind(this),function(e,t){function i(e,t,i,n,r,o,a,s){if(e==i&&t==n||r==a&&o==s)return!1;var c=i-e,l=n-t,h=r-a,d=o-s,u=e-r,m=t-o,f=d*u-h*m,d=l*h-c*d;if(0<d){if(f<0||d<f)return!1}else if(d<0&&(0<f||f<d))return!1;u=c*m-l*u;if(0<d){if(u<0||d<u)return!1}else if(d<0&&(0<u||u<d))return!1;return 0!=d||0==e*(n-o)+i*(o-t)+r*(t-n)&&(r<=e&&e<=a||e<=r&&a<=e||r<=i&&i<=a||i<=r&&a<=i||e<=r&&r<=i||r<=e&&i<=r)&&(o<=t&&t<=s||t<=o&&s<=t||o<=n&&n<=s||n<=o&&s<=n||t<=o&&o<=n||o<=t&&n<=o)}for(var n=this.grid.getCornerCoordsFromIndex(e),r=0,o=t.length-1;r<o;r++)if(i(n[0].x,n[0].y,n[1].x,n[1].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y)||i(n[1].x,n[1].y,n[2].x,n[2].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y)||i(n[2].x,n[2].y,n[3].x,n[3].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y)||i(n[3].x,n[3].y,n[0].x,n[0].y,t[r].x,t[r].y,t[r+1].x,t[r+1].y))return!0;return!1}.bind(this)),o=new THREE.Vector3,a=(function(e,t){var i=this.scene.camera.position.clone(),e=this.grid.getCentroidFromIndex(e);o.set(e.x,this.terrainHeight,e.y);e=i.distanceTo(o),t=this.grid.getCentroidFromIndex(t);return o.set(t.x,this.terrainHeight,t.y),e-i.distanceTo(o)}.bind(this),function(){var e=new THREE.Vector3(0,-1,1),t=new THREE.Vector3(0,-1,-1),i=new THREE.Vector3(0,1,1),n=new THREE.Vector3(0,1,-1),r=new THREE.Projector,t=(r.unprojectVector(e,this.scene.camera),r.unprojectVector(t,this.scene.camera),r.unprojectVector(i,this.scene.camera),r.unprojectVector(n,this.scene.camera),new THREE.Line3(e,t)),i=new THREE.Line3(i,n),n=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),new THREE.Vector3(0,v,0)),t=n.intersectLine(t),i=n.intersectLine(i),i=t||i;return i?new THREE.Vector2(i.x,i.z):null}.bind(this)),s=function(e,t){if(e.length<4)return e;var i,n;i=(new GIScene.Line2).fromPoints(e[0],e[1]).directionVector,n=(new GIScene.Line2).fromPoints(e[1],e[2]).directionVector,i=new THREE.Vector3(i.x,i.y,0),n=new THREE.Vector3(n.x,n.y,0),THREE.Vector3.prototype.crossVectors(i,n).z<0||e.reverse();var r=[];r.push((new GIScene.Line2).fromPoints(e[e.length-2],e[e.length-1]).moveRight(t).intersect((new GIScene.Line2).fromPoints(e[0],e[1]).moveRight(t)));for(var o=0;o<e.length-2;o++)r.push((new GIScene.Line2).fromPoints(e[o],e[o+1]).moveRight(t).intersect((new GIScene.Line2).fromPoints(e[o+1],e[o+2]).moveRight(t)));return r.push(new THREE.Vector2(r[0].x,r[0].y)),r}(s=e(v),this.tileSizes[this.tileSizes.length-1]),c=this.distanceReferencePoint;if(this.distanceReferencePoint=a()||c,!this.distanceReferencePoint)return[];s=t(s,this.maxDistance);var l,e=Math.min.apply(null,this.tileSizes),a=Math.max.apply(null,this.tileSizes),c=function(e){var t=0;if(2<e.length){for(var i=0,n=0,r=e.length;n<r-1;n++){var o=e[n],a=e[n+1];i+=(o.x+a.x)*(a.y-o.y)}t=-i/2}return Math.abs(t)}(s),t=c/Math.pow(a,2),a=Math.pow(2,Math.round(Math.log(Math.sqrt(c)/e)/Math.LN2)),c=e*a;if(1e4<t&&confirm("estNumberOfAllTiles: "+Math.round(t)+". Stop calculating?"))return[];l=i(s,1<a?c:e);for(var h=function(e){var t=this.grid.getCentroidFromIndex(e),i=this.grid.getCornerCoordsFromIndex(e);return n(s,i[0])||n(s,i[1])||n(s,i[2])||n(s,i[3])||n(s,t)||r(e,s)}.bind(this),d=function(e){var t,i=!1;return e.tileSize<=this.tileSizes[0]&&e.tileSize>this.tileSizes[this.tileSizes.length-1]?(t=this.grid.getCentroidFromIndex(e),t=new THREE.Vector3(t.x,v,t.y),this.scene.camera.position.distanceTo(t)>e.tileSize*this.lodDistanceFactor&&(i=!0)):e.tileSize==this.tileSizes[this.tileSizes.length-1]&&(i=!0),i}.bind(this),u=function(e){m.push(e)}.bind(this),m=[],f=0,p=l.length;f<p;f++)this.grid.traverseIf(l[f],h,d,u);return m};this.oldTiles=[],this.update=function(){var n=this.computeTileIndicesHandler();this.remove=this.oldTiles.filter(function(t,e,i){return!n.some(function(e){return e.equals(t)})}),this.load=n.filter(function(t,e,i){return!this.oldTiles.some(function(e){return e.equals(t)})}.bind(this)),this.oldTiles=n.filter(function(t,e,i){return!this.load.some(function(e){return e.equals(t)})}.bind(this));this.load.forEach(function(n,e,t){this.remove.forEach(function(e,t,i){this.grid.isDescendantOf(n,e)&&(this.oldTiles.push(i[t]),i[t]=null)}.bind(this))}.bind(this));var e={};this.load.forEach(function(n,e,t){this.remove.forEach(function(e,t,i){this.grid.isDescendantOf(e,n)&&(this.oldTiles.push(i[t]),i[t]=null)}.bind(this))}.bind(this)),this.loadTiles(this.load,e,{}),this.removeTiles(this.remove,e),this.abort=this.loading.indexStore.store.filter(function(t,e,i){return!this.load.some(function(e){return e.equals((new GIScene.Grid.Index).fromString(t))})}.bind(this)),this.removeTiles(this.abort,e)},this.setTerrainHeight=function(e){this.terrainHeight=e,v=this.scene?this.terrainHeight-this.scene.config.offset.z:this.terrainHeight},this.setMaxExtent=function(e){var t,i;e&&(g=this.scene?(i=new GIScene.Coordinate2(this.scene.config.offset.x,this.scene.config.offset.y),t=e.min.clone().sub(i),i=e.max.clone().sub(i),new GIScene.Extent2(new GIScene.Coordinate2(t.x,t.y),new GIScene.Coordinate2(i.x,i.y))):this.maxExtent)},this.setVisibility=function(e){e?this.startUpdate():this.stopUpdate(),GIScene.Layer.Grid.prototype.setVisibility.call(this,e)},this.init();t=function(e){console.log("Grid.onSetScene "+this.name);e=e.content;this.grid=e?new GIScene.Grid({origin:this.origin,tileSizes:this.tileSizes,sceneOffset:e.config.offset}):null,this.setTerrainHeight(this.terrainHeight),this.setMaxExtent(this.maxExtent),e?this.startUpdate():this.stopUpdate()}.bind(this);this.addEventListener("setScene",t),this.config.overrideMaterialHandler&&this.setOverrideMaterialHandler(this.config.overrideMaterialHandler),this.attributeReader&&((a=function(e){(e?e.content.tile:this.root).traverse(function(e){for(attr in"gisceneAttributes"in e.userData||(e.userData.gisceneAttributes={}),this.attributeReader)e.userData.gisceneAttributes[attr]=this.attributeReader[attr](e)}.bind(this))}.bind(this))(),this.addEventListener("tileload",a));var t=function(e){this.selectionQueryStack&&this.selectByAttributes(this.selectionQueryStack,e.content.tile)}.bind(this),a=function(e){e.content.tile.traverse(function(e){e.userData.isSelected&&this.selectControl.unselect(e)}.bind(this))}.bind(this);this.selectionQueryStack&&this.selectByAttributes(this.selectionQueryStack),this.addEventListener("tileadd",t),this.addEventListener("tileremove",a)},GIScene.Layer.Grid.prototype=Object.create(GIScene.Layer.prototype),GIScene.Layer.Grid.prototype.setOverrideMaterial=function(e,t){GIScene.Layer.prototype.setOverrideMaterial.apply(this,[e,t]);var i=this.cache.store;for(tile in i){var n=i[tile].object;GIScene.Layer.prototype.setOverrideMaterial.apply(this,[n,t])}},GIScene.Layer.Grid.prototype.setOverrideMaterialHandler=function(e){e?(this.overrideMaterialHandler&&this.removeEventListener("afterSetOverrideMaterial",this.overrideMaterialHandler),this.overrideMaterialHandler=e,this.addEventListener("afterSetOverrideMaterial",this.overrideMaterialHandler)):this.overrideMaterialHandler&&this.removeEventListener("afterSetOverrideMaterial",this.overrideMaterialHandler)},GIScene.Layer.Grid.prototype.setActiveStyle=function(e){e&&("string"!=typeof e||"default"!=e.toLowerCase())||(e=this.styles[0]);e.recursive;var t=e.material,t=(e.rootObjects||e.rootObjectKeyAttribute,t instanceof GIScene.WMSOverlayMaterial);console.log("isWMSOverlayMaterial",t),t?this.setOverrideMaterialHandler(GIScene.OverrideMaterialHandler.WMS):this.setOverrideMaterialHandler(null),GIScene.Layer.prototype.setActiveStyle.apply(this,[e])},GIScene.Layer.W3DS_0_4_0=function(e,t){GIScene.Layer.Grid.apply(this,[e,t]);this.config=GIScene.Utils.mergeObjects({layer:null,crs:null,tileSizes:[1024,512,256,128]},this.config);e={url:this.url,withCredentials:this.config.withCredentials,tileSizes:this.config.tileSizes},t={crs:this.config.crs,layer:this.config.layer,offset:null};this.config.service=new GIScene.Service.W3DS_0_4_0(e,t);t=function(e){console.log("w3ds onSetScene");e=e.content;this.config.service.params.offset=e?this.grid.sceneOffset.toArray().join(","):null}.bind(this);this.addEventListener("setScene",t)},GIScene.Layer.W3DS_0_4_0.prototype=Object.create(GIScene.Layer.Grid.prototype),GIScene.Layer.W3DS_0_4_1=function(e,t){GIScene.Layer.Grid.apply(this,[e,t]);this.config=GIScene.Utils.mergeObjects({layer:null,crs:null,tileSizes:[1024,512,256,128],lods:null},this.config);e={url:this.url,withCredentials:this.config.withCredentials,tileSizes:this.config.tileSizes},t={crs:this.config.crs,layer:this.config.layer,offset:null,lods:this.config.lods};this.config.service=new GIScene.Service.W3DS_0_4_1(e,t);t=function(e){console.log("w3ds onSetScene "+this.name);e=e.content;this.config.service.params.offset=e?this.grid.sceneOffset.toArray().join(","):null}.bind(this);this.addEventListener("setScene",t)},GIScene.Layer.W3DS_0_4_1.prototype=Object.create(GIScene.Layer.Grid.prototype),GIScene.Scene=function(e,t){var i={width:null,height:null,animate:!0,fog:null,center:new THREE.Vector3(0,0,0),projection:"EPSG:32616",units:"m",offset:new GIScene.Coordinate3(0,0,0),skyColor:(new THREE.Color).setStyle("lightskyblue").getHex(),cameratype:"perspective",near:.1,far:1e3,fov:45,positionFromCenter:new THREE.Vector3(0,0,10)};this.config=GIScene.Utils.mergeObjects(i,t||{}),this.containerDiv=document.getElementById(e);var n,c=this.canvas=null,c=this.config.width||this.containerDiv.clientWidth,l=this.config.height||(0<this.containerDiv.clientHeight?this.containerDiv.clientHeight:500);this.root=null,this.camera=null,this.spriteRoot=null,this.spriteCamera=null,this.lights=[],this.renderer=null,this.effectComposer=null,this.fog=null,this.layers=[],this.center=new THREE.Vector3(0,0,0),this.controls=[],this.clock=new THREE.Clock,this.delta=null,this.init=function(){this.initCanvas(),this.initScene(),this.config.animate?this.startAnimation():this.renderer.render(this.root,this.camera)},this.initCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.className="giscene_canvas",this.containerDiv.style.lineHeight=0,this.containerDiv.appendChild(this.canvas)},this.initScene=function(e){this.root=new THREE.Scene,this.root.name="root",this.config.fog&&(this.root.fog=this.fog=this.config.fog.clone()),this.camera=new THREE.CombinedCamera(c,l,this.config.fov,this.config.near,this.config.far,this.config.near,this.config.far),this.camera.name="THREE.CombinedCamera",this.camera.target=new THREE.Object3D,this.camera.target.name="Camera target",this.camera.add(this.camera.target),"ortho"==this.config.cameratype&&this.camera.toOrthographic();var t=new THREE.Vector3(0,0,0),i=new THREE.Vector3(0,0,0),n=function(){t.equals(this.camera.position)&&i.equals(this.camera.rotation)||(this.dispatchEvent({type:"cameraChange"}),t=this.camera.position.clone(),i=this.camera.rotation.clone())}.bind(this);this.addEventListener("afterRender",n),this.spriteRoot=new THREE.Scene;var r=c/2,n=l/2;this.spriteCamera=new THREE.OrthographicCamera(-r,r,n,-n,-100,100),this.directionalLight=new THREE.DirectionalLight(16777215,.8),this.directionalLight.name="THREE.DirectionalLight",this.ambientLight=new THREE.AmbientLight(13421772),this.ambientLight.name="THREE.AmbientLight",this.headLight=new THREE.SpotLight(16777215,.3,0,Math.PI/2,20),this.camera.add(this.headLight),this.headLight.target.position.setZ(-1e3),this.camera.target.add(this.headLight.target),this.renderer=new THREE.WebGLRenderer({antialias:!0,precision:"highp",canvas:this.canvas,devicePixelRatio:1}),this.renderer.setSize(c,l),this.renderer.setClearColor(this.config.skyColor),this.renderer.autoClear=!1,this.effectComposer=new THREE.EffectComposer(this.renderer),this.effectComposer.setSize(c,l),this.root.add(this.camera),this.root.add(this.ambientLight),this.root.add(this.directionalLight),this.setCenter(this.config.center,this.config.positionFromCenter);var o=new THREE.Texture(null),a=new Image;a.onload=function(e){o.image=a,o.needsUpdate=!0},a.src="data:image/png;base64,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";var n=new THREE.SpriteMaterial({map:o,opacity:1}),s=new THREE.Sprite(n);s.scale.set(158,20,1),s.position.set(this.canvas.width/2-79,-this.canvas.height/2+10,0),this.spriteRoot.add(s),this.logoOnResize=function(){s.position.set(this.canvas.width/2-79,-this.canvas.height/2+10,0)}.bind(this)},this.startAnimation=function(){n=requestAnimationFrame(this.startAnimation.bind(this)),this.delta=this.clock.getDelta(),TWEEN.update(),this.renderer.clear(!0,!0,!0),this.dispatchEvent({type:"beforeRender"}),this.dispatchEvent({type:"beforeRender2"}),0<this.effectComposer.passes.length?this.effectComposer.render():this.renderer.render(this.root,this.camera),this.renderer.clear(!1,!0,!1),this.renderer.render(this.spriteRoot,this.spriteCamera),this.dispatchEvent({type:"afterRender"})},this.stopAnimation=function(){cancelAnimationFrame(n)};var h=!(this.setCenter_old=function(e,t){var i=e.clone().sub(this.center);this.center=e.clone(),t?(this.camera.position=e.clone().add(t),this.camera.lookAt(this.center),this.camera.target.position.setZ(-t.length())):this.camera.position.add(i),this.dispatchEvent({type:"center",content:{center:e.clone(),translation:i,positionFromCenter:t}})}),d=null;this.setCenter=function(e,t,i){var n,r,o,a,s,c;h&&d&&(d.stop(),h=!1),h||(h=!0,i=null==i?1e3:i,n=this.center,r=e.clone(),t=t||this.camera.position.clone().sub(n),o=this.camera.position.clone(),c=e.clone().add(t),a=new THREE.Vector3,s={tx:n.x,ty:n.y,tz:n.z,cx:o.x,cy:o.y,cz:o.z},c={tx:r.x,ty:r.y,tz:r.z,cx:c.x,cy:c.y,cz:c.z},this.center=e.clone(),0==i?(this.camera.position.set(parseFloat(c.cx.toFixed(3)),parseFloat(c.cy.toFixed(3)),parseFloat(c.cz.toFixed(3))),this.camera.lookAt(a.set(parseFloat(c.tx.toFixed(3)),parseFloat(c.ty.toFixed(3)),parseFloat(c.tz.toFixed(3)))),this.camera.target.position.setZ(-t.length()),this.dispatchEvent({type:"center",content:{center:e.clone(),translation:n.clone().sub(r),positionFromCenter:t}}),h=!1):d=new TWEEN.Tween(s).to(c,i).easing(TWEEN.Easing.Quartic.Out).onUpdate(function(){this.camera.position.set(parseFloat(s.cx.toFixed(3)),parseFloat(s.cy.toFixed(3)),parseFloat(s.cz.toFixed(3))),this.camera.lookAt(a.set(parseFloat(s.tx.toFixed(3)),parseFloat(s.ty.toFixed(3)),parseFloat(s.tz.toFixed(3))))}.bind(this)).onComplete(function(){this.camera.target.position.setZ(-t.length()),this.dispatchEvent({type:"center",content:{center:e.clone(),translation:n.clone().sub(r),positionFromCenter:t}}),h=!1}.bind(this)).start())},this.viewFrom=function(e){var t=this.camera.position.clone().sub(this.center).length(),i=new THREE.Vector3(0,0,1);switch(e){case"left":i=new THREE.Vector3(-1,0,0);break;case"right":i=new THREE.Vector3(1,0,0);break;case"front":i=new THREE.Vector3(0,0,1);break;case"back":i=new THREE.Vector3(0,0,-1);break;case"top":i=new THREE.Vector3(0,1,.01);break;case"bottom":i=new THREE.Vector3(0,-1,.01);break;default:console.error('Value "'+e+'" not supported!')}this.setCenter(this.center,i.clone().multiplyScalar(t))},this.addControl=function(e){this.controls.push(e),e.setScene(this)},this.removeControl=function(e){e.deactivate();for(var t=0;t<this.controls.length;)e===this.controls[t]&&this.controls.splice(t,1),t++;e.setScene(null)},this.addLayer=function(e){this.layers.push(e),e.setScene(this),this.root.add(e.root),this.dispatchEvent({type:"addlayer",content:e})},this.removeLayer=function(e){this.dispatchEvent({type:"beforeremovelayer",content:e}),this.root.remove(e.root);for(var t=0;t<this.layers.length;)e===this.layers[t]&&this.layers.splice(t,1),t++;e.setScene(null),this.dispatchEvent({type:"removelayer",content:e})},this.disposeLayer=function(e){this.removeLayer(e);var t=e.root.getDescendants();t.push(e.root);var i=[],r=[];for(type in t.forEach(function(e){this.dispatchEvent({type:"beforeDisposeObject",content:e}),e.geometry&&(e.geometry.dispose(),delete e.geometry),e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(i,e)||i.push(e)}):GIScene.Utils.arrayContains(i,e.material)||i.push(e.material)),delete e.material,e.dispose&&e.dispose(),e=null}.bind(this)),e.styles.forEach(function(e){e.material&&(e.material instanceof THREE.MeshFaceMaterial?e.material.materials.forEach(function(e){GIScene.Utils.arrayContains(i,e)||i.push(e)}):GIScene.Utils.arrayContains(i,e.material)||i.push(e.material))}),i.forEach(function(e){for(var t=["map","lightMap","bumpMap","normalMap","specularMap","envMap","texture"],i=0,n=t.length;i<n;i++)e[t[i]]&&null!=e[t[i]]&&!GIScene.Utils.arrayContains(r,e[t[i]])&&r.push(e[t[i]])}),r.forEach(function(e){e.dispose()}),r=null,i.forEach(function(e){e.dispose()}),t=i=null,e._listeners)delete e._listeners[type];for(type in e.loader._listeners)delete e.loader._listeners[type];e=null},this.setWireframe=function(t){this.root.traverse(function(e){GIScene.Utils.WorkingMaterial.setWireframe(e,t)})},this.setTexturing=function(t){this.root.traverse(function(e){GIScene.Utils.WorkingMaterial.setTexturing(e,t)})},this.setFaceCulling=function(t){this.root.traverse(function(e){GIScene.Utils.WorkingMaterial.setFaceCulling(e,t)})},this.setVertexColors=function(t){this.root.traverse(function(e){GIScene.Utils.WorkingMaterial.setVertexColors(e,t)})},this.setShading=function(t){this.root.traverse(function(e){GIScene.Utils.WorkingMaterial.setShading(e,t)})},this.getLayerDescendants=function(e){var t=[],i=this.layers;"function"==typeof e&&(i=i.filter(e));for(var n=0,r=i.length;n<r;n++)i[n].root.getDescendants(t);return t},this.getLayerById=function(e){for(var t=0,i=this.layers.length;t<i;t++)if(this.layers[t].id.toString()===e.toString())return this.layers[t];return null};var r=!(this.sortFacesFromCamera=function(){var e=function(e,t){e=this.camera.position.distanceTo(e);return this.camera.position.distanceTo(t)-e}.bind(this),t=new THREE.Geometry;this.root.traverse(function(e){e.geometry&&e instanceof THREE.Mesh&&THREE.GeometryUtils.merge(t,e.geometry)}.bind(this)),t.faces.sort(e),mergedMat=new THREE.MeshLambertMaterial({color:13808780,ambient:9139029,emissive:0,depthTest:!1,depthWrite:!0,opacity:.5,transparent:!0}),mergedMesh=new THREE.Mesh(t,mergedMat),mergedLayer=new GIScene.Layer,mergedLayer.root.add(mergedMesh),this.disposeLayer(this.layers[0]),this.addLayer(mergedLayer)});this.toggleDebugView=function(){var e;r?(r=!1,this.camera.target.remove(this.camera.target.children[1])):(r=!0,e=new THREE.SphereGeometry(.1,8,8),e=new THREE.Mesh(e),this.camera.target.add(e),e=new THREE.SphereGeometry(.2,10,10),e=new THREE.Mesh(e),cameraLightControl.pivotLight.add(e))},this.init(),this.onResize=function(e){var t=this.containerDiv.clientWidth,i=this.containerDiv.clientHeight;this.renderer.setSize(t,i),this.effectComposer.setSize(t,i),this.camera.setSize(t,i),this.camera.updateProjectionMatrix(),this.spriteCamera.left=-t/2,this.spriteCamera.right=t/2,this.spriteCamera.top=i/2,this.spriteCamera.bottom=-i/2,this.spriteCamera.updateProjectionMatrix(),this.logoOnResize()}.bind(this),window.addEventListener("resize",this.onResize,!1),this.onUnload=function(e){this.stopAnimation();for(var t=0,i=this.controls.length;t<i;t++)void 0!==this.controls[t]&&this.controls[t].isActive&&this.controls[t].deactivate();for(t=0,i=this.layers.length;t<i;t++)this.disposeLayer(this.layers[t]);for(props in this.containerDiv.innerHTML="",this)delete this[props]}.bind(this),window.addEventListener("unload",this.onUnload,!1)},GIScene.Scene.prototype={constructor:GIScene.Scene,getObjectsBy:function(e){return GIScene.Utils.getObjectsBy(this.root,e)},addEventListener:THREE.EventDispatcher.prototype.addEventListener,hasEventListener:THREE.EventDispatcher.prototype.hasEventListener,removeEventListener:THREE.EventDispatcher.prototype.removeEventListener,dispatchEvent:THREE.EventDispatcher.prototype.dispatchEvent};
